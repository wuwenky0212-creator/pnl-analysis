# 当前损益分析系统 PRD

## 1. 项目概述

### 1.1 需求名称
当前损益分析（Current P&L Analysis）

### 1.2 需求描述
针对金融市场部（FM）投资组合的历史回顾性损益计算与分析。基于历史交易与市价，计算指定时间区间累计损益，支持多维度细分与可视化，用于绩效评估与内审。

### 1.3 适用范围
- 部门级投组及其下级
- 资产：固收、利率、汇率、商品、结构化、货币市场
- 示例品种：BOND01、SW01、FWD01、CCS01、AUSW01 等

## 2. 功能需求

### 2.1 输入配置
#### 分析方法
- 按市价分析
- 按会计分类分析

#### 时间区间
- 起始日：默认组合创建日或财年起日（可自定义，如 2023.1.1）
- 结束日：默认 Today（可指定，需 ≤ 当前日期）

#### 市场数据
历史利率曲线、汇率（如 USDCNY）、波动率、信用利差等

#### 过滤条件
- 投资组合（多选）
- 产品（多选）

### 2.2 核心输出

#### 损益指标
- 累计损益总额（单位：万元；币种：人民币/美元）
- 损益趋势（折线图）
- 百分比构成

#### 分析维度切换
1. 簿记架构
   - 层级展示
   - 支持下钻
2. 产品/资产大类
   - 固定机构目标后按大类展示
   - 支持分项下钻

### 2.3 细分维度
- 按投组：簿记层级
- 按产品/资产大类：固收、利率、汇率、商品、结构化、货币市场
- 按损益分项：见下文

#### 损益分项
1. 利息损益：票息/浮动利率净收益
   - 适用：固收/利率互换/汇率互换/商品/结构化/货币市场
2. 价差损益：买卖/交割价差（WAC 成本）
   - 适用：固收/利率期权/汇率远期/商品/货币市场
3. 估值损益：MTM 变化
   - 适用：所有品种
4. 摊销损益：溢价/折价摊销
   - 适用：固收（含权）
5. 手续费损益
6. 融资成本损益：回购/融资费用
   - 适用：债券交易/借贷

#### 计算公式
```
P&L = Capital Gain + Present Value Effect + Revenue + Amortization P&L + Financing + Fees
```

### 2.4 报告与可视化
- 表格
- 柱状图（分项）
- 饼图（来源分解）
- 导出 Excel

### 2.5 异常处理
- 数据缺失时警告并估算
- 汇总比例不足 100% 时提示占比

## 3. 技术架构

### 3.1 前端
- 交互表格/图表
- 日期区间
- 过滤面板
- 下钻
- 导出

### 3.2 后端
#### 估值模型
- 债券：DCF + WAC
- 衍生品：模型定价（如 IRS）

#### 计算流程
1. 加载历史持仓
2. 每日估值
3. 逐层聚合至部门

#### API 接口
- `/api/gold-price`（返回模拟数据）
- 增补常见查询/导出接口

### 3.3 数据
- 历史持仓与交易
- 市场数据（曲线、汇率、波动率、利差）
- 估值结果

## 4. 假设条件
- 区间为历史，结束日 ≤ 当前日期
- 债券成本：WAC

## 5. 验收标准
- 损益计算准确
- 多维度切换与下钻正常
- 可视化稳定
- 导出完整
- 缺失数据有提示

## 6. 优先级
| 功能 | 优先级 | 说明 |
|------|--------|------|
| 累计损益计算 | P0 | 核心 |
| 按市价分析 | P0 | 核心 |
| 多维度展示 | P1 | 重要 |
| 可视化图表 | P1 | 重要 |
| 按会计分类 | P2 | 后续 |
| 高级下钻 | P2 | 增强 |

## 7. 附录

### 7.1 产品代码示例
- BOND01（债券交易）
- SW01（利率互换）
- FWD01（外汇远期）
- CCS01（汇率互换）
- AUSW01（黄金掉期）

### 7.2 术语
- WAC：加权平均成本
- MTM：盯市
- DCF：折现现金流
- IRS：利率互换

