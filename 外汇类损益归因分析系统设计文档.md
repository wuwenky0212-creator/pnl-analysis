# 外汇类损益归因分析系统设计文档

## 1. 系统概述

### 1.1 系统名称
外汇类损益归因分析系统（FX P&L Attribution Analysis System）

### 1.2 设计目标
- 对外汇类产品进行历史回顾性损益归因分析
- 将总P&L分解为12个市场风险因子驱动
- 支持多维度分析、下钻和可视化
- 提供交互式界面和Excel导出功能

### 1.3 技术架构
- **前端**：HTML/CSS/JavaScript（与当前损益分析系统一致）
- **后端**：Python FastAPI
- **数据层**：模拟数据（可扩展至真实数据库）
- **部署**：独立服务或集成到现有系统

## 2. 系统架构设计

### 2.1 整体架构

```
┌─────────────────────────────────────────────────────────┐
│                     前端层 (Frontend)                     │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐      │
│  │ 输入面板    │  │ 可视化图表  │  │ 数据表格    │      │
│  └─────────────┘  └─────────────┘  └─────────────┘      │
└─────────────────────────────────────────────────────────┘
                           │ HTTP/REST
                           ▼
┌─────────────────────────────────────────────────────────┐
│                    API 层 (FastAPI)                       │
│  ┌──────────────────────────────────────────────────┐   │
│  │  /api/fx-attribution/* 路由                      │   │
│  └──────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────┘
                           │
                           ▼
┌─────────────────────────────────────────────────────────┐
│                   业务逻辑层 (Services)                    │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐  │
│  │ 归因计算服务 │  │ 因子计算服务 │  │ 聚合服务     │  │
│  └──────────────┘  └──────────────┘  └──────────────┘  │
└─────────────────────────────────────────────────────────┘
                           │
                           ▼
┌─────────────────────────────────────────────────────────┐
│                   数据层 (Data Layer)                     │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐  │
│  │ 估值数据     │  │ 头寸数据     │  │ 市场数据     │  │
│  └──────────────┘  └──────────────┘  └──────────────┘  │
└─────────────────────────────────────────────────────────┘
```

### 2.2 模块划分

#### 2.2.1 前端模块
- **fx-attribution.js**：主应用逻辑
- **fx-charts.js**：图表渲染
- **fx-export.js**：数据导出
- **fx-drilldown.js**：下钻交互

#### 2.2.2 后端模块
- **fx_attribution_service.py**：归因计算服务
- **fx_factor_calculator.py**：因子计算服务
- **fx_aggregation_service.py**：数据聚合服务
- **fx_data_provider.py**：数据提供器
- **fx_models.py**：数据模型定义

## 3. 数据模型设计

### 3.1 核心数据模型

#### 3.1.1 FXAttributionRequest（请求模型）
```python
class FXAttributionRequest(BaseModel):
    """外汇类损益归因分析请求"""
    start_date: str  # 起始日期 YYYY-MM-DD
    end_date: str    # 结束日期 YYYY-MM-DD
    portfolio_ids: List[str] = []  # 投资组合ID列表
    product_codes: List[str] = []  # 产品代码列表
    group_by: str = "portfolio"  # 分组维度: portfolio, product, currency_pair
    dimension_value: Optional[str] = None  # 下钻维度值（用于下钻查询）
```

#### 3.1.2 FXFactorDetail（因子明细）
```python
class FXFactorDetail(BaseModel):
    """外汇风险因子明细"""
    factor_name: str  # 因子名称
    factor_code: str  # 因子代码
    start_value: float = 0.0  # 起始日因子值
    end_value: float = 0.0    # 结束日因子值
    delta: float = 0.0  # 变化量
    pnl_contribution: float = 0.0  # 损益贡献
```

#### 3.1.3 FXAttributionDetail（归因明细）
```python
class FXAttributionDetail(BaseModel):
    """外汇损益归因明细"""
    dimension_value: str  # 维度值（组合/产品/货币对）
    valuation_pnl: float = 0.0  # 估值损益
    factors: List[FXFactorDetail] = []  # 因子明细列表
    unexplained: float = 0.0  # 无法解释部分
    start_date_factors: Optional[Dict[str, float]] = None  # 起始日因子数据
    end_date_factors: Optional[Dict[str, float]] = None   # 结束日因子数据
```

#### 3.1.4 FXAttributionResponse（响应模型）
```python
class FXAttributionResponse(BaseModel):
    """外汇类损益归因分析响应"""
    total_valuation_pnl: float  # 累计估值损益
    currency: str = "CNY"  # 币种
    unit: str = "万元"  # 单位
    details: List[FXAttributionDetail]  # 归因明细列表
    trend_data: List[PnLTrendPoint]  # 趋势数据
    warnings: List[DataWarning] = []  # 数据警告
```

### 3.2 因子定义

```python
# 因子代码映射
FX_FACTORS = {
    "delta": "Delta损益",
    "vega": "Vega损益",
    "gamma": "Gamma损益",
    "theta": "Theta损益",
    "rho": "Rho损益",
    "vanna": "Vanna损益",
    "charm": "Charm损益",
    "veta": "Veta损益",
    "vomma": "Vomma损益",
    "speed": "Speed损益",
    "theta_decay": "ThetaDecay损益",
    "unexplained": "无法解释部分"
}
```

## 4. API接口设计

### 4.1 接口列表

#### 4.1.1 获取外汇产品列表
```
GET /api/fx-attribution/products
```
**响应**：
```json
{
    "products": [
        {
            "code": "FWD01",
            "name": "外汇远期",
            "category": "forward"
        },
        {
            "code": "FXSW01",
            "name": "外汇掉期",
            "category": "swap"
        }
    ]
}
```

#### 4.1.2 计算归因分析
```
POST /api/fx-attribution/calculate
```
**请求体**：
```json
{
    "start_date": "2023-01-01",
    "end_date": "2024-11-04",
    "portfolio_ids": ["HFZBFBFCA001"],
    "product_codes": ["FWD01", "FXSW01"],
    "group_by": "portfolio"
}
```

**响应**：
```json
{
    "total_valuation_pnl": -50.0,
    "currency": "CNY",
    "unit": "万元",
    "details": [
        {
            "dimension_value": "HFZBFBFCA001",
            "valuation_pnl": -50.0,
            "factors": [
                {
                    "factor_name": "Delta损益",
                    "factor_code": "delta",
                    "start_value": 0.5,
                    "end_value": 0.3,
                    "delta": -0.2,
                    "pnl_contribution": -30.0
                }
            ],
            "unexplained": -5.0
        }
    ],
    "trend_data": [...],
    "warnings": []
}
```

#### 4.1.3 获取趋势数据
```
GET /api/fx-attribution/trend?start_date=2023-01-01&end_date=2024-11-04&portfolio_ids=...
```
**响应**：与当前损益分析系统的趋势接口格式一致

#### 4.1.4 下钻查询
```
POST /api/fx-attribution/drilldown
```
**请求体**：
```json
{
    "start_date": "2023-01-01",
    "end_date": "2024-11-04",
    "dimension_type": "portfolio",
    "dimension_value": "HFZBFBFCA001",
    "drill_type": "start_date"  // 或 "end_date"
}
```
**响应**：返回指定日期的因子数据

#### 4.1.5 导出Excel
```
GET /api/fx-attribution/export?start_date=...&end_date=...&...
```
**响应**：Excel文件流

### 4.2 接口路由结构

```python
# backend/api/fx_routes.py
router = APIRouter(prefix="/fx-attribution", tags=["外汇类损益归因"])

@router.get("/products")
@router.post("/calculate")
@router.get("/trend")
@router.post("/drilldown")
@router.get("/export")
```

## 5. 计算逻辑设计

### 5.1 估值损益计算

```python
def calculate_valuation_pnl(
    start_positions: List[Dict],
    end_positions: List[Dict],
    start_date: str,
    end_date: str
) -> float:
    """
    计算估值损益：期末MTM - 期初MTM
    """
    start_mtm = sum(pos.get("start_valuation", 0) for pos in start_positions)
    end_mtm = sum(pos.get("end_valuation", 0) for pos in end_positions)
    return end_mtm - start_mtm
```

### 5.2 因子计算逻辑

#### 5.2.1 Delta损益
```python
def calculate_delta_pnl(
    positions: List[Dict],
    start_date: str,
    end_date: str,
    market_data: Dict
) -> float:
    """
    Delta损益 = Delta × Δ汇率
    """
    total = 0.0
    for pos in positions:
        delta = pos.get("delta", 0.0)
        start_rate = market_data.get_rate(start_date, pos["currency_pair"])
        end_rate = market_data.get_rate(end_date, pos["currency_pair"])
        delta_rate = end_rate - start_rate
        total += delta * delta_rate * pos.get("notional", 0)
    return total
```

#### 5.2.2 Vega损益
```python
def calculate_vega_pnl(
    positions: List[Dict],
    start_date: str,
    end_date: str,
    market_data: Dict
) -> float:
    """
    Vega损益 = Vega × Δ波动率
    适用于：外汇掉期（FXSW01）
    """
    total = 0.0
    for pos in positions:
        if pos.get("product_code") in ["FXSW01", "FXSW02"]:
            vega = pos.get("vega", 0.0)
            start_vol = market_data.get_volatility(start_date, pos["currency_pair"])
            end_vol = market_data.get_volatility(end_date, pos["currency_pair"])
            delta_vol = end_vol - start_vol
            total += vega * delta_vol * pos.get("notional", 0)
    return total
```

#### 5.2.3 其他因子计算
类似的方式实现Gamma、Theta、Rho、Vanna、Charm、Veta、Vomma、Speed、ThetaDecay等因子。

### 5.3 交易处理逻辑

```python
def process_trades(
    trades: List[Dict],
    start_date: str,
    end_date: str
) -> Dict:
    """
    处理区间内的交易
    - 未到期交易：计入估值损益
    - 已到期交易：计入价差损益
    """
    valuation_positions = []
    price_diff_pnl = 0.0
    
    for trade in trades:
        trade_date = trade["trade_date"]
        maturity_date = trade["maturity_date"]
        
        if trade_date <= end_date:
            if maturity_date > end_date:
                # 未到期，计入估值损益
                valuation_positions.append(trade)
            else:
                # 已到期，计入价差损益
                if trade_date >= start_date:
                    # 新发生的已到期交易
                    price_diff_pnl += trade.get("price_diff", 0)
                else:
                    # 区间已到期的交易：期初估值 × (-1)
                    price_diff_pnl -= trade.get("start_valuation", 0)
    
    return {
        "valuation_positions": valuation_positions,
        "price_diff_pnl": price_diff_pnl
    }
```

### 5.4 数据校验

```python
def validate_attribution(
    valuation_pnl: float,
    factors: List[FXFactorDetail]
) -> Dict:
    """
    校验因子贡献总和是否等于估值损益
    """
    total_factor_pnl = sum(f.pnl_contribution for f in factors)
    unexplained = valuation_pnl - total_factor_pnl
    tolerance = 0.01  # 允许的误差范围
    
    if abs(unexplained) > tolerance:
        warnings.append(DataWarning(
            type="attribution_validation",
            date=end_date,
            product=None,
            suggested_action=f"因子贡献总和与估值损益差异较大: {unexplained:.2f}万元"
        ))
    
    return {
        "is_valid": abs(unexplained) <= tolerance,
        "unexplained": unexplained,
        "warnings": warnings
    }
```

## 6. 前端界面设计

### 6.1 页面结构

```
外汇类损益归因分析界面
├── 配置面板
│   ├── 日期区间选择
│   ├── 投资组合多选
│   ├── 产品多选（外汇类产品）
│   └── 维度切换（簿记架构/产品/货币对）
├── 核心指标卡片
│   ├── 累计估值损益
│   └── 趋势切换按钮
├── 图表区域
│   ├── 估值损益趋势图（折线图）
│   ├── 分项贡献柱状图
│   └── 来源分解饼图
├── 归因明细表格
│   ├── 维度列
│   ├── 估值损益列
│   ├── 12个因子列
│   ├── 无法解释部分列
│   └── 下钻操作列
└── 下钻弹窗
    ├── 起始日因子数据
    └── 结束日因子数据
```

### 6.2 交互功能

#### 6.2.1 维度切换
- 下拉选择：簿记架构 / 产品 / 货币对
- 切换后自动刷新数据

#### 6.2.2 下钻功能
- 点击表格行的"下钻"按钮
- 弹出模态框显示起始日/结束日因子数据
- 支持查看各因子的详细数值

#### 6.2.3 图表交互
- 趋势图支持时间范围筛选
- 柱状图支持点击查看详情
- 饼图支持点击扇区查看明细

### 6.3 文件结构

```
frontend/
├── index.html (已有，添加外汇界面)
├── css/
│   └── styles.css (共用样式)
└── js/
    ├── fx-attribution.js (主应用逻辑)
    ├── fx-charts.js (图表渲染)
    ├── fx-export.js (导出功能)
    └── fx-drilldown.js (下钻交互)
```

## 7. 后端服务设计

### 7.1 服务模块结构

```
backend/
├── api/
│   ├── fx_models.py (数据模型)
│   └── fx_routes.py (路由定义)
├── services/
│   ├── fx_attribution_service.py (归因计算主服务)
│   ├── fx_factor_calculator.py (因子计算服务)
│   ├── fx_aggregation_service.py (聚合服务)
│   └── fx_validation_service.py (数据校验服务)
├── data/
│   └── fx_data_provider.py (外汇数据提供器)
└── utils/
    └── fx_validators.py (外汇数据验证)
```

### 7.2 核心服务类

#### 7.2.1 FXAttributionService
```python
class FXAttributionService:
    """外汇类损益归因计算服务"""
    
    def __init__(self, data_provider):
        self.data_provider = data_provider
        self.factor_calculator = FXFactorCalculator()
        self.aggregation_service = FXAggregationService()
    
    def calculate_attribution(
        self,
        start_date: str,
        end_date: str,
        portfolio_ids: List[str],
        product_codes: List[str],
        group_by: str
    ) -> FXAttributionResponse:
        """计算归因分析"""
        # 1. 获取持仓数据
        # 2. 计算估值损益
        # 3. 计算各因子贡献
        # 4. 数据校验
        # 5. 聚合处理
        # 6. 返回结果
```

#### 7.2.2 FXFactorCalculator
```python
class FXFactorCalculator:
    """外汇风险因子计算器"""
    
    def calculate_all_factors(
        self,
        positions: List[Dict],
        start_date: str,
        end_date: str,
        market_data: Dict
    ) -> List[FXFactorDetail]:
        """计算所有因子贡献"""
        factors = []
        factors.append(self.calculate_delta(positions, start_date, end_date, market_data))
        factors.append(self.calculate_vega(positions, start_date, end_date, market_data))
        # ... 其他因子
        factors.append(self.calculate_unexplained(valuation_pnl, factors))
        return factors
```

### 7.3 数据提供器设计

```python
class FXDataProvider:
    """外汇数据提供器"""
    
    def get_fx_positions(
        self,
        start_date: str,
        end_date: str,
        portfolio_ids: List[str],
        product_codes: List[str]
    ) -> List[Dict]:
        """获取外汇类持仓数据"""
        # 包含MTM、因子值（Delta、Vega等）
    
    def get_market_data(
        self,
        currency_pair: str,
        start_date: str,
        end_date: str
    ) -> Dict:
        """获取市场数据"""
        # 汇率、波动率、利率等
    
    def get_trades(
        self,
        start_date: str,
        end_date: str,
        portfolio_ids: List[str],
        product_codes: List[str]
    ) -> List[Dict]:
        """获取交易数据"""
```

## 8. 数据库设计（可选）

### 8.1 表结构设计

#### 8.1.1 fx_positions（外汇持仓表）
```sql
CREATE TABLE fx_positions (
    id VARCHAR(50) PRIMARY KEY,
    portfolio_id VARCHAR(50),
    product_code VARCHAR(50),
    currency_pair VARCHAR(20),
    notional DECIMAL(18, 2),
    start_valuation DECIMAL(18, 2),
    end_valuation DECIMAL(18, 2),
    start_date DATE,
    end_date DATE,
    -- 因子值
    delta DECIMAL(18, 6),
    vega DECIMAL(18, 6),
    gamma DECIMAL(18, 6),
    -- ... 其他因子
    created_at TIMESTAMP,
    updated_at TIMESTAMP
);
```

#### 8.1.2 fx_market_data（市场数据表）
```sql
CREATE TABLE fx_market_data (
    id INT PRIMARY KEY AUTO_INCREMENT,
    currency_pair VARCHAR(20),
    data_date DATE,
    spot_rate DECIMAL(18, 6),
    volatility DECIMAL(18, 6),
    interest_rate DECIMAL(18, 6),
    created_at TIMESTAMP,
    INDEX idx_pair_date (currency_pair, data_date)
);
```

## 9. 技术选型

### 9.1 后端技术栈
- **Web框架**：FastAPI 0.104.1
- **ASGI服务器**：Uvicorn 0.24.0
- **数据验证**：Pydantic 2.5.0
- **数据处理**：Pandas 2.1.3, NumPy 1.26.2
- **日期处理**：python-dateutil 2.8.2

### 9.2 前端技术栈
- **图表库**：Chart.js
- **样式**：原生CSS（深色主题）
- **交互**：原生JavaScript

### 9.3 可选扩展
- **数据库**：PostgreSQL / MySQL（如需持久化）
- **缓存**：Redis（性能优化）
- **任务队列**：Celery（异步计算）

## 10. 部署方案

### 10.1 集成到现有系统
- 在现有FastAPI应用中添加外汇归因路由
- 共享数据提供器和基础设施
- 前端在现有界面中切换视图

### 10.2 独立部署
- 独立的FastAPI服务
- 独立的前端页面
- 通过API与现有系统集成

### 10.3 部署配置
```python
# backend/config.py
FX_ATTRIBUTION_CONFIG = {
    "HOST": "0.0.0.0",
    "PORT": 8002,
    "DEBUG": True,
    "DATA_FORMAT": "mock",  # 或 "database"
    "CACHE_ENABLED": False,
    "ASYNC_CALCULATION": False
}
```

## 11. 性能优化方案

### 11.1 计算优化
- **缓存机制**：缓存市场数据和持仓数据
- **并行计算**：多因子并行计算
- **增量计算**：仅计算变化部分

### 11.2 数据优化
- **索引优化**：按日期、组合、产品建立索引
- **分页加载**：大数据量分页返回
- **数据预聚合**：预先计算常用维度

### 11.3 前端优化
- **懒加载**：按需加载图表和数据
- **虚拟滚动**：大表格使用虚拟滚动
- **防抖节流**：输入框防抖、图表缩放节流

## 12. 安全设计

### 12.1 数据安全
- 输入参数验证
- SQL注入防护（如使用ORM）
- XSS防护

### 12.2 访问控制
- API认证（JWT Token）
- 权限验证
- 操作日志记录

## 13. 错误处理

### 13.1 异常类型
```python
class FXAttributionError(Exception):
    """外汇归因分析基础异常"""
    pass

class FactorCalculationError(FXAttributionError):
    """因子计算异常"""
    pass

class DataValidationError(FXAttributionError):
    """数据验证异常"""
    pass
```

### 13.2 错误处理策略
- 输入验证失败：返回400错误
- 计算错误：返回500错误，记录日志
- 数据缺失：返回警告信息

## 14. 测试设计

### 14.1 单元测试
- 因子计算逻辑测试
- 数据校验测试
- 聚合逻辑测试

### 14.2 集成测试
- API接口测试
- 端到端流程测试
- 性能测试

### 14.3 测试数据
- 模拟外汇持仓数据
- 模拟市场数据
- 边界条件测试数据

## 15. 开发计划

### 15.1 第一阶段：基础框架（1-2周）
- [ ] 数据模型定义
- [ ] API接口设计
- [ ] 基础计算逻辑
- [ ] 前端界面框架

### 15.2 第二阶段：核心功能（2-3周）
- [ ] 12个因子计算实现
- [ ] 归因分析主逻辑
- [ ] 数据聚合服务
- [ ] 前端表格和基础图表

### 15.3 第三阶段：高级功能（2-3周）
- [ ] 下钻功能
- [ ] 多维度切换
- [ ] 图表交互
- [ ] Excel导出

### 15.4 第四阶段：优化完善（1-2周）
- [ ] 性能优化
- [ ] 用户体验优化
- [ ] 测试完善
- [ ] 文档完善

## 16. 扩展性考虑

### 16.1 可扩展的因子
- 预留因子扩展接口
- 支持自定义因子计算

### 16.2 可扩展的维度
- 支持新增分析维度
- 支持维度组合查询

### 16.3 可扩展的数据源
- 支持多种数据源接入
- 统一数据接口规范

## 17. 附录

### 17.1 计算公式汇总表

| 因子 | 计算公式 | 说明 |
|------|----------|------|
| Delta损益 | Delta × Δ汇率 | 一阶汇率敏感度 |
| Vega损益 | Vega × Δ波动率 | 波动率敏感度 |
| Gamma损益 | Gamma × (Δ汇率)² | 二阶汇率敏感度 |
| Theta损益 | Theta × Δ时间 | 时间衰减 |
| Rho损益 | Rho × Δ利率 | 利率敏感度 |
| Vanna损益 | Vanna × Δ波动率 × Δ汇率 | 混合敏感度 |
| Charm损益 | Charm × Δ时间 × Δ汇率 | 时间-汇率混合 |
| Veta损益 | Veta × Δ时间 × Δ波动率 | 时间-波动率混合 |
| Vomma损益 | Vomma × (Δ波动率)² | 波动率二阶敏感度 |
| Speed损益 | Speed × (Δ汇率)³ | 汇率三阶敏感度 |
| ThetaDecay损益 | ThetaDecay × (Δ时间)² | 时间二阶衰减 |

### 17.2 数据流程图

```
用户输入 → API验证 → 数据获取 → 因子计算 → 归因分析 → 数据聚合 → 响应返回
    ↓         ↓         ↓         ↓         ↓         ↓         ↓
  界面    参数校验   持仓数据   12个因子   估值损益   维度聚合   图表数据
```

### 17.3 参考文档
- 外汇类损益归因分析需求文档.md
- 当前损益分析系统设计文档（参考）
- FastAPI官方文档
- Chart.js官方文档

---

**文档版本**：v1.0  
**创建日期**：2024年  
**最后更新**：2024年  
**设计人员**：系统架构团队

