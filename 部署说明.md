# 当前损益分析系统 - 部署说明

## 环境要求

- Python 3.9 或更高版本
- pip 包管理器
- Windows 10/11 或 Linux/macOS

## 快速部署步骤

### 1. 安装依赖

打开命令行，进入项目根目录，执行：

```bash
pip install -r requirements.txt
```

### 2. 启动服务

#### 方式一：使用批处理文件（Windows）

**启动后端：**
双击 `start_backend.bat` 或在命令行执行：
```bash
start_backend.bat
```

**启动前端：**
双击 `start_frontend.bat` 或在命令行执行：
```bash
start_frontend.bat
```

#### 方式二：手动启动

**启动后端（在项目根目录）：**
```bash
cd backend
python main.py
```

**启动前端（在项目根目录）：**
```bash
python -m http.server 8080 --directory frontend
```

### 3. 访问系统

- 前端界面：http://localhost:8080
- 后端 API：http://localhost:8000
- API 文档：http://localhost:8000/docs

## 配置说明

### 后端配置

编辑 `backend/config.py` 或创建 `.env` 文件：

```env
HOST=0.0.0.0
PORT=8000
DEBUG=True
DATA_FORMAT=mock
DEFAULT_CURRENCY=CNY
DEFAULT_UNIT=万元
```

### 前端配置

编辑 `frontend/js/api.js` 修改后端 API 地址：

```javascript
const API_BASE_URL = 'http://localhost:8000/api';
```

如果后端运行在其他端口，请相应修改。

## 使用说明

### 1. 配置分析参数

- **分析方法**：选择"按市价分析"或"按会计分类"
- **时间区间**：选择开始日期和结束日期（结束日期不能超过今天）
- **投资组合**：可多选投资组合过滤
- **产品**：可多选产品过滤
- **分组维度**：选择数据聚合方式

### 2. 执行查询

点击"查询"按钮，系统将：
- 调用后端 API 计算损益
- 获取趋势数据
- 更新图表和表格
- 显示数据状态和警告

### 3. 查看结果

- **核心指标卡片**：显示总损益、占比总量、数据状态
- **损益趋势图**：折线图展示历史趋势
- **损益分项柱状图**：各维度贡献对比
- **损益来源饼图**：来源分解
- **详细数据表格**：完整的分项明细

### 4. 导出数据

点击"导出 Excel"按钮，下载 Excel 报告（待实现完整功能）。

## 故障排查

### 问题1：后端无法启动

**错误信息：** `ModuleNotFoundError`

**解决方法：**
1. 确认已安装依赖：`pip install -r requirements.txt`
2. 检查 Python 版本：`python --version`（需 3.9+）

### 问题2：前端无法连接后端

**错误信息：** `Failed to fetch`

**解决方法：**
1. 确认后端服务已启动：访问 http://localhost:8000/health
2. 检查前端 `js/api.js` 中的 API_BASE_URL
3. 检查浏览器控制台错误信息

### 问题3：图表不显示

**错误信息：** Chart.js 错误

**解决方法：**
1. 检查网络连接（Chart.js 需要 CDN）
2. 检查浏览器控制台错误
3. 刷新页面重试

### 问题4：数据为空或异常

**可能原因：**
1. 日期范围无效
2. 没有选择投资组合或产品
3. 模拟数据生成异常

**解决方法：**
1. 检查输入的日期范围
2. 至少选择一个产品
3. 查看后端日志

## 开发模式

### 修改后端代码

后端使用 `uvicorn` 的 `--reload` 模式，代码修改后自动重启。

### 修改前端代码

刷新浏览器即可看到前端修改效果。

### 添加新功能

1. **新增 API 接口**：在 `backend/api/routes.py` 添加路由
2. **新增计算逻辑**：在 `backend/services/calculation.py` 扩展
3. **新增前端界面**：在 `frontend/index.html` 添加元素
4. **新增图表**：在 `frontend/js/charts.js` 添加图表类型

## 生产环境部署

### 使用 Gunicorn（推荐）

```bash
pip install gunicorn
gunicorn -w 4 -k uvicorn.workers.UvicornWorker backend.main:app --bind 0.0.0.0:8000
```

### 使用 Nginx 反向代理

```nginx
server {
    listen 80;
    server_name your-domain.com;

    # 前端静态文件
    location / {
        root /path/to/frontend;
        try_files $uri /index.html;
    }

    # 后端 API
    location /api/ {
        proxy_pass http://127.0.0.1:8000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }
}
```

### 配置 HTTPS

使用 Let's Encrypt 或其他证书服务配置 SSL。

## 数据源切换

当前系统使用模拟数据。切换到真实数据源：

1. **数据库集成**
   - 安装数据库驱动（如 psycopg2, pymysql）
   - 修改 `backend/data/mock_data.py` 为数据库查询

2. **API 集成**
   - 在 `backend/data/mock_data.py` 调用外部 API
   - 添加认证和错误处理

## 性能优化建议

1. **缓存**：使用 Redis 缓存计算结果
2. **异步处理**：大数据量计算使用异步任务
3. **数据库索引**：为常用查询字段添加索引
4. **前端懒加载**：分页加载大量数据

## 安全建议

1. **启用 HTTPS**
2. **配置 CORS**：在生产环境限制允许的域名
3. **添加认证**：实现用户登录和权限控制
4. **输入验证**：严格校验所有用户输入
5. **日志审计**：记录重要操作日志

## 技术支持

如有问题，请：
1. 查看 `README.md` 和 `系统设计文档.md`
2. 检查后端日志和浏览器控制台
3. 联系项目维护团队









