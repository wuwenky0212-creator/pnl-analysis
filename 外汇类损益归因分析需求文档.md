# 外汇类损益归因分析需求文档

## 1. 需求概述

### 1.1 需求名称
外汇类损益归因分析（FX P&L Attribution Analysis）

### 1.2 需求描述
针对金融市场部（FM）外汇类产品，进行历史回顾性损益归因分析。将总P&L分解为驱动因素，支持多维度细分、下钻分析和可视化。该分析基于外汇类损益计算结果和市场数据，用于识别风险来源、绩效评估和内部审计。

### 1.3 适用范围
外汇类产品，包括：
- 外汇即期
- 外汇远期（FWD01、FWD02）
- 外汇掉期（FXSW01、FXSW02）
- 外汇期权
- 货币掉期的汇率部分

### 1.4 假设条件
- 分析区间为历史日期区间，结束日期 <= 当前日期
- 部门各币种资金足额，无流动性约束

### 1.5 相关模块
- 估值模块
- 头寸模块
- 损益分析模块

## 2. 输入要求

### 2.1 时间区间
- **起始日期**：默认组合创建日或财年起始（e.g., 2023.1.1），用户可自定义
- **结束日期**：默认为Today（或用户指定，但必须 <= 当前日期）

### 2.2 市场数据
- 历史市场数据：汇率曲线（e.g., USDCNY）、波动率等，至Today

### 2.3 投资组合
- 可选择投组过滤（e.g., 代客业务）

### 2.4 产品
- 可选择外汇类产品过滤，多选（外汇即期、外汇远期、外汇掉期）

## 3. 输出要求

### 3.1 核心输出
- **累计估值损益**：截至Today的外汇类估值损益（单位：万元，币种：人民币/美元等）
- **估值损益变化趋势**：支持图表可视化（e.g., 折线图），可切换显示

### 3.2 分析维度切换

#### 3.2.1 簿记架构（投资组合）层级
按照簿记架构展示归因结果

#### 3.2.2 按产品/资产大类
- 选择一个簿记架构目标，分析外汇即期/远期/掉期的归因
- 各产品层级的归因可下钻至归因分项贡献

#### 3.2.3 按货币对
- 选择一个簿记架构目标，按货币对展示归因结果
- 分析外汇即期/远期/掉期的归因

### 3.3 报告格式
- **表格化呈现**：Excel导出
- **可视化**：
  - 柱状图（分项贡献）
  - 饼图（来源分解）

## 4. 归因分项

### 4.1 定义
未到期交易的市场价值变化（期末MTM - 期初MTM），由市场风险因子驱动。

### 4.2 展示逻辑
- 先展示估值损益 (Valuation P&L) 的总值变化，再展示分项变化
- 支持下钻查看展示起始日的分项数据
- 支持下钻查看结束日的分项数据

### 4.3 交易处理规则

#### 4.3.1 区间新发生的交易
- **未到期**：计入估值损益（按照该笔交易的市场风险因子累加到汇总值）
- **已到期**：计入价差损益（不纳入估值损益的分项分析）

#### 4.3.2 区间已到期的交易
- 按照期初估值×(-1)，计入价差损益（不纳入估值损益的分项分析）

### 4.4 具体分项（市场风险因子）

| 分项 | 说明 | 计算方式 | 适用产品 |
|------|------|----------|----------|
| **Delta损益** | 对汇率变化的敏感度 | Delta × Δ汇率 | 所有外汇类产品 |
| **Vega损益** | 对波动率变化的敏感度 | Vega × Δ波动率 | 外汇掉期（FXSW01） |
| **Gamma损益** | 对汇率变化的二阶敏感度 | Gamma × (Δ汇率)² | 期权类产品 |
| **Theta损益** | 时间衰减 | Theta × Δ时间 | 期权类产品 |
| **Rho损益** | 对利率变化的敏感度 | Rho × Δ利率 | 利率相关产品 |
| **Vanna损益** | Delta对波动率的变化 | Vanna × Δ波动率 × Δ汇率 | 期权类产品 |
| **Charm损益** | Delta对时间的变化 | Charm × Δ时间 × Δ汇率 | 期权类产品 |
| **Veta损益** | Vega对时间的变化 | Veta × Δ时间 × Δ波动率 | 期权类产品 |
| **Vomma损益** | Vega对波动率的变化 | Vomma × (Δ波动率)² | 期权类产品 |
| **Speed损益** | Gamma对汇率的变化 | Speed × (Δ汇率)³ | 期权类产品 |
| **ThetaDecay损益** | Theta的衰减（二阶时间衰减） | ThetaDecay × (Δ时间)² | 期权类产品 |
| **无法解释部分** | 其他未归因的损益 | 估值损益 - 各因子贡献之和 | - |

### 4.5 校验规则
- **因子贡献总和 = 估值损益**
- 示例：-50万 = Delta-30万 + Vega+5万 + … + 无法解释部分

### 4.6 数据查看
- 支持起始日/结束日因子数据查看，满足区间分析需求

## 5. 系统功能要求

### 5.1 用户界面

#### 5.1.1 输入面板
- 日期区间选择
- 投资组合过滤
- 归因参数配置

#### 5.1.2 输出仪表盘
- 交互式表格
- 交互式图表
- 支持下钻功能（e.g., 点击因子查看详情）

### 5.2 功能特性

#### 5.2.1 多维度分析
- 支持按簿记架构、产品、货币对等多维度切换
- 支持维度组合查询

#### 5.2.2 下钻分析
- 支持从汇总数据下钻到明细数据
- 支持查看起始日和结束日的因子数据
- 支持查看各分项的详细贡献

#### 5.2.3 数据可视化
- 估值损益趋势折线图
- 分项贡献柱状图
- 来源分解饼图
- 支持图表交互和筛选

#### 5.2.4 数据导出
- 支持Excel格式导出
- 包含完整的归因分析结果
- 支持自定义导出字段

## 6. 技术实现要求

### 6.1 数据源
- 估值模块：提供期初和期末MTM数据
- 头寸模块：提供持仓和交易数据
- 市场数据模块：提供汇率、波动率等市场数据

### 6.2 计算逻辑
- 估值损益计算：期末MTM - 期初MTM
- 各分项计算：按照对应的公式计算
- 数据校验：确保因子贡献总和等于估值损益

### 6.3 性能要求
- 支持大数据量计算
- 响应时间 < 3秒（常规查询）
- 支持异步计算和进度提示

## 7. 界面设计要求

### 7.1 布局要求
- 与现有"当前损益分析"界面风格一致
- 深色主题
- 横向分布布局

### 7.2 交互要求
- 支持日期范围选择
- 支持多选投资组合和产品
- 支持维度切换
- 支持图表交互（缩放、筛选等）

### 7.3 数据展示
- 核心指标卡片展示
- 表格明细展示
- 图表可视化展示
- 支持下钻交互

## 8. 测试要求

### 8.1 功能测试
- 输入参数验证
- 计算准确性验证
- 数据校验验证
- 下钻功能验证

### 8.2 性能测试
- 大数据量计算性能
- 响应时间测试
- 并发访问测试

### 8.3 兼容性测试
- 浏览器兼容性
- 数据格式兼容性

## 9. 开发计划

### 9.1 第一阶段：基础功能
- 输入面板设计
- 基础计算逻辑
- 表格展示

### 9.2 第二阶段：高级功能
- 多维度分析
- 下钻功能
- 图表可视化

### 9.3 第三阶段：优化完善
- 性能优化
- 用户体验优化
- 功能完善

## 10. 附录

### 10.1 术语表
- **MTM**：Mark-to-Market，市值估值
- **Delta**：对标的资产价格变化的敏感度
- **Vega**：对波动率变化的敏感度
- **Gamma**：对标的资产价格变化的二阶敏感度
- **Theta**：时间衰减
- **Rho**：对利率变化的敏感度

### 10.2 计算公式汇总
- Delta损益 = Delta × Δ汇率
- Vega损益 = Vega × Δ波动率
- Gamma损益 = Gamma × (Δ汇率)²
- Theta损益 = Theta × Δ时间
- Rho损益 = Rho × Δ利率
- Vanna损益 = Vanna × Δ波动率 × Δ汇率
- Charm损益 = Charm × Δ时间 × Δ汇率
- Veta损益 = Veta × Δ时间 × Δ波动率
- Vomma损益 = Vomma × (Δ波动率)²
- Speed损益 = Speed × (Δ汇率)³
- ThetaDecay损益 = ThetaDecay × (Δ时间)²

### 10.3 参考文档
- 当前损益分析需求文档
- 系统设计文档
- API接口文档

---

**文档版本**：v1.0  
**创建日期**：2024年  
**最后更新**：2024年

