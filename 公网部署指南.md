# å…¬ç½‘éƒ¨ç½²å®Œæ•´æŒ‡å—

## ğŸ“‹ ç›®å½•

1. [éƒ¨ç½²å‰å‡†å¤‡](#éƒ¨ç½²å‰å‡†å¤‡)
2. [äº‘æœåŠ¡å™¨é€‰æ‹©](#äº‘æœåŠ¡å™¨é€‰æ‹©)
3. [ç¯å¢ƒå‡†å¤‡](#ç¯å¢ƒå‡†å¤‡)
4. [é¡¹ç›®éƒ¨ç½²](#é¡¹ç›®éƒ¨ç½²)
5. [åŸŸåå’ŒSSLé…ç½®](#åŸŸåå’Œsslé…ç½®)
6. [é˜²ç«å¢™é…ç½®](#é˜²ç«å¢™é…ç½®)
7. [ç›‘æ§å’Œç»´æŠ¤](#ç›‘æ§å’Œç»´æŠ¤)
8. [å¸¸è§é—®é¢˜](#å¸¸è§é—®é¢˜)

---

## ğŸš€ éƒ¨ç½²å‰å‡†å¤‡

### 1. æ‰€éœ€èµ„æºæ¸…å•

- **äº‘æœåŠ¡å™¨**ï¼š1å°ï¼ˆå»ºè®®é…ç½®ï¼š2æ ¸4GBå†…å­˜ï¼Œ40GBç¡¬ç›˜ï¼‰
- **åŸŸå**ï¼šï¼ˆå¯é€‰ï¼Œä½†æ¨èï¼‰
- **å…¬ç½‘IP**ï¼šäº‘æœåŠ¡å™¨ä¼šè‡ªåŠ¨åˆ†é…
- **SSHå®¢æˆ·ç«¯**ï¼šç”¨äºè¿œç¨‹è¿æ¥æœåŠ¡å™¨

### 2. æ¨èäº‘æœåŠ¡å•†

- **é˜¿é‡Œäº‘**ï¼šhttps://www.aliyun.com
- **è…¾è®¯äº‘**ï¼šhttps://cloud.tencent.com
- **åä¸ºäº‘**ï¼šhttps://www.huaweicloud.com
- **AWS**ï¼šhttps://aws.amazon.com
- **Azure**ï¼šhttps://azure.microsoft.com

---

## ğŸ’» äº‘æœåŠ¡å™¨é€‰æ‹©

### æ¨èé…ç½®

| é…ç½®é¡¹ | æœ€ä½é…ç½® | æ¨èé…ç½® | è¯´æ˜ |
|--------|---------|---------|------|
| CPU | 1æ ¸ | 2æ ¸ | å¤„ç†å¹¶å‘è¯·æ±‚ |
| å†…å­˜ | 2GB | 4GB | è¿è¡ŒDockerå®¹å™¨ |
| ç¡¬ç›˜ | 20GB | 40GB | å­˜å‚¨ç³»ç»Ÿæ–‡ä»¶å’Œåº”ç”¨ |
| å¸¦å®½ | 1Mbps | 5Mbps | å…¬ç½‘è®¿é—®é€Ÿåº¦ |
| ç³»ç»Ÿ | Ubuntu 20.04/22.04 | Ubuntu 22.04 LTS | ç¨³å®šå¯é  |

### è´­ä¹°æœåŠ¡å™¨å

1. **è®°å½•æœåŠ¡å™¨ä¿¡æ¯**ï¼š
   - å…¬ç½‘IPåœ°å€
   - ç”¨æˆ·åï¼ˆé€šå¸¸æ˜¯ `root` æˆ– `ubuntu`ï¼‰
   - å¯†ç æˆ–SSHå¯†é’¥

2. **é…ç½®å®‰å…¨ç»„**ï¼ˆåœ¨äº‘æœåŠ¡å•†æ§åˆ¶å°ï¼‰ï¼š
   - å¼€æ”¾ç«¯å£ï¼š22ï¼ˆSSHï¼‰ã€80ï¼ˆHTTPï¼‰ã€443ï¼ˆHTTPSï¼‰
   - å¼€æ”¾ç«¯å£ï¼š8002ï¼ˆåç«¯APIï¼Œå¯é€‰ï¼Œå¦‚æœä¸é€šè¿‡Nginxè®¿é—®ï¼‰

---

## ğŸ”§ ç¯å¢ƒå‡†å¤‡

### 1. è¿æ¥åˆ°æœåŠ¡å™¨

```bash
# Windows ä½¿ç”¨ PowerShell æˆ– CMD
ssh root@ä½ çš„å…¬ç½‘IP

# æˆ–ä½¿ç”¨ç”¨æˆ·å ubuntuï¼ˆUbuntuç³»ç»Ÿï¼‰
ssh ubuntu@ä½ çš„å…¬ç½‘IP
```

### 2. æ›´æ–°ç³»ç»Ÿ

```bash
# Ubuntu/Debian
sudo apt update && sudo apt upgrade -y

# CentOS/RHEL
sudo yum update -y
```

### 3. å®‰è£… Docker å’Œ Docker Compose

```bash
# å®‰è£… Docker
curl -fsSL https://get.docker.com -o get-docker.sh
sudo sh get-docker.sh

# å¯åŠ¨ Docker
sudo systemctl start docker
sudo systemctl enable docker

# å®‰è£… Docker Compose
sudo curl -L "https://github.com/docker/compose/releases/download/v2.20.0/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
sudo chmod +x /usr/local/bin/docker-compose

# éªŒè¯å®‰è£…
docker --version
docker-compose --version
```

### 4. å®‰è£…å¸¸ç”¨å·¥å…·

```bash
# å®‰è£… Gitï¼ˆç”¨äºæ‹‰å–ä»£ç ï¼‰
sudo apt install git -y

# å®‰è£… Nginxï¼ˆå¯é€‰ï¼Œæˆ‘ä»¬ä½¿ç”¨Dockerä¸­çš„Nginxï¼‰
# sudo apt install nginx -y
```

---

## ğŸ“¦ é¡¹ç›®éƒ¨ç½²

### æ–¹æ³•ä¸€ï¼šä½¿ç”¨ Gitï¼ˆæ¨èï¼‰

```bash
# 1. å…‹éš†é¡¹ç›®ï¼ˆå¦‚æœæœ‰Gitä»“åº“ï¼‰
cd /opt
git clone <ä½ çš„Gitä»“åº“åœ°å€> æŸç›Šå½’å› åˆ†æ
cd æŸç›Šå½’å› åˆ†æ

# å¦‚æœæ²¡æœ‰Gitä»“åº“ï¼Œå¯ä»¥æ‰‹åŠ¨ä¸Šä¼ æ–‡ä»¶ï¼ˆè§æ–¹æ³•äºŒï¼‰
```

### æ–¹æ³•äºŒï¼šæ‰‹åŠ¨ä¸Šä¼ æ–‡ä»¶

#### Windows ç”¨æˆ·ï¼ˆä½¿ç”¨ WinSCP æˆ– FileZillaï¼‰

1. ä¸‹è½½ WinSCPï¼šhttps://winscp.net
2. è¿æ¥åˆ°æœåŠ¡å™¨
3. ä¸Šä¼ æ•´ä¸ªé¡¹ç›®æ–‡ä»¶å¤¹åˆ°æœåŠ¡å™¨ï¼ˆå¦‚ `/opt/æŸç›Šå½’å› åˆ†æ`ï¼‰

#### ä½¿ç”¨ SCP å‘½ä»¤

åœ¨æœ¬åœ°é¡¹ç›®ç›®å½•ä¸‹æ‰§è¡Œï¼š

```bash
# Windows PowerShell
scp -r . root@ä½ çš„å…¬ç½‘IP:/opt/æŸç›Šå½’å› åˆ†æ

# Linux/Mac
scp -r . root@ä½ çš„å…¬ç½‘IP:/opt/æŸç›Šå½’å› åˆ†æ
```

### 3. é…ç½®é¡¹ç›®

```bash
# è¿›å…¥é¡¹ç›®ç›®å½•
cd /opt/æŸç›Šå½’å› åˆ†æ

# ä¿®æ”¹ Nginx é…ç½®ä¸­çš„åŸŸåï¼ˆå¦‚æœæœ‰ï¼‰
nano nginx/conf.d/default.conf
# å°† server_name _; æ”¹ä¸ºä½ çš„åŸŸåï¼Œä¾‹å¦‚ï¼šserver_name yourdomain.com;

# æ£€æŸ¥ Docker Compose é…ç½®
cat docker-compose.prod.yml
```

### 4. å¯åŠ¨æœåŠ¡

```bash
# æ„å»ºå¹¶å¯åŠ¨
docker-compose -f docker-compose.prod.yml up -d --build

# æŸ¥çœ‹æœåŠ¡çŠ¶æ€
docker-compose -f docker-compose.prod.yml ps

# æŸ¥çœ‹æ—¥å¿—
docker-compose -f docker-compose.prod.yml logs -f
```

### 5. éªŒè¯éƒ¨ç½²

```bash
# æ£€æŸ¥åç«¯æœåŠ¡
curl http://localhost:8002/api/portfolios

# æ£€æŸ¥Nginx
curl http://localhost

# æ£€æŸ¥å®¹å™¨çŠ¶æ€
docker ps
```

### 6. è®¿é—®ç³»ç»Ÿ

æ‰“å¼€æµè§ˆå™¨è®¿é—®ï¼š

- **å‰ç«¯é¡µé¢**ï¼šhttp://ä½ çš„å…¬ç½‘IP
- **APIæ–‡æ¡£**ï¼šhttp://ä½ çš„å…¬ç½‘IP/docs
- **åç«¯API**ï¼šhttp://ä½ çš„å…¬ç½‘IP/api/portfolios

---

## ğŸŒ åŸŸåå’ŒSSLé…ç½®

### 1. è´­ä¹°åŸŸå

åœ¨åŸŸåæœåŠ¡å•†ï¼ˆå¦‚é˜¿é‡Œäº‘ã€è…¾è®¯äº‘ã€GoDaddyï¼‰è´­ä¹°åŸŸåã€‚

### 2. é…ç½®DNSè§£æ

åœ¨åŸŸåæœåŠ¡å•†æ§åˆ¶å°æ·»åŠ Aè®°å½•ï¼š

```
ç±»å‹: A
ä¸»æœºè®°å½•: @ æˆ– www
è®°å½•å€¼: ä½ çš„å…¬ç½‘IP
TTL: 600
```

### 3. é…ç½®SSLè¯ä¹¦ï¼ˆLet's Encrypt å…è´¹è¯ä¹¦ï¼‰

#### æ–¹æ³•ä¸€ï¼šä½¿ç”¨ Certbotï¼ˆæ¨èï¼‰

```bash
# å®‰è£… Certbot
sudo apt install certbot python3-certbot-nginx -y

# åœæ­¢ Docker ä¸­çš„ Nginxï¼ˆä¸´æ—¶ï¼‰
docker-compose -f docker-compose.prod.yml stop nginx

# ç”Ÿæˆè¯ä¹¦ï¼ˆæ›¿æ¢ä¸ºä½ çš„åŸŸåå’Œé‚®ç®±ï¼‰
sudo certbot certonly --standalone -d yourdomain.com -d www.yourdomain.com

# è¯ä¹¦ä¼šç”Ÿæˆåœ¨ï¼š/etc/letsencrypt/live/yourdomain.com/
```

#### æ–¹æ³•äºŒï¼šä½¿ç”¨ Docker å®¹å™¨è‡ªåŠ¨ç”³è¯·

```bash
# ä¿®æ”¹ docker-compose.prod.ymlï¼Œæ·»åŠ  certbot æœåŠ¡
# ç„¶åè¿è¡Œï¼š
docker-compose -f docker-compose.prod.yml up -d certbot
```

### 4. é…ç½®Nginxä½¿ç”¨SSL

```bash
# ä¿®æ”¹ nginx/conf.d/default.conf
nano nginx/conf.d/default.conf

# å–æ¶ˆSSLè¯ä¹¦é…ç½®çš„æ³¨é‡Šï¼Œä¿®æ”¹ä¸ºï¼š
ssl_certificate /etc/letsencrypt/live/yourdomain.com/fullchain.pem;
ssl_certificate_key /etc/letsencrypt/live/yourdomain.com/privkey.pem;

# æŒ‚è½½è¯ä¹¦ç›®å½•åˆ°Dockerå®¹å™¨
# ä¿®æ”¹ docker-compose.prod.ymlï¼Œåœ¨ nginx æœåŠ¡ä¸­æ·»åŠ ï¼š
volumes:
  - /etc/letsencrypt:/etc/letsencrypt:ro
```

### 5. é‡å¯æœåŠ¡

```bash
docker-compose -f docker-compose.prod.yml restart nginx
```

### 6. è‡ªåŠ¨ç»­æœŸï¼ˆLet's Encryptè¯ä¹¦æœ‰æ•ˆæœŸ90å¤©ï¼‰

```bash
# æ·»åŠ åˆ° crontab
sudo crontab -e

# æ·»åŠ ä»¥ä¸‹è¡Œï¼ˆæ¯æœˆ1å·å‡Œæ™¨2ç‚¹æ›´æ–°è¯ä¹¦ï¼‰
0 2 1 * * certbot renew --quiet && docker-compose -f /opt/æŸç›Šå½’å› åˆ†æ/docker-compose.prod.yml restart nginx
```

---

## ğŸ”’ é˜²ç«å¢™é…ç½®

### Ubuntu UFW

```bash
# å®‰è£… UFW
sudo apt install ufw -y

# å…è®¸SSH
sudo ufw allow 22/tcp

# å…è®¸HTTPå’ŒHTTPS
sudo ufw allow 80/tcp
sudo ufw allow 443/tcp

# å¯ç”¨é˜²ç«å¢™
sudo ufw enable

# æŸ¥çœ‹çŠ¶æ€
sudo ufw status
```

### CentOS Firewalld

```bash
# å…è®¸ç«¯å£
sudo firewall-cmd --permanent --add-port=22/tcp
sudo firewall-cmd --permanent --add-port=80/tcp
sudo firewall-cmd --permanent --add-port=443/tcp

# é‡è½½é˜²ç«å¢™
sudo firewall-cmd --reload

# æŸ¥çœ‹çŠ¶æ€
sudo firewall-cmd --list-all
```

### äº‘æœåŠ¡å•†å®‰å…¨ç»„

åœ¨äº‘æœåŠ¡å•†æ§åˆ¶å°é…ç½®å®‰å…¨ç»„ï¼š

- **å…¥ç«™è§„åˆ™**ï¼š
  - ç«¯å£ï¼š22ï¼Œåè®®ï¼šTCPï¼Œæ¥æºï¼š0.0.0.0/0ï¼ˆSSHï¼Œå»ºè®®é™åˆ¶IPï¼‰
  - ç«¯å£ï¼š80ï¼Œåè®®ï¼šTCPï¼Œæ¥æºï¼š0.0.0.0/0ï¼ˆHTTPï¼‰
  - ç«¯å£ï¼š443ï¼Œåè®®ï¼šTCPï¼Œæ¥æºï¼š0.0.0.0/0ï¼ˆHTTPSï¼‰

---

## ğŸ“Š ç›‘æ§å’Œç»´æŠ¤

### 1. æŸ¥çœ‹æœåŠ¡çŠ¶æ€

```bash
# æŸ¥çœ‹å®¹å™¨çŠ¶æ€
docker-compose -f docker-compose.prod.yml ps

# æŸ¥çœ‹èµ„æºä½¿ç”¨
docker stats

# æŸ¥çœ‹æ—¥å¿—
docker-compose -f docker-compose.prod.yml logs -f backend
docker-compose -f docker-compose.prod.yml logs -f nginx
```

### 2. é‡å¯æœåŠ¡

```bash
# é‡å¯æ‰€æœ‰æœåŠ¡
docker-compose -f docker-compose.prod.yml restart

# é‡å¯ç‰¹å®šæœåŠ¡
docker-compose -f docker-compose.prod.yml restart backend
docker-compose -f docker-compose.prod.yml restart nginx
```

### 3. æ›´æ–°éƒ¨ç½²

```bash
# æ‹‰å–æœ€æ–°ä»£ç ï¼ˆå¦‚æœä½¿ç”¨Gitï¼‰
cd /opt/æŸç›Šå½’å› åˆ†æ
git pull

# é‡æ–°æ„å»ºå¹¶å¯åŠ¨
docker-compose -f docker-compose.prod.yml up -d --build

# æ¸…ç†æ—§é•œåƒ
docker system prune -a
```

### 4. å¤‡ä»½æ•°æ®

```bash
# å¤‡ä»½é…ç½®æ–‡ä»¶
tar -czf backup-$(date +%Y%m%d).tar.gz \
  nginx/ \
  docker-compose.prod.yml \
  .env

# å¤‡ä»½åˆ°è¿œç¨‹ï¼ˆå¯é€‰ï¼‰
# scp backup-*.tar.gz user@backup-server:/backup/
```

---

## â“ å¸¸è§é—®é¢˜

### 1. æ— æ³•è®¿é—®ç½‘ç«™

**æ£€æŸ¥æ­¥éª¤**ï¼š

```bash
# æ£€æŸ¥å®¹å™¨æ˜¯å¦è¿è¡Œ
docker ps

# æ£€æŸ¥ç«¯å£æ˜¯å¦ç›‘å¬
netstat -tulpn | grep 80
netstat -tulpn | grep 443

# æ£€æŸ¥é˜²ç«å¢™
sudo ufw status

# æ£€æŸ¥Nginxæ—¥å¿—
docker-compose -f docker-compose.prod.yml logs nginx

# æ£€æŸ¥åç«¯æ—¥å¿—
docker-compose -f docker-compose.prod.yml logs backend
```

### 2. SSLè¯ä¹¦é—®é¢˜

```bash
# æ£€æŸ¥è¯ä¹¦æœ‰æ•ˆæœŸ
sudo certbot certificates

# æ‰‹åŠ¨æ›´æ–°è¯ä¹¦
sudo certbot renew

# æµ‹è¯•è¯ä¹¦é…ç½®
sudo nginx -t
```

### 3. æ€§èƒ½ä¼˜åŒ–

```bash
# å¢åŠ åç«¯å·¥ä½œè¿›ç¨‹ï¼ˆåœ¨ docker-compose.prod.yml ä¸­ï¼‰
command: ["python", "-m", "uvicorn", "main:app", "--host", "0.0.0.0", "--port", "8002", "--workers", "8"]

# é™åˆ¶å®¹å™¨èµ„æºï¼ˆåœ¨ docker-compose.prod.yml ä¸­ï¼‰
deploy:
  resources:
    limits:
      cpus: '2'
      memory: 2G
```

### 4. æ—¥å¿—æŸ¥çœ‹

```bash
# å®æ—¶æŸ¥çœ‹æ‰€æœ‰æ—¥å¿—
docker-compose -f docker-compose.prod.yml logs -f

# æŸ¥çœ‹æœ€è¿‘100è¡Œ
docker-compose -f docker-compose.prod.yml logs --tail=100

# æŸ¥çœ‹ç‰¹å®šæœåŠ¡
docker-compose -f docker-compose.prod.yml logs -f backend
```

### 5. è¿›å…¥å®¹å™¨è°ƒè¯•

```bash
# è¿›å…¥åç«¯å®¹å™¨
docker-compose -f docker-compose.prod.yml exec backend bash

# è¿›å…¥Nginxå®¹å™¨
docker-compose -f docker-compose.prod.yml exec nginx sh
```

---

## ğŸ¯ å¿«é€Ÿéƒ¨ç½²è„šæœ¬

åˆ›å»ºä¸€ä¸ªå¿«é€Ÿéƒ¨ç½²è„šæœ¬ `deploy.sh`ï¼š

```bash
#!/bin/bash

echo "å¼€å§‹éƒ¨ç½²..."

# æ£€æŸ¥Docker
if ! command -v docker &> /dev/null; then
    echo "å®‰è£…Docker..."
    curl -fsSL https://get.docker.com -o get-docker.sh
    sudo sh get-docker.sh
fi

# æ£€æŸ¥Docker Compose
if ! command -v docker-compose &> /dev/null; then
    echo "å®‰è£…Docker Compose..."
    sudo curl -L "https://github.com/docker/compose/releases/download/v2.20.0/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
    sudo chmod +x /usr/local/bin/docker-compose
fi

# å¯åŠ¨æœåŠ¡
echo "å¯åŠ¨æœåŠ¡..."
docker-compose -f docker-compose.prod.yml up -d --build

# æ£€æŸ¥çŠ¶æ€
echo "æ£€æŸ¥æœåŠ¡çŠ¶æ€..."
docker-compose -f docker-compose.prod.yml ps

echo "éƒ¨ç½²å®Œæˆï¼"
echo "è®¿é—®åœ°å€: http://$(curl -s ifconfig.me)"
```

ä½¿ç”¨ï¼š

```bash
chmod +x deploy.sh
./deploy.sh
```

---

## ğŸ“ æŠ€æœ¯æ”¯æŒ

å¦‚æœé‡åˆ°é—®é¢˜ï¼š

1. æŸ¥çœ‹æ—¥å¿—ï¼š`docker-compose -f docker-compose.prod.yml logs`
2. æ£€æŸ¥é…ç½®ï¼š`docker-compose -f docker-compose.prod.yml config`
3. é‡å¯æœåŠ¡ï¼š`docker-compose -f docker-compose.prod.yml restart`

---

## âœ… éƒ¨ç½²æ£€æŸ¥æ¸…å•

- [ ] äº‘æœåŠ¡å™¨å·²è´­ä¹°å¹¶é…ç½®
- [ ] Docker å’Œ Docker Compose å·²å®‰è£…
- [ ] é¡¹ç›®æ–‡ä»¶å·²ä¸Šä¼ åˆ°æœåŠ¡å™¨
- [ ] é˜²ç«å¢™ç«¯å£å·²å¼€æ”¾ï¼ˆ80, 443, 22ï¼‰
- [ ] æœåŠ¡å·²å¯åŠ¨å¹¶è¿è¡Œæ­£å¸¸
- [ ] å¯ä»¥é€šè¿‡å…¬ç½‘IPè®¿é—®
- [ ] ï¼ˆå¯é€‰ï¼‰åŸŸåå·²é…ç½®å¹¶è§£æ
- [ ] ï¼ˆå¯é€‰ï¼‰SSLè¯ä¹¦å·²é…ç½®
- [ ] è¯ä¹¦è‡ªåŠ¨ç»­æœŸå·²è®¾ç½®

---

**éƒ¨ç½²å®Œæˆåï¼Œä½ çš„ç³»ç»Ÿå°±å¯ä»¥é€šè¿‡å…¬ç½‘è®¿é—®äº†ï¼** ğŸ‰


