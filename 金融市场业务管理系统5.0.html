<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é‡‘èå¸‚åœºä¸šåŠ¡ç®¡ç†ç³»ç»Ÿ5.0</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/date-fns@2.29.0/index.min.js"></script>
    <style>
/* å…¨å±€æ ·å¼ - äº®è‰²ä¸»é¢˜ï¼ˆæ·±è‰²ä¾§è¾¹æ  + ç™½è‰²ä¸»å†…å®¹åŒºï¼‰ */
* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
}

:root {
    /* ä¸»è‰²è°ƒ */
    --primary-color: #1890ff;
    --primary-hover: #40a9ff;
    --primary-light: rgba(24, 144, 255, 0.1);
    
    /* èƒŒæ™¯è‰² - äº®è‰²ä¸»é¢˜ */
    --bg-primary: #ffffff;
    --bg-secondary: #f5f5f5;
    --bg-tertiary: #fafafa;
    --bg-card: #ffffff;
    --bg-sidebar: #282c34;
    --bg-sidebar-hover: #3a404b;
    
    /* æ–‡å­—è‰² - äº®è‰²ä¸»é¢˜ */
    --text-primary: #262626;
    --text-secondary: #595959;
    --text-tertiary: #8c8c8c;
    --text-muted: #bfbfbf;
    --text-sidebar: #ffffff;
    
    /* è¾¹æ¡†è‰² */
    --border-color: #e8e8e8;
    --border-hover: #d9d9d9;
    --border-dark: #434343;
    
    /* åŠŸèƒ½è‰² */
    --success: #52c41a;
    --success-light: rgba(82, 196, 26, 0.1);
    --danger: #ff4d4f;
    --danger-light: rgba(255, 77, 79, 0.1);
    --warning: #faad14;
    --warning-light: rgba(250, 173, 20, 0.1);
    --info: #1890ff;
    
    /* é˜´å½± */
    --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.03);
    --shadow-md: 0 2px 8px 0 rgba(0, 0, 0, 0.08);
    --shadow-lg: 0 4px 12px 0 rgba(0, 0, 0, 0.12);
    --shadow-xl: 0 8px 24px 0 rgba(0, 0, 0, 0.16);
    
    /* åœ†è§’ */
    --radius-sm: 4px;
    --radius-md: 6px;
    --radius-lg: 8px;
    --radius-xl: 12px;
}

body {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Microsoft YaHei', 'PingFang SC', 'Helvetica Neue', Arial, sans-serif;
    background: #f5f5f5;
    color: var(--text-primary);
    line-height: 1.6;
    overflow-x: hidden;
    -webkit-font-smoothing: antialiased;
    -moz-osx-font-smoothing: grayscale;
    font-size: 14px;
}

/* é¡¶éƒ¨å¯¼èˆªæ  - ç™½è‰²èƒŒæ™¯ */
.top-navbar {
    background: #ffffff;
    border-bottom: 1px solid var(--border-color);
    height: 64px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 0 24px;
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    z-index: 1000;
    box-shadow: var(--shadow-sm);
}

.nav-left {
    display: flex;
    align-items: center;
}

.logo {
    display: flex;
    align-items: center;
    gap: 12px;
    white-space: nowrap;
    transition: transform 0.3s ease;
}

.logo:hover {
    transform: scale(1.02);
}

.logo-icon {
    flex-shrink: 0;
    display: block;
    filter: drop-shadow(0 2px 4px rgba(24, 144, 255, 0.3));
}

.logo-text {
    font-size: 20px;
    font-weight: 700;
    color: var(--text-primary);
    font-family: 'Microsoft YaHei', 'PingFang SC', 'Segoe UI', 'Arial', sans-serif;
    letter-spacing: 0.5px;
    white-space: nowrap;
}

.nav-center {
    flex: 1;
    display: flex;
    justify-content: center;
}

.nav-menu {
    display: flex;
    gap: 4px;
}

.nav-item {
    color: var(--text-secondary);
    text-decoration: none;
    padding: 8px 16px;
    border-radius: var(--radius-md);
    font-size: 13px;
    font-weight: 400;
    transition: all 0.3s ease;
}

.nav-item:hover {
    background: var(--bg-secondary);
    color: var(--text-primary);
}

.nav-item.active {
    background: var(--primary-color);
    color: #ffffff;
}

.nav-right {
    display: flex;
    align-items: center;
    gap: 16px;
}

.nav-icon {
    color: var(--text-secondary);
    font-size: 20px;
    cursor: pointer;
    padding: 8px;
    border-radius: var(--radius-md);
    transition: all 0.3s ease;
}

.nav-icon:hover {
    color: var(--text-primary);
    background: var(--bg-secondary);
}

.nav-user {
    color: var(--text-primary);
    font-size: 13px;
    font-weight: 500;
    cursor: pointer;
    padding: 8px 16px;
    border-radius: var(--radius-md);
    background: var(--bg-secondary);
    transition: all 0.3s ease;
}

.nav-user:hover {
    background: var(--border-color);
}

/* ä»ªè¡¨æ¿å®¹å™¨ */
.dashboard-container {
    display: flex;
    margin-top: 64px;
    min-height: calc(100vh - 64px);
}

/* å·¦ä¾§è¾¹æ  - æ·±è‰² */
.sidebar {
    width: 220px;
    background: var(--bg-sidebar);
    border-right: 1px solid var(--border-dark);
    padding: 24px 12px;
    min-height: calc(100vh - 64px);
    box-shadow: var(--shadow-md);
}

.sidebar-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 12px 16px;
    color: var(--text-sidebar);
    font-size: 15px;
    font-weight: 600;
    border-radius: var(--radius-md);
    cursor: pointer;
    transition: all 0.3s ease;
    user-select: none;
    margin-bottom: 4px;
    letter-spacing: 0.2px;
}

.sidebar-item:hover {
    background: var(--bg-sidebar-hover);
    color: var(--text-sidebar);
}

.sidebar-item.active {
    background: var(--bg-sidebar-hover);
    color: var(--text-sidebar);
    border-left: 3px solid var(--primary-color);
}

.sidebar-icon {
    font-size: 18px;
    font-weight: bold;
    opacity: 0.8;
}

.sidebar-item.active .sidebar-icon {
    opacity: 1;
}

/* å†…å®¹è§†å›¾ */
.content-view {
    display: none;
}

.content-view.active {
    display: block;
    animation: fadeIn 0.3s ease;
}

@keyframes fadeIn {
    from {
        opacity: 0;
        transform: translateY(10px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

/* ä¸»å†…å®¹åŒºåŸŸ - ç™½è‰²èƒŒæ™¯ */
.main-content {
    flex: 1;
    padding: 24px;
    background: var(--bg-primary);
    overflow-x: hidden;
}

/* Widget æ ·å¼ - ç™½è‰²èƒŒæ™¯ */
.widget {
    background: #ffffff;
    border: 1px solid var(--border-color);
    border-radius: var(--radius-lg);
    margin-bottom: 20px;
    overflow: hidden;
    transition: all 0.3s ease;
    box-shadow: var(--shadow-sm);
}

.widget:hover {
    border-color: var(--border-hover);
    box-shadow: var(--shadow-md);
}

.widget-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 16px 20px;
    border-bottom: 1px solid var(--border-color);
    background: #ffffff;
}

/* æŒ‡æ ‡å¡ç‰‡ä¸“ç”¨headeræ ·å¼ */
.metric-widget .widget-header {
    padding: 20px 24px 16px;
    border-bottom: none;
    justify-content: flex-start;
}

.widget-header-right {
    display: flex;
    align-items: center;
    gap: 16px;
}

.metric-display-inline {
    display: flex;
    align-items: baseline;
    gap: 4px;
}

.metric-value-inline {
    font-size: 28px;
    font-weight: 700;
    color: var(--text-primary);
    line-height: 1;
}

.metric-unit-inline {
    font-size: 13px;
    color: var(--text-secondary);
    font-weight: 400;
}

.widget-title {
    font-size: 16px;
    font-weight: 700;
    color: var(--text-primary);
    margin: 0;
    letter-spacing: 0.4px;
}

.widget-time {
    font-size: 12px;
    color: var(--text-tertiary);
    font-weight: 400;
}

.widget-content {
    padding: 20px;
    background: #ffffff;
}

/* æŒ‡æ ‡å¡ç‰‡ä¸“ç”¨contentæ ·å¼ */
.metric-widget .widget-content {
    padding: 0 24px 24px;
}

/* Widgets ç½‘æ ¼å¸ƒå±€ */
.widgets-grid {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 20px;
    margin-bottom: 20px;
}

/* å“åº”å¼ï¼šå½“å±å¹•è¾ƒå°æ—¶ï¼Œè°ƒæ•´ç½‘æ ¼å¸ƒå±€ */
@media (max-width: 1400px) {
    .widgets-grid {
        grid-template-columns: repeat(4, 1fr);
    }
}

@media (max-width: 1200px) {
    .widgets-grid {
        grid-template-columns: repeat(2, 1fr);
    }
}

@media (max-width: 768px) {
    .widgets-grid {
        grid-template-columns: 1fr;
    }
}

.widget.full-width {
    grid-column: 1 / -1;
}

/* é…ç½® Widget */
.config-widget {
    background: #ffffff;
}

.config-widget .widget-content {
    padding: 20px;
}

.config-row {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
    gap: 16px;
    margin-bottom: 16px;
}

.config-group {
    display: flex;
    flex-direction: column;
}

.config-group label {
    color: var(--text-secondary);
    font-size: 13px;
    margin-bottom: 8px;
    font-weight: 600;
    letter-spacing: 0.2px;
}

.config-group input[type="date"],
.config-group select {
    padding: 10px 14px;
    background: #ffffff;
    border: 1px solid var(--border-color);
    border-radius: var(--radius-md);
    color: var(--text-primary);
    font-size: 14px;
    font-weight: 500;
    transition: all 0.3s ease;
    font-family: inherit;
}

.config-group input[type="date"]:hover,
.config-group select:hover {
    border-color: var(--border-hover);
}

.config-group input[type="date"]:focus,
.config-group select:focus {
    outline: none;
    border-color: var(--primary-color);
    box-shadow: 0 0 0 2px var(--primary-light);
}

/* ç§»é™¤å¤šé€‰ä¸‹æ‹‰æ¡†çš„ç‰¹æ®Šæ ·å¼ï¼Œå› ä¸ºå·²æ”¹ä¸ºå•é€‰ */

.radio-group {
    display: flex;
    gap: 20px;
    margin-top: 8px;
}

.radio-group label {
    font-weight: normal;
    cursor: pointer;
    color: var(--text-secondary);
    font-size: 14px;
    transition: color 0.3s ease;
}

.radio-group label:hover {
    color: var(--text-primary);
}

.radio-group input[type="radio"] {
    margin-right: 6px;
    accent-color: var(--primary-color);
}

.config-actions {
    display: flex;
    gap: 12px;
    margin-top: 16px;
    flex-wrap: wrap;
    justify-content: flex-end;
}

/* æŒ‰é’®æ ·å¼ */
.btn {
    padding: 10px 20px;
    border: none;
    border-radius: var(--radius-md);
    font-size: 14px;
    font-weight: 700;
    cursor: pointer;
    transition: all 0.3s ease;
    letter-spacing: 0.4px;
}

.btn-primary {
    background: var(--primary-color);
    color: white;
    box-shadow: 0 2px 4px rgba(24, 144, 255, 0.2);
}

.btn-primary:hover {
    background: var(--primary-hover);
    box-shadow: 0 4px 8px rgba(24, 144, 255, 0.3);
    transform: translateY(-1px);
}

.btn-secondary {
    background: #ffffff;
    color: var(--text-primary);
    border: 1px solid var(--border-color);
}

.btn-secondary:hover {
    background: var(--bg-secondary);
    border-color: var(--border-hover);
}

.btn-success {
    background: var(--success);
    color: white;
    box-shadow: 0 2px 4px rgba(82, 196, 26, 0.2);
}

.btn-success:hover {
    background: #73d13d;
    box-shadow: 0 4px 8px rgba(82, 196, 26, 0.3);
    transform: translateY(-1px);
}

/* æŒ‡æ ‡ Widget - é‡æ–°è®¾è®¡çš„å¡ç‰‡æ ·å¼ */
.metric-widget {
    min-height: 140px;
    border: none;
    overflow: hidden;
    position: relative;
    background: #ffffff;
    border-radius: var(--radius-lg);
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
    transition: all 0.3s ease;
}

.metric-widget:hover {
    box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);
    transform: translateY(-2px);
}

/* ç´¯è®¡æŸç›Šæ€»é¢ - çªå‡ºæ˜¾ç¤ºï¼ˆæ·±è“ä¸»é¢˜ï¼‰ */
.metric-widget-primary {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: #ffffff;
    box-shadow: 0 4px 16px rgba(102, 126, 234, 0.25);
    border: none;
}

.metric-widget-primary:hover {
    box-shadow: 0 6px 20px rgba(102, 126, 234, 0.35);
}

.metric-widget-primary .widget-header {
    background: transparent;
    border-bottom: 1px solid rgba(255, 255, 255, 0.15);
    padding: 20px 24px 16px;
}

.metric-widget-primary .widget-content {
    background: transparent;
    border: none;
    padding: 0 24px 24px;
}

.metric-widget-primary .widget-title {
    color: rgba(255, 255, 255, 0.95);
    font-size: 15px;
    font-weight: 600;
    letter-spacing: 0.3px;
}

.metric-widget-primary .metric-value {
    color: #ffffff;
    font-size: 42px;
    font-weight: 800;
    -webkit-text-fill-color: #ffffff;
    text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
}

.metric-widget-primary .metric-unit {
    color: rgba(255, 255, 255, 0.85);
    font-size: 14px;
    font-weight: 500;
}

/* åˆ©æ¯æŸç›Š - æ¸…æ–°ç»¿è‰² */
.metric-widget:nth-of-type(2) {
    background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
    color: #ffffff;
}

.metric-widget:nth-of-type(2) .widget-header {
    background: linear-gradient(90deg, rgba(56, 239, 125, 0.15) 0%, transparent 100%);
    border-bottom: 1px solid rgba(255, 255, 255, 0.2);
    padding: 20px 24px 16px;
}

.metric-widget:nth-of-type(2) .widget-content {
    background: transparent;
    border: none;
    padding: 0 24px 24px;
}

.metric-widget:nth-of-type(2) .widget-title {
    color: rgba(255, 255, 255, 0.98);
    font-size: 15px;
    font-weight: 600;
    letter-spacing: 0.3px;
    position: relative;
    padding-left: 12px;
    text-shadow: 0 1px 3px rgba(0, 0, 0, 0.2);
}

.metric-widget:nth-of-type(2) .widget-title::before {
    content: '';
    position: absolute;
    left: 0;
    top: 50%;
    transform: translateY(-50%);
    width: 4px;
    height: 22px;
    background: linear-gradient(180deg, #a8ffe0 0%, #38ef7d 100%);
    border-radius: 2px;
    box-shadow: 0 2px 6px rgba(56, 239, 125, 0.4);
}

.metric-widget:nth-of-type(2) .metric-value {
    color: #ffffff;
    font-size: 42px;
    font-weight: 800;
    text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
}

.metric-widget:nth-of-type(2) .metric-unit {
    color: rgba(255, 255, 255, 0.85);
    font-size: 14px;
    font-weight: 500;
}

/* ä¼°å€¼æŸç›Š - ä¼˜é›…è“è‰² */
.metric-widget:nth-of-type(3) {
    background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
    color: #ffffff;
}

.metric-widget:nth-of-type(3) .widget-header {
    background: linear-gradient(90deg, rgba(0, 242, 254, 0.15) 0%, transparent 100%);
    border-bottom: 1px solid rgba(255, 255, 255, 0.2);
    padding: 20px 24px 16px;
}

.metric-widget:nth-of-type(3) .widget-content {
    background: transparent;
    border: none;
    padding: 0 24px 24px;
}

.metric-widget:nth-of-type(3) .widget-title {
    color: rgba(255, 255, 255, 0.98);
    font-size: 15px;
    font-weight: 600;
    letter-spacing: 0.3px;
    position: relative;
    padding-left: 12px;
    text-shadow: 0 1px 3px rgba(0, 0, 0, 0.2);
}

.metric-widget:nth-of-type(3) .widget-title::before {
    content: '';
    position: absolute;
    left: 0;
    top: 50%;
    transform: translateY(-50%);
    width: 4px;
    height: 22px;
    background: linear-gradient(180deg, #b8e6ff 0%, #00f2fe 100%);
    border-radius: 2px;
    box-shadow: 0 2px 6px rgba(0, 242, 254, 0.4);
}

.metric-widget:nth-of-type(3) .metric-value {
    color: #ffffff;
    font-size: 42px;
    font-weight: 800;
    text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
}

.metric-widget:nth-of-type(3) .metric-unit {
    color: rgba(255, 255, 255, 0.85);
    font-size: 14px;
    font-weight: 500;
}

/* ä»·å·®æŸç›Š - æ¸©æš–æ©™è‰² */
.metric-widget:nth-of-type(4) {
    background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
    color: #ffffff;
}

.metric-widget:nth-of-type(4) .widget-header {
    background: linear-gradient(90deg, rgba(254, 225, 64, 0.15) 0%, transparent 100%);
    border-bottom: 1px solid rgba(255, 255, 255, 0.2);
    padding: 20px 24px 16px;
}

.metric-widget:nth-of-type(4) .widget-content {
    background: transparent;
    border: none;
    padding: 0 24px 24px;
}

.metric-widget:nth-of-type(4) .widget-title {
    color: rgba(255, 255, 255, 0.98);
    font-size: 15px;
    font-weight: 600;
    letter-spacing: 0.3px;
    position: relative;
    padding-left: 12px;
    text-shadow: 0 1px 3px rgba(0, 0, 0, 0.2);
}

.metric-widget:nth-of-type(4) .widget-title::before {
    content: '';
    position: absolute;
    left: 0;
    top: 50%;
    transform: translateY(-50%);
    width: 4px;
    height: 22px;
    background: linear-gradient(180deg, #ffd4e5 0%, #fee140 100%);
    border-radius: 2px;
    box-shadow: 0 2px 6px rgba(254, 225, 64, 0.4);
}

.metric-widget:nth-of-type(4) .metric-value {
    color: #ffffff;
    font-size: 42px;
    font-weight: 800;
    text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
}

.metric-widget:nth-of-type(4) .metric-unit {
    color: rgba(255, 255, 255, 0.85);
    font-size: 14px;
    font-weight: 500;
}

.metric-main {
    display: flex;
    align-items: baseline;
    gap: 8px;
    margin-top: 8px;
}

.metric-value {
    font-size: 36px;
    font-weight: 800;
    color: var(--text-primary);
    letter-spacing: -0.8px;
    line-height: 1.2;
}

.metric-unit {
    font-size: 13px;
    color: var(--text-tertiary);
    font-weight: 400;
}

/* ç§»é™¤äº†metric-trendç›¸å…³æ ·å¼ï¼Œå› ä¸ºä¸å†ä½¿ç”¨åŒæ¯”ç¯æ¯” */

/* å›¾è¡¨ Widget */
.chart-widget {
    min-height: 380px;
    background: #ffffff;
}

.chart-widget.full-width {
    min-height: 400px;
}

.chart-widget .widget-content {
    padding: 24px;
    height: 350px;
}

.chart-widget.full-width .widget-content {
    height: 400px;
}

.chart-widget canvas {
    max-height: 100%;
}

/* è¡¨æ ¼ Widget */
.table-widget {
    overflow-x: auto;
    background: #ffffff;
}

.table-container {
    overflow-x: auto;
}

table {
    width: 100%;
    border-collapse: collapse;
    font-size: 14px;
}

thead th {
    background: #fafafa;
    color: var(--text-primary);
    padding: 10px 12px;
    text-align: left;
    font-weight: 700;
    border-bottom: 2px solid var(--border-color);
    white-space: nowrap;
    font-size: 13px;
    letter-spacing: 0.3px;
}

tbody td {
    padding: 10px 12px;
    border-bottom: 1px solid var(--border-color);
    color: var(--text-secondary);
    transition: all 0.2s ease;
    font-size: 13px;
    font-weight: 400;
}

tbody tr {
    transition: all 0.2s ease;
}

tbody tr:hover {
    background: var(--bg-secondary);
}

.empty-state {
    text-align: center;
    color: var(--text-tertiary);
    padding: 60px;
    font-size: 14px;
    font-weight: 400;
}

/* è­¦å‘Š Widget */
.warning-widget {
    background: #fffbe6;
    border-color: var(--warning);
}

.warning-widget .widget-title {
    color: var(--warning);
}

.warning-widget ul {
    list-style-type: none;
    padding-left: 0;
}

.warning-widget li {
    margin-bottom: 10px;
    font-size: 13px;
    padding: 10px 14px;
    background: #fffbe6;
    border-left: 3px solid var(--warning);
    border-radius: var(--radius-sm);
    color: var(--text-secondary);
    font-weight: 500;
}

/* æ•°å­—æ ¼å¼åŒ– */
.positive {
    color: var(--success);
    font-weight: 700;
}

.negative {
    color: var(--danger);
    font-weight: 700;
}

.neutral {
    color: var(--text-tertiary);
}

/* åŠ è½½åŠ¨ç”» */
.loading {
    display: inline-block;
    width: 20px;
    height: 20px;
    border: 3px solid rgba(24, 144, 255, 0.2);
    border-top: 3px solid var(--primary-color);
    border-radius: 50%;
    animation: spin 0.8s linear infinite;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

/* å“åº”å¼è®¾è®¡ */
@media (max-width: 1200px) {
    .widgets-grid {
        grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
        gap: 16px;
    }
}

@media (max-width: 768px) {
    .sidebar {
        width: 70px;
        padding: 16px 8px;
    }
    
    .sidebar-item span:first-child {
        display: none;
    }
    
    .nav-menu {
        display: none;
    }
    
/* æ˜ç»†æ—¥æœŸé€‰æ‹©å™¨å®¹å™¨ */
.detail-date-selector {
    margin: 16px 0;
    display: flex;
    align-items: center;
    gap: 12px;
}

.detail-date-selector label {
    color: var(--text-secondary);
    font-size: 14px;
    font-weight: 500;
    white-space: nowrap;
}

#fxDetailDateSelect {
    padding: 8px 12px;
    border: 1px solid var(--border-color);
    border-radius: var(--radius-sm);
    font-size: 14px;
    color: var(--text-primary);
    background-color: var(--bg-card);
    cursor: pointer;
    transition: border-color 0.2s, box-shadow 0.2s;
    font-family: inherit;
    min-width: 180px;
}

#fxDetailDateSelect:hover {
    border-color: var(--primary-color);
}

#fxDetailDateSelect:focus {
    outline: none;
    border-color: var(--primary-color);
    box-shadow: 0 0 0 2px var(--primary-light);
}

/* äº¤æ˜“æ˜ç»†è¡¨æ ¼æ ·å¼ */
.text-right {
    text-align: right;
}

.positive {
    color: var(--success);
    font-weight: 500;
}

.negative {
    color: var(--danger);
    font-weight: 500;
}

    .config-row {
        grid-template-columns: 1fr;
    }
    
    .widgets-grid {
        grid-template-columns: 1fr;
    }
    
    .metric-trend {
        flex-direction: column;
        gap: 8px;
    }
    
    .main-content {
        padding: 16px;
    }
}

/* æ»šåŠ¨æ¡æ ·å¼ */
::-webkit-scrollbar {
    width: 10px;
    height: 10px;
}

::-webkit-scrollbar-track {
    background: #f5f5f5;
    border-radius: 10px;
}

::-webkit-scrollbar-thumb {
    background: #d9d9d9;
    border-radius: 10px;
}

::-webkit-scrollbar-thumb:hover {
    background: #bfbfbf;
}

/* æ¨¡æ€æ¡†æ ·å¼ */
.modal {
    display: none;
    position: fixed;
    z-index: 2000;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.45);
    overflow: auto;
    animation: fadeIn 0.3s ease;
}

.modal-content {
    background: #ffffff;
    margin: 5% auto;
    padding: 0;
    border: 1px solid var(--border-color);
    border-radius: var(--radius-xl);
    width: 85%;
    max-width: 900px;
    box-shadow: var(--shadow-xl);
    animation: slideDown 0.3s ease;
}

@keyframes slideDown {
    from {
        opacity: 0;
        transform: translateY(-20px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 24px;
    border-bottom: 1px solid var(--border-color);
    background: #ffffff;
}

.modal-title {
    margin: 0;
    color: var(--text-primary);
    font-size: 22px;
    font-weight: 700;
    letter-spacing: 0.5px;
}

.modal-close {
    color: var(--text-tertiary);
    font-size: 28px;
    font-weight: bold;
    cursor: pointer;
    line-height: 1;
    transition: all 0.3s ease;
    width: 32px;
    height: 32px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: var(--radius-md);
}

.modal-close:hover {
    color: var(--text-primary);
    background: var(--bg-secondary);
}

.modal-body {
    padding: 24px;
    background: #ffffff;
}

/* TAB å¯¼èˆªæ ·å¼ */
.tab-nav {
    display: flex;
    gap: 0;
    margin-bottom: 20px;
    border-bottom: 2px solid var(--border-color);
}

.tab-button {
    padding: 12px 24px;
    background: transparent;
    border: none;
    border-bottom: 3px solid transparent;
    color: var(--text-tertiary);
    cursor: pointer;
    font-size: 14px;
    font-weight: 500;
    transition: all 0.3s ease;
    margin-bottom: -2px;
    position: relative;
}

.tab-button:hover {
    color: var(--text-primary);
    background: var(--bg-secondary);
}

.tab-button.active {
    color: var(--primary-color);
    background: transparent;
    border-bottom-color: var(--primary-color);
    font-weight: 700;
}

.tab-content {
    display: none;
    animation: fadeIn 0.3s ease;
}

.tab-content.active {
    display: block;
}

/* å›¾è¡¨å®¹å™¨ */
.chart-container {
    padding: 20px;
    height: 400px;
    position: relative;
}

.chart-container canvas {
    max-height: 100%;
}

/* äº§å“åˆ†ç±»å›¾è¡¨å¸ƒå±€ï¼ˆé¥¼å›¾+è¡¨æ ¼ï¼‰ */
.product-chart-layout {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 24px;
    padding: 20px;
}

.product-chart-left {
    display: flex;
    align-items: center;
    justify-content: center;
    height: 400px;
    position: relative;
}

.product-chart-left canvas {
    max-width: 100%;
    max-height: 100%;
}

.product-chart-right {
    display: flex;
    flex-direction: column;
}

.product-chart-right .table-container {
    flex: 1;
    overflow: auto;
}

.product-chart-right table {
    width: 100%;
    border-collapse: collapse;
}

.product-chart-right table th {
    background: var(--bg-secondary);
    color: var(--text-primary);
    font-weight: 700;
    padding: 12px 16px;
    text-align: left;
    border-bottom: 2px solid var(--border-color);
    font-size: 14px;
    letter-spacing: 0.3px;
}

.product-chart-right table td {
    padding: 12px 16px;
    border-bottom: 1px solid var(--border-color);
    color: var(--text-secondary);
    font-size: 14px;
    font-weight: 400;
}

.product-chart-right table tbody tr:hover {
    background: var(--bg-secondary);
}

.product-chart-right table td.positive {
    color: var(--success);
}

.product-chart-right table td.negative {
    color: var(--danger);
}

.product-chart-right table td.neutral {
    color: var(--text-tertiary);
}

/* å“åº”å¼ï¼šå°å±å¹•æ—¶æ”¹ä¸ºå•åˆ—å¸ƒå±€ */
@media (max-width: 1200px) {
    .product-chart-layout {
        grid-template-columns: 1fr;
    }
    
    .product-chart-left {
        height: 300px;
    }
}

/* ä¸‹é’»æ ‡ç­¾é¡µæ ·å¼ */
.drilldown-tabs {
    display: flex;
    gap: 8px;
    margin-bottom: 24px;
    border-bottom: 2px solid var(--border-color);
}

.tab-btn {
    padding: 12px 24px;
    background: transparent;
    border: none;
    border-bottom: 3px solid transparent;
    color: var(--text-tertiary);
    cursor: pointer;
    font-size: 14px;
    font-weight: 500;
    transition: all 0.3s ease;
    margin-bottom: -2px;
}

.tab-btn:hover {
    color: var(--text-primary);
    background: var(--bg-secondary);
}

.tab-btn.active {
    color: var(--primary-color);
    background: transparent;
    border-bottom-color: var(--primary-color);
    font-weight: 700;
}

/* æŒ‰é’®å°å°ºå¯¸ */
.btn-small {
    padding: 6px 14px;
    font-size: 12px;
}

/* æ“ä½œæŒ‰é’®æ ·å¼ - è“è‰²ä¸»é¢˜ */
.action-btn {
    padding: 6px 16px;
    border: none;
    border-radius: var(--radius-md);
    font-size: 13px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
    letter-spacing: 0.2px;
    background: var(--primary-color);
    color: #ffffff;
    box-shadow: 0 2px 4px rgba(24, 144, 255, 0.2);
}

.action-btn:hover {
    background: var(--primary-hover);
    box-shadow: 0 4px 8px rgba(24, 144, 255, 0.3);
    transform: translateY(-1px);
}

.action-btn:active {
    transform: translateY(0);
    box-shadow: 0 2px 4px rgba(24, 144, 255, 0.2);
}

/* å…¨å®½å›¾è¡¨å®¹å™¨ */
.full-width {
    grid-column: 1 / -1;
}

    </style>
</head>
<body>

    <!-- é¡¶éƒ¨å¯¼èˆªæ  -->
    <header class="top-navbar">
        <div class="nav-left">
            <div class="logo">
                <span class="logo-text">é‡‘èå¸‚åœºä¸šåŠ¡ç®¡ç†ç³»ç»Ÿ5.0</span>
            </div>
        </div>
        <div class="nav-center">
            <nav class="nav-menu">
                <a href="#" class="nav-item active">é¦–é¡µ</a>
                <a href="#" class="nav-item">äº¤æ˜“ç°¿è®°</a>
                <a href="#" class="nav-item">æŒä»“ç®¡ç†</a>
                <a href="#" class="nav-item">ä¸šåŠ¡ç®¡ç†</a>
                <a href="#" class="nav-item">é™é¢ç®¡ç†</a>
                <a href="#" class="nav-item">æŸ¥è¯¢ç®¡ç†</a>
                <a href="#" class="nav-item">åŸºç¡€æ•°æ®</a>
            </nav>
        </div>
        <div class="nav-right">
            <div class="nav-icon">ğŸ””</div>
            <div class="nav-icon">âš™ï¸</div>
            <div class="nav-user">admin â–¼</div>
        </div>
        </header>

    <div class="dashboard-container">
        <!-- å·¦ä¾§è¾¹æ  -->
        <aside class="sidebar">
            <div class="sidebar-item active" id="currentPnlMenuItem">
                <span>å½“å‰æŸç›Šåˆ†æ</span>
                <span class="sidebar-icon">+</span>
            </div>
            <div class="sidebar-item" id="fxPnlMenuItem">
                <span>å¤–æ±‡ç±»æŸç›Šå½’å› åˆ†æ</span>
                <span class="sidebar-icon">+</span>
            </div>
        </aside>

        <!-- ä¸»å†…å®¹åŒºåŸŸ -->
        <main class="main-content">
            <!-- å½“å‰æŸç›Šåˆ†æç•Œé¢ -->
            <div id="currentPnlView" class="content-view active">

            <!-- é…ç½®é¢æ¿ Widget -->
            <div class="widget config-widget">
                <div class="widget-content">
            <div class="config-row">
                <div class="config-group">
                    <label for="startDate">å¼€å§‹æ—¥æœŸ</label>
                    <input type="date" id="startDate" value="2025-11-01">
                </div>
                <div class="config-group">
                    <label for="endDate">ç»“æŸæ—¥æœŸ</label>
                    <input type="date" id="endDate" value="">
                </div>
                <div class="config-group">
                    <label for="portfolioSelect">æŠ•èµ„ç»„åˆ</label>
                            <select id="portfolioSelect">
                                <option value="">è¯·é€‰æ‹©</option>
                                <option value="all">å…¨æœºæ„</option>
                                <option value="fx_spot">å¤–æ±‡å³æœŸæŠ•ç»„</option>
                                <option value="derivative">è¡ç”Ÿå“æŠ•ç»„</option>
                                <option value="ir">åˆ©ç‡æŠ•ç»„</option>
                                <option value="option">æœŸæƒæŠ•ç»„</option>
                    </select>
                </div>
                <div class="config-group">
                    <label for="productSelect">äº§å“</label>
                            <select id="productSelect">
                                <option value="">è¯·é€‰æ‹©</option>
                                <option value="FXSPOT">å¤–æ±‡å³æœŸ</option>
                                <option value="FWD">å¤–æ±‡è¿œæœŸ</option>
                                <option value="FXSW">å¤–æ±‡æ‰æœŸ</option>
                                <option value="FXOPT">å¤–æ±‡æœŸæƒ</option>
                                <option value="CCS">CCS</option>
                                <option value="IRS">IRS</option>
                    </select>
                </div>
            </div>
            <div class="config-actions">
                <button id="queryBtn" class="btn btn-primary">æŸ¥è¯¢</button>
                <button id="resetBtn" class="btn btn-secondary">é‡ç½®</button>
                    </div>
                </div>
            </div>

            <!-- æ ¸å¿ƒæŒ‡æ ‡å¡ç‰‡ Widgets - æ¨ªå‘åˆ†å¸ƒ -->
            <div class="widgets-grid">
                <!-- ç´¯è®¡æŸç›Šæ€»é¢ - çªå‡ºæ˜¾ç¤º -->
                <div class="widget metric-widget metric-widget-primary">
                    <div class="widget-header">
                        <h3 class="widget-title">ç´¯è®¡æŸç›Šæ€»é¢</h3>
                    </div>
                    <div class="widget-content">
                        <div class="metric-main">
                            <div class="metric-value" id="totalPnl">--</div>
                            <div class="metric-unit">ä¸‡å…ƒ</div>
                        </div>
                    </div>
                </div>

                <!-- åˆ©æ¯æŸç›Š -->
                <div class="widget metric-widget">
                    <div class="widget-header">
                        <h3 class="widget-title">åˆ©æ¯æŸç›Š</h3>
                    </div>
                    <div class="widget-content">
                        <div class="metric-main">
                            <div class="metric-value" id="interestPnl">--</div>
                            <div class="metric-unit">ä¸‡å…ƒ</div>
                        </div>
                    </div>
                </div>

                <!-- ä¼°å€¼æŸç›Š -->
                <div class="widget metric-widget">
                    <div class="widget-header">
                        <h3 class="widget-title">ä¼°å€¼æŸç›Š</h3>
                    </div>
                    <div class="widget-content">
                        <div class="metric-main">
                            <div class="metric-value" id="valuationPnl">--</div>
                            <div class="metric-unit">ä¸‡å…ƒ</div>
                        </div>
                    </div>
                </div>

                <!-- ä»·å·®æŸç›Š -->
                <div class="widget metric-widget">
                    <div class="widget-header">
                        <h3 class="widget-title">ä»·å·®æŸç›Š</h3>
                    </div>
                    <div class="widget-content">
                        <div class="metric-main">
                            <div class="metric-value" id="priceDiffPnl">--</div>
                            <div class="metric-unit">ä¸‡å…ƒ</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ç´¯è®¡æŸç›Šè¶‹åŠ¿å›¾ -->
            <div class="widget chart-widget full-width">
                <div class="widget-header">
                    <h3 class="widget-title">ç´¯è®¡æŸç›Šè¶‹åŠ¿</h3>
                    <div class="widget-time">19:38:53</div>
                </div>
                <div class="widget-content">
                    <canvas id="trendChart"></canvas>
                </div>
                </div>

            <!-- è­¦å‘Šæç¤º Widget -->
            <div id="warningsSection" class="widget warning-widget" style="display: none;">
                <div class="widget-header">
                    <h3 class="widget-title">æ•°æ®è­¦å‘Š</h3>
            </div>
                <div class="widget-content">
                    <ul id="warningsList"></ul>
                </div>
            </div>

            <!-- è¯¦ç»†æ•°æ® TAB Widget -->
            <div class="widget table-widget">
                <div class="widget-content" style="padding: 16px;">
                    <!-- TAB å¯¼èˆª -->
                    <div class="tab-nav">
                        <button class="tab-button active" data-tab="tab1">æŒ‰æŠ•ç»„ç»´åº¦</button>
                        <button class="tab-button" data-tab="tab2">æŒ‰äº§å“åˆ†ç±»</button>
                        <button class="tab-button" data-tab="tab3">æŒ‰æŸç›Šåˆ†é¡¹</button>
                    </div>
                    
                    <!-- Tab1: æŒ‰æŠ•ç»„ç»´åº¦è¡¨æ ¼ -->
                    <div id="tab1" class="tab-content active">
            <div class="table-container">
                            <table id="portfolioTable">
                    <thead>
                        <tr>
                                        <th>æŠ•ç»„</th>
                            <th>åˆ©æ¯æŸç›Š</th>
                            <th>ä»·å·®æŸç›Š</th>
                            <th>ä¼°å€¼æŸç›Š</th>
                            <th>èèµ„æˆæœ¬</th>
                            <th>æ‰‹ç»­è´¹</th>
                            <th>æ€»è®¡</th>
                            <th>å æ¯”</th>
                                        <th>æ“ä½œ</th>
                        </tr>
                    </thead>
                                <tbody id="portfolioTableBody">
                        <tr>
                            <td colspan="9" class="empty-state">è¯·ç‚¹å‡»æŸ¥è¯¢æŒ‰é’®åŠ è½½æ•°æ®</td>
                        </tr>
                    </tbody>
                </table>
            </div>
                    </div>
                    
                    <!-- Tab2: æŒ‰äº§å“åˆ†ç±»é¥¼å›¾+è¡¨æ ¼ -->
                    <div id="tab2" class="tab-content">
                        <div class="product-chart-layout">
                            <!-- å·¦ä¾§ï¼šé¥¼å›¾ -->
                            <div class="product-chart-left">
                                <canvas id="productPieChart"></canvas>
                            </div>
                            <!-- å³ä¾§ï¼šè¡¨æ ¼ -->
                            <div class="product-chart-right">
                                <div class="table-container">
                                    <table id="productTable">
                                        <thead>
                                            <tr>
                                                <th>äº§å“</th>
                                                <th>æŸç›Šï¼ˆä¸‡å…ƒï¼‰</th>
                                                <th>å æ¯”</th>
                                                <th>æ“ä½œ</th>
                                            </tr>
                                        </thead>
                                        <tbody id="productTableBody">
                                            <tr>
                                                <td colspan="4" class="empty-state">è¯·ç‚¹å‡»æŸ¥è¯¢æŒ‰é’®åŠ è½½æ•°æ®</td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Tab3: æŒ‰æŸç›Šåˆ†é¡¹æŸ±çŠ¶å›¾ -->
                    <div id="tab3" class="tab-content">
                        <div class="chart-container">
                            <canvas id="componentBarChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- äº¤æ˜“æ˜ç»†æ¨¡æ€æ¡† -->
            <div id="transactionDetailModal" class="modal" style="display: none;">
                <div class="modal-content">
                    <div class="modal-header">
                        <h3>äº¤æ˜“æ˜ç»†</h3>
                        <button class="modal-close" id="closeModal">&times;</button>
                    </div>
                    <div class="modal-body">
                        <div id="transactionDetailContent">
                            <p>åŠ è½½ä¸­...</p>
                        </div>
                    </div>
                </div>
            </div>
            </div>

            <!-- å¤–æ±‡ç±»æŸç›Šå½’å› åˆ†æç•Œé¢ -->
            <div id="fxPnlView" class="content-view" style="display: none;">
                <!-- é…ç½®é¢æ¿ Widget -->
                <div class="widget config-widget">
                    <div class="widget-content">
                        <div class="config-row">
                            <div class="config-group">
                                <label for="fxStartDate">å¼€å§‹æ—¥æœŸ</label>
                                <input type="date" id="fxStartDate" value="2025-11-01">
                            </div>
                            <div class="config-group">
                                <label for="fxEndDate">ç»“æŸæ—¥æœŸ</label>
                                <input type="date" id="fxEndDate" value="">
                            </div>
                            <div class="config-group">
                                <label for="fxPortfolioSelect">æŠ•èµ„ç»„åˆ</label>
                                <select id="fxPortfolioSelect">
                                    <option value="">è¯·é€‰æ‹©</option>
                                    <option value="all">å…¨æœºæ„</option>
                                    <option value="fx_spot">å¤–æ±‡å³æœŸæŠ•ç»„</option>
                                    <option value="derivative">è¡ç”Ÿå“æŠ•ç»„</option>
                                    <option value="ir">åˆ©ç‡æŠ•ç»„</option>
                                    <option value="option">æœŸæƒæŠ•ç»„</option>
                                </select>
                            </div>
                            <div class="config-group">
                                <label for="fxProductSelect">äº§å“</label>
                                <select id="fxProductSelect">
                                    <option value="">è¯·é€‰æ‹©</option>
                                    <option value="FXSPOT">å¤–æ±‡å³æœŸ</option>
                                    <option value="FWD">å¤–æ±‡è¿œæœŸ</option>
                                    <option value="FXSW">å¤–æ±‡æ‰æœŸ</option>
                                    <option value="FXOPT">å¤–æ±‡æœŸæƒ</option>
                                    <option value="CCS">CCS</option>
                                    <option value="IRS">IRS</option>
                                </select>
                            </div>
                            <div class="config-group">
                                <label for="fxCurrencyPairSelect">æ ‡çš„</label>
                                <select id="fxCurrencyPairSelect">
                                    <option value="">è¯·é€‰æ‹©</option>
                                    <option value="USDCNY">USDCNY</option>
                                    <option value="EURCNY">EURCNY</option>
                                    <option value="GBPCNY">GBPCNY</option>
                                    <option value="JPYCNY">JPYCNY</option>
                                    <option value="HKDCNY">HKDCNY</option>
                                    <option value="AUDCNY">AUDCNY</option>
                                </select>
                            </div>
                        </div>
                        <div class="config-actions">
                            <button id="fxQueryBtn" class="btn btn-primary">æŸ¥è¯¢</button>
                            <button id="fxResetBtn" class="btn btn-secondary">é‡ç½®</button>
                        </div>
                    </div>
                </div>

                <!-- ç´¯è®¡ä¼°å€¼æŸç›Šå’Œè¶‹åŠ¿å›¾ -->
                <div class="widget chart-widget">
                    <div class="widget-header">
                        <h3 class="widget-title">ç´¯è®¡ä¼°å€¼æŸç›Š</h3>
                        <div class="widget-header-right">
                            <div class="metric-display-inline">
                                <span class="metric-value-inline" id="fxValuationPnl">--</span>
                                <span class="metric-unit-inline">ä¸‡å…ƒ</span>
                            </div>
                            <div class="widget-time">19:38:53</div>
                        </div>
                    </div>
                    <div class="widget-content">
                        <canvas id="fxTrendChart"></canvas>
                    </div>
                </div>

                <!-- è­¦å‘Šæç¤º Widget -->
                <div id="fxWarningsSection" class="widget warning-widget" style="display: none;">
                    <div class="widget-header">
                        <h3 class="widget-title">æ•°æ®è­¦å‘Š</h3>
                    </div>
                    <div class="widget-content">
                        <ul id="fxWarningsList"></ul>
                    </div>
                </div>

                <!-- å½’å› æ˜ç»† TAB Widget -->
                <div class="widget table-widget">
                    <div class="widget-content" style="padding: 16px;">
                        <!-- TAB å¯¼èˆª -->
                        <div class="tab-nav">
                            <button class="tab-button active" data-tab="fxTab1">å½’å› æ˜ç»†</button>
                            <button class="tab-button" data-tab="fxTab2">æŒ‰æŠ•ç»„</button>
                            <button class="tab-button" data-tab="fxTab3">æŒ‰èµ„äº§æ ‡çš„</button>
                        </div>
                        
                        <!-- Tab1: å½’å› æ˜ç»† - æŒ‰æŠ•ç»„ç»´åº¦å±•ç¤ºå½’å› ç»“æœ -->
                        <div id="fxTab1" class="tab-content active">
                            <div class="table-container">
                                <table id="fxAttributionTable">
                                    <thead>
                                        <tr>
                                            <th>Folder</th>
                                            <th>æ€»æ•å£</th>
                                            <th>ä¼°å€¼æŸç›Š</th>
                                            <th>Delta</th>
                                            <th>Gamma</th>
                                            <th>Vega</th>
                                            <th>Theta</th>
                                            <th>Rho</th>
                                            <th>Phi</th>
                                            <th>Volga</th>
                                            <th>Vanna</th>
                                            <th>æ— æ³•è§£é‡Šéƒ¨åˆ†</th>
                                            <th>æ“ä½œ</th>
                                        </tr>
                                    </thead>
                                    <tbody id="fxAttributionTableBody">
                                        <tr>
                                            <td colspan="13" class="empty-state">è¯·ç‚¹å‡»æŸ¥è¯¢æŒ‰é’®åŠ è½½æ•°æ®</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        
                        <!-- Tab2: æŒ‰æŠ•ç»„ - å±•ç¤ºæ•æ„Ÿå€¼ -->
                        <div id="fxTab2" class="tab-content">
                            <div class="table-container">
                                <table id="fxPortfolioSensitivityTable">
                                    <thead>
                                        <tr>
                                            <th>æŠ•ç»„</th>
                                            <th>æ€»æ•å£</th>
                                            <th>Delta</th>
                                            <th>Gamma</th>
                                            <th>Vega</th>
                                            <th>Theta</th>
                                            <th>Rho</th>
                                            <th>Phi</th>
                                            <th>Volga</th>
                                            <th>Vanna</th>
                                            <th>æ“ä½œ</th>
                                        </tr>
                                    </thead>
                                    <tbody id="fxPortfolioSensitivityTableBody">
                                        <tr>
                                            <td colspan="11" class="empty-state">è¯·ç‚¹å‡»æŸ¥è¯¢æŒ‰é’®åŠ è½½æ•°æ®</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        
                        <!-- Tab3: æŒ‰èµ„äº§æ ‡çš„ - æŒ‰è´§å¸å¯¹å±•ç¤º -->
                        <div id="fxTab3" class="tab-content">
                            <div class="table-container">
                                <table id="fxAssetTargetTable">
                                    <thead>
                                        <tr>
                                            <th>è´§å¸å¯¹</th>
                                            <th>ä¼°å€¼æŸç›Š</th>
                                            <th>Delta</th>
                                            <th>Gamma</th>
                                            <th>Vega</th>
                                            <th>Theta</th>
                                            <th>Rho</th>
                                            <th>Phi</th>
                                            <th>Volga</th>
                                            <th>Vanna</th>
                                            <th>æ— æ³•è§£é‡Šéƒ¨åˆ†</th>
                                            <th>æ“ä½œ</th>
                                        </tr>
                                    </thead>
                                    <tbody id="fxAssetTargetTableBody">
                                        <tr>
                                            <td colspan="12" class="empty-state">è¯·ç‚¹å‡»æŸ¥è¯¢æŒ‰é’®åŠ è½½æ•°æ®</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- äº¤æ˜“æ˜ç»†å¼¹çª— -->
    <div id="fxDrilldownModal" class="modal" style="display: none;">
        <div class="modal-content" style="max-width: 1400px;">
            <div class="modal-header">
                <h3 class="modal-title">äº¤æ˜“æ˜ç»†</h3>
                <span class="modal-close">&times;</span>
            </div>
            <div class="modal-body">
                <div class="table-container" style="max-height: 600px; overflow-y: auto;">
                    <table id="fxTransactionDetailTable">
                        <thead>
                            <tr>
                                <th>äº¤æ˜“ç¼–å·</th>
                                <th>äº¤æ˜“æ—¥æœŸ</th>
                                <th>äº§å“ä»£ç </th>
                                <th>äº§å“åç§°</th>
                                <th>è´§å¸å¯¹</th>
                                <th>äº¤æ˜“æ–¹å‘</th>
                                <th>åä¹‰é‡‘é¢ï¼ˆä¸‡å…ƒï¼‰</th>
                                <th>ä»·æ ¼</th>
                                <th>ä¼°å€¼æŸç›Šï¼ˆä¸‡å…ƒï¼‰</th>
                                <th>æŠ•ç»„</th>
                                <th>Delta</th>
                                <th>Vega</th>
                                <th>Gamma</th>
                                <th>Theta</th>
                                <th>Rho</th>
                                <th>Vanna</th>
                                <th>Charm</th>
                                <th>Veta</th>
                                <th>Vomma</th>
                                <th>Speed</th>
                                <th>ThetaDecay</th>
                            </tr>
                        </thead>
                        <tbody id="fxTransactionDetailBody">
                            <tr>
                                <td colspan="21" class="empty-state">åŠ è½½ä¸­...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- è´¡çŒ®åº¦å¼¹çª— -->
    <div id="fxContributionModal" class="modal" style="display: none;">
        <div class="modal-content" style="max-width: 1000px;">
            <div class="modal-header">
                <h3 class="modal-title">è´¡çŒ®åº¦åˆ†æ</h3>
                <span class="modal-close" id="fxContributionClose">&times;</span>
            </div>
            <div class="modal-body">
                <div id="fxContributionContent">
                    <p style="padding: 20px; color: var(--text-secondary);">åŠ è½½ä¸­...</p>
                </div>
            </div>
        </div>
    </div>

    <!-- äº§å“å½’å› è´¡çŒ®å¼¹çª— -->
    <div id="fxProductAttributionModal" class="modal" style="display: none;">
        <div class="modal-content" style="max-width: 900px;">
            <div class="modal-header">
                <h3 class="modal-title">å½’å› è´¡çŒ®åº¦</h3>
                <span class="modal-close" id="fxProductAttributionModalClose">&times;</span>
            </div>
            <div class="modal-body">
                <div style="margin-bottom: 16px;">
                    <h4 id="fxProductAttributionProductName" style="color: var(--text-primary); font-size: 16px; margin: 0;"></h4>
                </div>
                <div class="table-container" style="max-height: 500px; overflow-y: auto;">
                    <table id="fxProductAttributionTable">
                        <thead>
                            <tr>
                                <th>å½’å› åˆ†é¡¹</th>
                                <th>è´¡çŒ®åº¦ï¼ˆä¸‡å…ƒï¼‰</th>
                                <th>å æ¯”</th>
                            </tr>
                        </thead>
                        <tbody id="fxProductAttributionBody">
                            <tr>
                                <td colspan="3" class="empty-state">åŠ è½½ä¸­...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- å½’å› åˆ†é¡¹è¶‹åŠ¿å›¾å¼¹çª— -->
    <div id="fxTrendChartModal" class="modal" style="display: none;">
        <div class="modal-content" style="max-width: 1200px;">
            <div class="modal-header">
                <h3 class="modal-title">å½’å› åˆ†é¡¹è¶‹åŠ¿å›¾</h3>
                <span class="modal-close" id="fxTrendChartModalClose">&times;</span>
            </div>
            <div class="modal-body">
                <div style="height: 500px;">
                    <canvas id="fxFactorTrendChart"></canvas>
                </div>
            </div>
        </div>
    </div>

    
    
    
    
    
    
    
    
    
    

    <script>
/**
 * API è°ƒç”¨æ¨¡å—
 */

// APIåŸºç¡€URL - è‡ªåŠ¨æ£€æµ‹ç¯å¢ƒ
// ä¼˜å…ˆçº§ï¼šç¯å¢ƒå˜é‡ > è‡ªåŠ¨æ£€æµ‹
const API_BASE_URL = (() => {
    // 1. ä¼˜å…ˆä½¿ç”¨ç¯å¢ƒå˜é‡ï¼ˆå¦‚æœè®¾ç½®äº†ï¼‰
    if (window.API_BASE_URL) {
        return window.API_BASE_URL;
    }
    
    // 2. æ£€æŸ¥æ˜¯å¦æœ‰åç«¯URLé…ç½®ï¼ˆRailwayç­‰å¹³å°ï¼‰
    const backendUrl = document.querySelector('meta[name="backend-url"]')?.content;
    if (backendUrl) {
        return backendUrl + '/api';
    }
    
    // 3. å¦‚æœå½“å‰æ˜¯localhostæˆ–127.0.0.1ï¼Œä½¿ç”¨æœ¬åœ°å¼€å‘åœ°å€
    if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
        return 'http://localhost:8002/api';
    }
    
    // 4. å…¬ç½‘éƒ¨ç½²ï¼šä½¿ç”¨ç›¸å¯¹è·¯å¾„ï¼ˆé€šè¿‡Nginx/åå‘ä»£ç†ï¼‰
    // æˆ–è€…ä½¿ç”¨å½“å‰åŸŸåï¼ˆå¦‚æœå‰åç«¯åŒåŸŸï¼‰
    return '/api';
})();

class APIClient {
    /**
     * å‘é€ GET è¯·æ±‚
     */
    async get(url, params = {}) {
        try {
            let fullUrl = `${API_BASE_URL}${url}`;
            const queryString = new URLSearchParams(params).toString();
            if (queryString) {
                fullUrl += `?${queryString}`;
            }
            
            const response = await fetch(fullUrl);
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return await response.json();
        } catch (error) {
            console.error('GET request failed:', error);
            throw error;
        }
    }

    /**
     * å‘é€ POST è¯·æ±‚
     */
    async post(url, data) {
        try {
            const response = await fetch(`${API_BASE_URL}${url}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(data)
            });
            
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return await response.json();
        } catch (error) {
            console.error('POST request failed:', error);
            throw error;
        }
    }

    /**
     * è·å–æŠ•èµ„ç»„åˆåˆ—è¡¨
     */
    async getPortfolios() {
        return await this.get('/portfolios');
    }

    /**
     * è·å–äº§å“åˆ—è¡¨
     */
    async getProducts(portfolioId = null) {
        const params = portfolioId ? { portfolio_id: portfolioId } : {};
        return await this.get('/products', params);
    }

    /**
     * è·å–é»„é‡‘ä»·æ ¼
     */
    async getGoldPrice() {
        return await this.get('/gold-price');
    }

    /**
     * è®¡ç®—æŸç›Š
     */
    async calculatePnL(requestData) {
        return await this.post('/pnl/calculate', requestData);
    }

    /**
     * è·å–æŸç›Šè¶‹åŠ¿
     */
    async getPnLTrend(params) {
        return await this.get('/pnl/trend', params);
    }

    /**
     * è·å–äº¤æ˜“æ˜ç»†
     */
    async getTransactionDetails(requestData) {
        return await this.post('/pnl/transaction-details', requestData);
    }

    /**
     * å¯¼å‡º Excel
     */
    async exportExcel(params) {
        try {
            const queryString = new URLSearchParams(params).toString();
            const url = `${API_BASE_URL}/pnl/export?${queryString}`;
            
            // ä¸‹è½½æ–‡ä»¶
            window.location.href = url;
        } catch (error) {
            console.error('Export failed:', error);
            throw error;
        }
    }

    // ============ å¤–æ±‡ç±»æŸç›Šå½’å› åˆ†ææ¥å£ ============

    /**
     * è·å–å¤–æ±‡äº§å“åˆ—è¡¨
     */
    async getFXProducts() {
        return await this.get('/fx-attribution/products');
    }

    /**
     * è®¡ç®—å¤–æ±‡å½’å› åˆ†æ
     */
    async calculateFXAttribution(requestData) {
        return await this.post('/fx-attribution/calculate', requestData);
    }

    /**
     * è·å–å¤–æ±‡å½’å› è¶‹åŠ¿æ•°æ®
     */
    async getFXTrend(params) {
        return await this.get('/fx-attribution/trend', params);
    }

    /**
     * ä¸‹é’»æŸ¥è¯¢å› å­æ•°æ®
     */
    async getFXDrilldown(requestData) {
        return await this.post('/fx-attribution/drilldown', requestData);
    }

    /**
     * è·å–å½’å› åˆ†é¡¹è¶‹åŠ¿æ•°æ®ï¼ˆæ¯ä¸ªå› å­æ¯å¤©çš„è´¡çŒ®ï¼‰
     */
    async getFXFactorTrend(requestData) {
        return await this.post('/fx-attribution/factor-trend', requestData);
    }

    /**
     * è·å–äº¤æ˜“æ˜ç»†
     */
    async getFXTransactionDetails(requestData) {
        return await this.post('/fx-attribution/transaction-details', requestData);
    }

    /**
     * å¯¼å‡ºå¤–æ±‡å½’å› åˆ†æ Excel
     */
    async exportFXExcel(params) {
        try {
            const queryString = new URLSearchParams(params).toString();
            const url = `${API_BASE_URL}/fx-attribution/export?${queryString}`;
            
            // ä¸‹è½½æ–‡ä»¶
            window.location.href = url;
        } catch (error) {
            console.error('FX Export failed:', error);
            throw error;
        }
    }
}

// åˆ›å»ºå…¨å±€ API å®¢æˆ·ç«¯å®ä¾‹
const api = new APIClient();

// æš´éœ²åˆ°å…¨å±€ä½œç”¨åŸŸ
if (typeof window !== 'undefined') {
    window.api = api;
}


    </script>
    <script>
/**
 * ä¸»åº”ç”¨é€»è¾‘
 */

// å…¨å±€çŠ¶æ€
const state = {
    portfolios: [],
    products: [],
    currentData: null,
    trendData: null,
    selectedPortfolio: null, // å½“å‰é€‰ä¸­çš„æŠ•ç»„
    selectedProduct: null // å½“å‰é€‰ä¸­çš„äº§å“
};

// DOM å…ƒç´ 
const elements = {
    startDate: document.getElementById('startDate'),
    endDate: document.getElementById('endDate'),
    portfolioSelect: document.getElementById('portfolioSelect'),
    productSelect: document.getElementById('productSelect'),
    queryBtn: document.getElementById('queryBtn'),
    resetBtn: document.getElementById('resetBtn'),
    totalPnl: document.getElementById('totalPnl'),
    interestPnl: document.getElementById('interestPnl'),
    valuationPnl: document.getElementById('valuationPnl'),
    priceDiffPnl: document.getElementById('priceDiffPnl'),
    warningsSection: document.getElementById('warningsSection'),
    warningsList: document.getElementById('warningsList'),
    portfolioTableBody: document.getElementById('portfolioTableBody'),
    productTableBody: document.getElementById('productTableBody'),
    transactionDetailModal: document.getElementById('transactionDetailModal'),
    transactionDetailContent: document.getElementById('transactionDetailContent'),
    closeModal: document.getElementById('closeModal')
};

// åˆå§‹åŒ–
async function init() {
    // è®¾ç½®é»˜è®¤ç»“æŸæ—¥æœŸä¸ºä»Šå¤©
    const today = new Date().toISOString().split('T')[0];
    elements.endDate.value = today;
    
    // åŠ è½½åŸºç¡€æ•°æ®
    await loadBaseData();
    
    // ç»‘å®šäº‹ä»¶
    bindEvents();
    
    console.log('Application initialized');
}

// åŠ è½½åŸºç¡€æ•°æ®
async function loadBaseData() {
    try {
        // æŠ•èµ„ç»„åˆå’Œäº§å“å·²æ”¹ä¸ºå›ºå®šä¸‹æ‹‰æ¡†ï¼Œä¸éœ€è¦ä»APIåŠ è½½
        // è®¾ç½®é»˜è®¤å€¼
        if (elements.portfolioSelect) {
            elements.portfolioSelect.value = '';
        }
        if (elements.productSelect) {
            elements.productSelect.value = '';
        }
        
        console.log('Base data initialized');
    } catch (error) {
        console.error('Failed to initialize:', error);
        showError('åˆå§‹åŒ–å¤±è´¥');
    }
}

// ç»‘å®šäº‹ä»¶
function bindEvents() {
    // æŸ¥è¯¢æŒ‰é’®
    elements.queryBtn.addEventListener('click', handleQuery);
    
    // TABåˆ‡æ¢
    const tabButtons = document.querySelectorAll('.tab-button');
    tabButtons.forEach(button => {
        button.addEventListener('click', handleTabSwitch);
    });
    
    // æ¨¡æ€æ¡†å…³é—­
    if (elements.closeModal) {
        elements.closeModal.addEventListener('click', closeTransactionModal);
    }
    
    // ç‚¹å‡»æ¨¡æ€æ¡†å¤–éƒ¨å…³é—­
    if (elements.transactionDetailModal) {
        elements.transactionDetailModal.addEventListener('click', (e) => {
            if (e.target === elements.transactionDetailModal) {
                closeTransactionModal();
            }
        });
    }
    
    // é‡ç½®æŒ‰é’®
    elements.resetBtn.addEventListener('click', handleReset);
    
    // ä¾§è¾¹æ èœå•é¡¹ç‚¹å‡»
    const sidebarItems = document.querySelectorAll('.sidebar-item');
    sidebarItems.forEach(item => {
        item.addEventListener('click', handleSidebarItemClick);
    });
}

// å¤„ç†ä¾§è¾¹æ èœå•é¡¹ç‚¹å‡»
function handleSidebarItemClick(event) {
    const clickedItem = event.currentTarget;
    const itemId = clickedItem.id;
    
    // ç§»é™¤æ‰€æœ‰activeçŠ¶æ€
    document.querySelectorAll('.sidebar-item').forEach(item => {
        item.classList.remove('active');
    });
    
    // éšè—æ‰€æœ‰å†…å®¹è§†å›¾
    document.querySelectorAll('.content-view').forEach(view => {
        view.classList.remove('active');
        view.style.display = 'none';
    });
    
    // æ·»åŠ å½“å‰é¡¹çš„activeçŠ¶æ€
    clickedItem.classList.add('active');
    
    // æ˜¾ç¤ºå¯¹åº”çš„å†…å®¹è§†å›¾
    if (itemId === 'currentPnlMenuItem') {
        const currentPnlView = document.getElementById('currentPnlView');
        if (currentPnlView) {
            currentPnlView.classList.add('active');
            currentPnlView.style.display = 'block';
            // ç¡®ä¿è¶‹åŠ¿å›¾å·²åˆå§‹åŒ–ï¼ˆå¦‚æœè¿˜æœªåˆå§‹åŒ–ï¼‰
            setTimeout(() => {
                const trendCtx = document.getElementById('trendChart');
                if (trendCtx) {
                    // å¦‚æœå›¾è¡¨æœªåˆå§‹åŒ–ï¼Œæˆ–è€…å½“å‰è§†å›¾æ˜¯éšè—çš„ï¼Œé‡æ–°åˆå§‹åŒ–
                    if (!window.trendChartInstance || !trendChartInstance) {
                        console.log('Initializing trend chart on view switch');
                        if (typeof initTrendChart === 'function') {
                            initTrendChart();
                        }
                    }
                    // å¦‚æœæœ‰è¶‹åŠ¿æ•°æ®ï¼Œæ›´æ–°å›¾è¡¨
                    if (state.trendData && state.trendData.length > 0) {
                        console.log('Updating trend chart with existing data');
                        if (typeof updateTrendChart === 'function') {
                            updateTrendChart(state.trendData);
                        }
                    }
                }
            }, 300);
        }
    } else if (itemId === 'fxPnlMenuItem') {
        const fxPnlView = document.getElementById('fxPnlView');
        if (fxPnlView) {
            fxPnlView.classList.add('active');
            fxPnlView.style.display = 'block';
        }
    }
    
    // æ»šåŠ¨åˆ°é¡µé¢é¡¶éƒ¨
    window.scrollTo({ top: 0, behavior: 'smooth' });
    
    // è§¦å‘ä¸»å†…å®¹åŒºåŸŸçš„è”åŠ¨æ•ˆæœ
    highlightMainContent();
}

// é«˜äº®ä¸»å†…å®¹åŒºåŸŸ
function highlightMainContent() {
    const activeView = document.querySelector('.content-view.active');
    if (activeView) {
        const configWidget = activeView.querySelector('.config-widget');
        if (configWidget) {
            configWidget.style.transition = 'all 0.3s';
            configWidget.style.borderColor = '#4a90e2';
            configWidget.style.boxShadow = '0 0 10px rgba(74, 144, 226, 0.2)';
            
            setTimeout(() => {
                configWidget.style.borderColor = '';
                configWidget.style.boxShadow = '';
                setTimeout(() => {
                    configWidget.style.transition = '';
                }, 300);
            }, 800);
        }
    }
}

// å¤„ç†æŸ¥è¯¢
async function handleQuery() {
    try {
        // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
        elements.queryBtn.innerHTML = '<span class="loading"></span> æŸ¥è¯¢ä¸­...';
        elements.queryBtn.disabled = true;
        
        // è·å–é…ç½®
        const analysisType = 'mark_to_market'; // é»˜è®¤ä½¿ç”¨æŒ‰å¸‚ä»·åˆ†æ
        const startDate = elements.startDate.value;
        const endDate = elements.endDate.value;
        
        // å¤„ç†æŠ•èµ„ç»„åˆï¼ˆå•é€‰ä¸‹æ‹‰æ¡†ï¼‰
        const portfolioValue = elements.portfolioSelect.value;
        const portfolioIds = portfolioValue && portfolioValue !== '' ? [portfolioValue] : [];
        
        // å¤„ç†äº§å“ï¼ˆå•é€‰ä¸‹æ‹‰æ¡†ï¼‰
        const productValue = elements.productSelect.value;
        const productCodes = productValue && productValue !== '' ? [productValue] : [];
        
        const groupBy = 'portfolio'; // é»˜è®¤ä½¿ç”¨ç°¿è®°æ¶æ„åˆ†ç»„
        
        // éªŒè¯æ—¥æœŸ
        if (!startDate || !endDate) {
            alert('è¯·é€‰æ‹©æ—¥æœŸèŒƒå›´');
            return;
        }
        
        if (new Date(endDate) < new Date(startDate)) {
            alert('ç»“æŸæ—¥æœŸå¿…é¡»å¤§äºç­‰äºå¼€å§‹æ—¥æœŸ');
            return;
        }
        
        // å‘é€è¯·æ±‚
        const pnlResponse = await api.calculatePnL({
            analysis_type: analysisType,
            start_date: startDate,
            end_date: endDate,
            portfolio_ids: portfolioIds,
            product_codes: productCodes,
            group_by: groupBy
        });
        
        // ä¿å­˜æ•°æ®å’ŒæŸ¥è¯¢æ¡ä»¶
        state.currentData = pnlResponse;
        state.selectedPortfolio = portfolioValue; // ä¿å­˜é€‰ä¸­çš„æŠ•ç»„
        state.selectedProduct = productValue; // ä¿å­˜é€‰ä¸­çš„äº§å“
        
        // åŠ è½½è¶‹åŠ¿æ•°æ®
        try {
            const trendParams = {
                start_date: startDate,
                end_date: endDate,
                portfolio_ids: portfolioIds.length > 0 ? portfolioIds.join(',') : '',
                product_codes: productCodes.length > 0 ? productCodes.join(',') : '',
                group_by: groupBy
            };
            console.log('Fetching trend data with params:', trendParams);
            const trendResponse = await api.getPnLTrend(trendParams);
            console.log('Trend API response:', trendResponse);
            state.trendData = trendResponse.trend_data || [];
            console.log('Trend data loaded:', state.trendData);
            console.log('Trend data count:', state.trendData.length);
            if (state.trendData.length > 0) {
                console.log('First trend data point:', state.trendData[0]);
            }
        } catch (error) {
            console.error('Failed to load trend data:', error);
            console.error('Error details:', error.message, error.stack);
            state.trendData = [];
        }
        
        // æ›´æ–°æ˜¾ç¤º
        updateDisplay(pnlResponse, state.trendData);
        
        console.log('Query completed:', pnlResponse);
    } catch (error) {
        console.error('Query failed:', error);
        showError('æŸ¥è¯¢å¤±è´¥ï¼Œè¯·æ£€æŸ¥åç«¯æœåŠ¡');
    } finally {
        // æ¢å¤æŒ‰é’®çŠ¶æ€
        elements.queryBtn.innerHTML = 'æŸ¥è¯¢';
        elements.queryBtn.disabled = false;
    }
}

// å¤„ç†é‡ç½®
function handleReset() {
    elements.startDate.value = '2025-11-01';
    elements.endDate.value = new Date().toISOString().split('T')[0];
    
    // æ¸…ç©ºå¤šé€‰ä¸‹æ‹‰æ¡†çš„æ‰€æœ‰é€‰ä¸­é¡¹
    Array.from(elements.portfolioSelect.options).forEach(option => {
        option.selected = false;
    });
    Array.from(elements.productSelect.options).forEach(option => {
        option.selected = false;
    });
    
    // æ¸…ç©ºæ˜¾ç¤º
    elements.totalPnl.textContent = '--';
    elements.totalPnl.className = 'metric-value';
    elements.interestPnl.textContent = '--';
    elements.interestPnl.className = 'metric-value';
    elements.valuationPnl.textContent = '--';
    elements.valuationPnl.className = 'metric-value';
    elements.priceDiffPnl.textContent = '--';
    elements.priceDiffPnl.className = 'metric-value';
    elements.dataTableBody.innerHTML = '<tr><td colspan="8" class="empty-state">è¯·ç‚¹å‡»æŸ¥è¯¢æŒ‰é’®åŠ è½½æ•°æ®</td></tr>';
    
    state.currentData = null;
    state.trendData = null;
    
    // æ¸…ç©ºå›¾è¡¨
    clearCharts();
}

// å¤„ç†å¯¼å‡º
async function handleExport() {
    try {
        if (!state.currentData) {
            alert('è¯·å…ˆæŸ¥è¯¢æ•°æ®');
            return;
        }
        
        const analysisType = 'mark_to_market'; // é»˜è®¤ä½¿ç”¨æŒ‰å¸‚ä»·åˆ†æ
        const startDate = elements.startDate.value;
        const endDate = elements.endDate.value;
        
        // å¤„ç†æŠ•èµ„ç»„åˆï¼ˆå•é€‰ä¸‹æ‹‰æ¡†ï¼‰
        const portfolioValue = elements.portfolioSelect.value;
        const portfolioIds = portfolioValue && portfolioValue !== '' ? portfolioValue : '';
        
        // å¤„ç†äº§å“ï¼ˆå•é€‰ä¸‹æ‹‰æ¡†ï¼‰
        const productValue = elements.productSelect.value;
        const productCodes = productValue && productValue !== '' ? productValue : '';
        
        const groupBy = 'portfolio'; // é»˜è®¤ä½¿ç”¨ç°¿è®°æ¶æ„åˆ†ç»„
        
        await api.exportExcel({
            start_date: startDate,
            end_date: endDate,
            analysis_type: analysisType,
            portfolio_ids: portfolioIds,
            product_codes: productCodes,
            group_by: groupBy
        });
    } catch (error) {
        console.error('Export failed:', error);
        alert('å¯¼å‡ºå¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
    }
}

// æ›´æ–°æ˜¾ç¤º
function updateDisplay(pnlData, trendData) {
    console.log('updateDisplay called with:', { pnlData, trendData });
    
    // æ›´æ–°æ ¸å¿ƒæŒ‡æ ‡
    updateMetrics(pnlData);
    
    // æ›´æ–°è­¦å‘Š
    updateWarnings(pnlData.warnings);
    
    // æ›´æ–°TABå†…å®¹
    updateTabs(pnlData.details);
    
    // æ›´æ–°å›¾è¡¨ï¼ˆç¡®ä¿åœ¨DOMå‡†å¤‡å¥½åæ›´æ–°ï¼‰
    setTimeout(() => {
        console.log('Updating charts with trend data:', trendData);
        updateCharts(pnlData, trendData);
    }, 100);
}

// æ›´æ–°æ ¸å¿ƒæŒ‡æ ‡
function updateMetrics(data) {
    // ç´¯è®¡æŸç›Šæ€»é¢
    const total = data.total_pnl || 0;
    elements.totalPnl.textContent = formatNumber(total);
    elements.totalPnl.className = 'metric-value ' + getNumberClass(total);
    
    // è®¡ç®—å„é¡¹æŸç›Šï¼ˆä»detailsä¸­æ±‡æ€»ï¼‰
    let interestTotal = 0;
    let valuationTotal = 0;
    let priceDiffTotal = 0;
    
    if (data.details && data.details.length > 0) {
        data.details.forEach(detail => {
            interestTotal += detail.pnl_interest || 0;
            valuationTotal += detail.pnl_valuation || 0;
            priceDiffTotal += detail.pnl_price_diff || 0;
        });
    }
    
    // åˆ©æ¯æŸç›Š
    elements.interestPnl.textContent = formatNumber(interestTotal);
    elements.interestPnl.className = 'metric-value ' + getNumberClass(interestTotal);
    
    // ä¼°å€¼æŸç›Š
    elements.valuationPnl.textContent = formatNumber(valuationTotal);
    elements.valuationPnl.className = 'metric-value ' + getNumberClass(valuationTotal);
    
    // ä»·å·®æŸç›Š
    elements.priceDiffPnl.textContent = formatNumber(priceDiffTotal);
    elements.priceDiffPnl.className = 'metric-value ' + getNumberClass(priceDiffTotal);
}

// æ›´æ–°è­¦å‘Š
function updateWarnings(warnings) {
    if (warnings && warnings.length > 0) {
        elements.warningsSection.style.display = 'block';
        elements.warningsList.innerHTML = '';
        warnings.forEach(warning => {
            const li = document.createElement('li');
            li.textContent = `[${warning.type}] ${warning.date}: ${warning.product || 'N/A'} - ${warning.suggested_action}`;
            elements.warningsList.appendChild(li);
        });
    } else {
        elements.warningsSection.style.display = 'none';
    }
}

// TABåˆ‡æ¢å¤„ç†
function handleTabSwitch(event) {
    const tabButton = event.currentTarget;
    const tabId = tabButton.getAttribute('data-tab');
    
    // ç§»é™¤æ‰€æœ‰activeçŠ¶æ€
    document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
    document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
    
    // æ¿€æ´»é€‰ä¸­çš„TAB
    tabButton.classList.add('active');
    const tabContent = document.getElementById(tabId);
    if (tabContent) {
        tabContent.classList.add('active');
    }
    
    // å¦‚æœåˆ‡æ¢åˆ°å›¾è¡¨TABï¼Œéœ€è¦åˆå§‹åŒ–å¹¶æ›´æ–°å›¾è¡¨
    if (tabId === 'tab2') {
        // åˆå§‹åŒ–äº§å“åˆ†ç±»é¥¼å›¾
        if (typeof initProductPieChart === 'function' && !window.productPieChartInstance) {
            initProductPieChart();
        }
        if (state.currentData && state.currentData.details && typeof updateProductPieChart === 'function') {
            updateProductPieChart(state.currentData.details);
        }
    } else if (tabId === 'tab3') {
        // åˆå§‹åŒ–æŸç›Šåˆ†é¡¹æŸ±çŠ¶å›¾
        if (typeof initComponentBarChart === 'function' && !window.componentBarChartInstance) {
            initComponentBarChart();
        }
        if (state.currentData && state.currentData.details && typeof updateComponentBarChart === 'function') {
            updateComponentBarChart(state.currentData.details);
        }
    }
}

// æ›´æ–°TABå†…å®¹
function updateTabs(details) {
    // Tab1: æŒ‰æŠ•ç»„ç»´åº¦è¡¨æ ¼
    updatePortfolioTable(details);
    
    // Tab2: æŒ‰äº§å“åˆ†ç±»é¥¼å›¾ï¼ˆå¦‚æœå½“å‰æ¿€æ´»ï¼‰
    if (document.getElementById('tab2').classList.contains('active')) {
        updateProductPieChart(details);
    }
    
    // Tab3: æŒ‰æŸç›Šåˆ†é¡¹æŸ±çŠ¶å›¾ï¼ˆå¦‚æœå½“å‰æ¿€æ´»ï¼‰
    if (document.getElementById('tab3').classList.contains('active')) {
        updateComponentBarChart(details);
    }
}

// æ›´æ–°æŠ•ç»„ç»´åº¦è¡¨æ ¼
function updatePortfolioTable(details) {
    if (!elements.portfolioTableBody) return;
    
    elements.portfolioTableBody.innerHTML = '';
    
    if (!details || details.length === 0) {
        elements.portfolioTableBody.innerHTML = '<tr><td colspan="9" class="empty-state">æš‚æ— æ•°æ®</td></tr>';
        return;
    }
    
    // è·å–æŸ¥è¯¢æ¡ä»¶ä¸­é€‰ä¸­çš„æŠ•ç»„
    const selectedPortfolio = state.selectedPortfolio;
    
    // æŠ•ç»„å€¼åˆ°æ˜¾ç¤ºåç§°çš„æ˜ å°„
    const portfolioNameMap = {
        'all': 'å…¨æœºæ„',
        'fx_spot': 'å¤–æ±‡å³æœŸæŠ•ç»„',
        'derivative': 'è¡ç”Ÿå“æŠ•ç»„',
        'ir': 'åˆ©ç‡æŠ•ç»„',
        'option': 'æœŸæƒæŠ•ç»„'
    };
    
    // æŠ•ç»„å€¼åˆ°åŒ¹é…å…³é”®è¯çš„æ˜ å°„ï¼ˆç”¨äºåŒ¹é…dimension_valueï¼‰
    const portfolioMatchMap = {
        'all': ['å…¨æœºæ„', 'å…¨éƒ¨', 'all'],
        'fx_spot': ['å¤–æ±‡å³æœŸ', 'å¤–æ±‡å³æœŸæŠ•ç»„', 'fx_spot', 'FX_SPOT', 'fxspot'],
        'derivative': ['è¡ç”Ÿå“', 'è¡ç”Ÿå“æŠ•ç»„', 'derivative', 'DERIVATIVE'],
        'ir': ['åˆ©ç‡', 'åˆ©ç‡æŠ•ç»„', 'ir', 'IR'],
        'option': ['æœŸæƒ', 'æœŸæƒæŠ•ç»„', 'option', 'OPTION']
    };
    
    // å¦‚æœé€‰æ‹©äº†ç‰¹å®šæŠ•ç»„ï¼Œéœ€è¦è¿‡æ»¤æ•°æ®
    // åç«¯å·²ç»æ ¹æ®portfolio_idsè¿‡æ»¤äº†æ•°æ®ï¼Œä½†dimension_valueå¯èƒ½ä¸ç›´æ¥å¯¹åº”
    // æ‰€ä»¥è¿™é‡Œä¸»è¦ç¡®ä¿æ˜¾ç¤ºçš„æ•°æ®ä¸æŸ¥è¯¢æ¡ä»¶ä¸€è‡´
    let filteredDetails = details;
    
    if (selectedPortfolio && selectedPortfolio !== '' && selectedPortfolio !== 'all') {
        // é€‰æ‹©äº†ç‰¹å®šæŠ•ç»„ï¼Œå°è¯•åŒ¹é…dimension_value
        const matchKeywords = portfolioMatchMap[selectedPortfolio] || [];
        filteredDetails = details.filter(detail => {
            const dimensionValue = (detail.dimension_value || '').toLowerCase();
            // æ£€æŸ¥dimension_valueæ˜¯å¦åŒ…å«åŒ¹é…å…³é”®è¯
            return matchKeywords.some(keyword => 
                dimensionValue.includes(keyword.toLowerCase())
            );
        });
        
        // å¦‚æœæ²¡æœ‰åŒ¹é…åˆ°ï¼Œä½†åç«¯è¿”å›äº†æ•°æ®ï¼Œè¯´æ˜åç«¯å·²ç»è¿‡æ»¤äº†ï¼Œç›´æ¥æ˜¾ç¤º
        if (filteredDetails.length === 0 && details.length > 0) {
            // åç«¯å·²ç»è¿‡æ»¤ï¼Œç›´æ¥ä½¿ç”¨åç«¯è¿”å›çš„æ•°æ®
            filteredDetails = details;
        }
    } else if (selectedPortfolio === 'all' || !selectedPortfolio) {
        // é€‰æ‹©äº†"å…¨æœºæ„"æˆ–æœªé€‰æ‹©ï¼Œæ˜¾ç¤ºæ‰€æœ‰æ•°æ®
        filteredDetails = details;
    }
    
    // å¦‚æœæ²¡æœ‰æ•°æ®ï¼Œæ˜¾ç¤ºæç¤º
    if (filteredDetails.length === 0) {
        elements.portfolioTableBody.innerHTML = '<tr><td colspan="9" class="empty-state">å½“å‰æŸ¥è¯¢æ¡ä»¶ä¸‹æš‚æ— æ•°æ®</td></tr>';
        return;
    }
    
    // äº§å“ä»£ç åˆ°æŠ•ç»„çš„æ˜ å°„
    const productToPortfolioMap = {
        // å¤–æ±‡å³æœŸæŠ•ç»„
        'fwd01': 'å¤–æ±‡å³æœŸæŠ•ç»„',
        'fxspot': 'å¤–æ±‡å³æœŸæŠ•ç»„',
        'fx_spot': 'å¤–æ±‡å³æœŸæŠ•ç»„',
        
        // è¡ç”Ÿå“æŠ•ç»„
        'ccs01': 'è¡ç”Ÿå“æŠ•ç»„',
        'ausw01': 'è¡ç”Ÿå“æŠ•ç»„',
        'fxsw01': 'è¡ç”Ÿå“æŠ•ç»„',
        'fxsw02': 'è¡ç”Ÿå“æŠ•ç»„',
        
        // åˆ©ç‡æŠ•ç»„
        'bond01': 'åˆ©ç‡æŠ•ç»„',
        'bond03': 'åˆ©ç‡æŠ•ç»„',
        'cb01': 'åˆ©ç‡æŠ•ç»„',
        'sw01': 'åˆ©ç‡æŠ•ç»„',
        'sw02': 'åˆ©ç‡æŠ•ç»„',
        '5025242': 'åˆ©ç‡æŠ•ç»„',
        'lend01': 'åˆ©ç‡æŠ•ç»„',
        
        // æœŸæƒæŠ•ç»„
        'fxo01': 'æœŸæƒæŠ•ç»„',
        'fxo02': 'æœŸæƒæŠ•ç»„',
        'cpfr01': 'æœŸæƒæŠ•ç»„',
    };
    
    // æŠ•ç»„åç§°æ˜ å°„å‡½æ•°
    const mapPortfolioName = (dimensionValue) => {
        if (!dimensionValue) return 'æœªçŸ¥æŠ•ç»„';
        
        const value = dimensionValue.toLowerCase().trim();
        
        // é¦–å…ˆå°è¯•é€šè¿‡äº§å“ä»£ç ç›´æ¥åŒ¹é…
        if (productToPortfolioMap[value]) {
            return productToPortfolioMap[value];
        }
        
        // å¦‚æœdimension_valueåŒ…å«äº§å“ä»£ç ï¼Œå°è¯•åŒ¹é…
        for (const [productCode, portfolioName] of Object.entries(productToPortfolioMap)) {
            if (value.includes(productCode) || value === productCode) {
                return portfolioName;
            }
        }
        
        // æŒ‰ä¼˜å…ˆçº§åŒ¹é…æŠ•ç»„ï¼ˆé€šè¿‡å…³é”®è¯ï¼‰
        if (value.includes('å¤–æ±‡å³æœŸ') || value.includes('fx_spot') || value.includes('fxspot') || value.includes('fwd01')) {
            return 'å¤–æ±‡å³æœŸæŠ•ç»„';
        } else if (value.includes('è¡ç”Ÿå“') || value.includes('derivative') || value.includes('ccs01') || value.includes('ausw01')) {
            return 'è¡ç”Ÿå“æŠ•ç»„';
        } else if (value.includes('æœŸæƒ') || value.includes('option') || value.includes('fxo01') || value.includes('fxo02') || value.includes('cpfr01')) {
            return 'æœŸæƒæŠ•ç»„';
        } else if (value.includes('åˆ©ç‡') || value.includes('bond01') || value.includes('sw01') || value.includes('5025242') || (value.includes('ir') && !value.includes('æœŸæƒ'))) {
            return 'åˆ©ç‡æŠ•ç»„';
        } else {
            // å¦‚æœæ— æ³•åŒ¹é…ï¼Œå°è¯•é€šè¿‡å…³é”®è¯åŒ¹é…
            for (const [key, keywords] of Object.entries(portfolioMatchMap)) {
                if (key !== 'all' && keywords.some(keyword => value.includes(keyword.toLowerCase()))) {
                    return portfolioNameMap[key] || dimensionValue;
                }
            }
            // é»˜è®¤è¿”å›åŸå§‹å€¼
            return dimensionValue;
        }
    };
    
    // æŒ‰æŠ•ç»„åç§°åˆ†ç»„å¹¶æ±‡æ€»æ•°æ®ï¼ˆå»é‡ï¼‰
    const portfolioMap = new Map();
    
    filteredDetails.forEach(detail => {
        // å°†dimension_valueæ˜ å°„åˆ°æ ‡å‡†æŠ•ç»„æ˜¾ç¤ºåç§°
        const portfolioDisplayName = mapPortfolioName(detail.dimension_value);
        
        // å¦‚æœè¯¥æŠ•ç»„å·²å­˜åœ¨ï¼Œæ±‡æ€»æ•°æ®
        if (portfolioMap.has(portfolioDisplayName)) {
            const existing = portfolioMap.get(portfolioDisplayName);
            existing.pnl_interest += detail.pnl_interest || 0;
            existing.pnl_price_diff += detail.pnl_price_diff || 0;
            existing.pnl_valuation += detail.pnl_valuation || 0;
            existing.pnl_financing += detail.pnl_financing || 0;
            existing.pnl_fee += detail.pnl_fee || 0;
            existing.total_pnl += detail.total_pnl || 0;
            // ä¿å­˜åŸå§‹dimension_valueåˆ—è¡¨ï¼Œç”¨äºæŸ¥çœ‹æ˜ç»†
            if (!existing.originalValues) {
                existing.originalValues = [];
            }
            existing.originalValues.push(detail.dimension_value);
        } else {
            // åˆ›å»ºæ–°çš„æŠ•ç»„æ•°æ®
            portfolioMap.set(portfolioDisplayName, {
                portfolioDisplayName: portfolioDisplayName,
                pnl_interest: detail.pnl_interest || 0,
                pnl_price_diff: detail.pnl_price_diff || 0,
                pnl_valuation: detail.pnl_valuation || 0,
                pnl_financing: detail.pnl_financing || 0,
                pnl_fee: detail.pnl_fee || 0,
                total_pnl: detail.total_pnl || 0,
                originalValues: [detail.dimension_value]
            });
        }
    });
    
    // è®¡ç®—æ€»æŸç›Šï¼Œç”¨äºè®¡ç®—å æ¯”
    const totalPnl = Array.from(portfolioMap.values()).reduce((sum, item) => sum + item.total_pnl, 0);
    
    // æŒ‰æŠ•ç»„åç§°æ’åºå¹¶æ˜¾ç¤º
    const sortedPortfolios = Array.from(portfolioMap.values()).sort((a, b) => {
        // æŒ‰æŠ•ç»„åç§°æ’åº
        const order = ['å¤–æ±‡å³æœŸæŠ•ç»„', 'è¡ç”Ÿå“æŠ•ç»„', 'åˆ©ç‡æŠ•ç»„', 'æœŸæƒæŠ•ç»„'];
        const indexA = order.indexOf(a.portfolioDisplayName);
        const indexB = order.indexOf(b.portfolioDisplayName);
        if (indexA !== -1 && indexB !== -1) return indexA - indexB;
        if (indexA !== -1) return -1;
        if (indexB !== -1) return 1;
        return a.portfolioDisplayName.localeCompare(b.portfolioDisplayName);
    });
    
    sortedPortfolios.forEach(portfolioData => {
        const row = document.createElement('tr');
        // è®¡ç®—å æ¯”
        const percentage = totalPnl !== 0 ? (portfolioData.total_pnl / totalPnl * 100) : 0;
        // è·å–åŸå§‹dimension_valueï¼Œç”¨äºæŸ¥çœ‹æ˜ç»†
        const originalValue = portfolioData.originalValues.join(', ');
        
        row.innerHTML = `
            <td>${portfolioData.portfolioDisplayName}</td>
            <td class="${getNumberClass(portfolioData.pnl_interest)}">${formatNumber(portfolioData.pnl_interest)}</td>
            <td class="${getNumberClass(portfolioData.pnl_price_diff)}">${formatNumber(portfolioData.pnl_price_diff)}</td>
            <td class="${getNumberClass(portfolioData.pnl_valuation)}">${formatNumber(portfolioData.pnl_valuation)}</td>
            <td class="${getNumberClass(portfolioData.pnl_financing)}">${formatNumber(portfolioData.pnl_financing)}</td>
            <td class="${getNumberClass(portfolioData.pnl_fee)}">${formatNumber(portfolioData.pnl_fee)}</td>
            <td class="${getNumberClass(portfolioData.total_pnl)}"><strong>${formatNumber(portfolioData.total_pnl)}</strong></td>
            <td>${percentage.toFixed(2)}%</td>
            <td>
                <button class="action-btn" onclick="showTransactionDetail('${portfolioData.portfolioDisplayName}', '${originalValue}')">æŸ¥çœ‹æ˜ç»†</button>
            </td>
        `;
        elements.portfolioTableBody.appendChild(row);
    });
}

// æ˜¾ç¤ºäº¤æ˜“æ˜ç»†
async function showTransactionDetail(portfolio, originalValues = '') {
    if (!elements.transactionDetailModal) return;
    
    elements.transactionDetailModal.style.display = 'flex';
    
    // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
    elements.transactionDetailContent.innerHTML = `
        <div style="padding: 20px;">
            <h4>æŠ•ç»„: ${portfolio}</h4>
            <p style="margin-top: 16px; color: var(--text-secondary);">äº¤æ˜“æ˜ç»†æ•°æ®åŠ è½½ä¸­...</p>
        </div>
    `;
    
    try {
        // è·å–å½“å‰æŸ¥è¯¢å‚æ•°
        const startDate = elements.startDate.value;
        const endDate = elements.endDate.value;
        
        // è°ƒç”¨APIè·å–äº¤æ˜“æ˜ç»†
        const requestData = {
            start_date: startDate,
            end_date: endDate,
            dimension_type: 'portfolio',
            dimension_value: portfolio,
            portfolio_ids: state.selectedPortfolio && state.selectedPortfolio !== 'all' ? state.selectedPortfolio : null,
            product_codes: null
        };
        
        const response = await api.getTransactionDetails(requestData);
        
        // æ›´æ–°äº¤æ˜“æ˜ç»†è¡¨æ ¼
        updateTransactionTable(response.transactions || [], portfolio);
        
    } catch (error) {
        console.error('Failed to load transaction details:', error);
        elements.transactionDetailContent.innerHTML = `
            <div style="padding: 20px;">
                <h4>æŠ•ç»„: ${portfolio}</h4>
                <p style="margin-top: 16px; color: var(--text-error);">åŠ è½½å¤±è´¥ï¼š${error.message || 'æœªçŸ¥é”™è¯¯'}</p>
            </div>
        `;
    }
}

// æ›´æ–°äº¤æ˜“æ˜ç»†è¡¨æ ¼
function updateTransactionTable(transactions, portfolio) {
    if (!elements.transactionDetailContent) return;
    
    if (!transactions || transactions.length === 0) {
        elements.transactionDetailContent.innerHTML = `
            <div style="padding: 20px;">
                <h4>æŠ•ç»„: ${portfolio}</h4>
                <p style="margin-top: 16px; color: var(--text-secondary);">æš‚æ— äº¤æ˜“æ•°æ®</p>
            </div>
        `;
        return;
    }
    
    // æ„å»ºè¡¨æ ¼HTML
    let tableHTML = `
        <div style="padding: 20px;">
            <h4>æŠ•ç»„: ${portfolio}</h4>
            <p style="margin-top: 8px; color: var(--text-secondary); font-size: 14px;">å…± ${transactions.length} ç¬”äº¤æ˜“</p>
            <div class="table-container" style="margin-top: 16px; max-height: 500px; overflow-y: auto;">
                <table style="width: 100%; border-collapse: collapse;">
                    <thead>
                        <tr style="background-color: var(--bg-secondary); border-bottom: 2px solid var(--border-color);">
                            <th style="padding: 12px; text-align: left; font-weight: 600; color: var(--text-primary);">äº¤æ˜“ID</th>
                            <th style="padding: 12px; text-align: left; font-weight: 600; color: var(--text-primary);">äº¤æ˜“æ—¥æœŸ</th>
                            <th style="padding: 12px; text-align: left; font-weight: 600; color: var(--text-primary);">äº§å“ä»£ç </th>
                            <th style="padding: 12px; text-align: left; font-weight: 600; color: var(--text-primary);">äº§å“åç§°</th>
                            <th style="padding: 12px; text-align: left; font-weight: 600; color: var(--text-primary);">äº¤æ˜“æ–¹å‘</th>
                            <th style="padding: 12px; text-align: right; font-weight: 600; color: var(--text-primary);">åä¹‰æœ¬é‡‘ï¼ˆä¸‡å…ƒï¼‰</th>
                            <th style="padding: 12px; text-align: right; font-weight: 600; color: var(--text-primary);">ä»·æ ¼</th>
                            <th style="padding: 12px; text-align: right; font-weight: 600; color: var(--text-primary);">åˆ©æ¯æŸç›Š</th>
                            <th style="padding: 12px; text-align: right; font-weight: 600; color: var(--text-primary);">ä»·å·®æŸç›Š</th>
                            <th style="padding: 12px; text-align: right; font-weight: 600; color: var(--text-primary);">ä¼°å€¼æŸç›Š</th>
                            <th style="padding: 12px; text-align: right; font-weight: 600; color: var(--text-primary);">èèµ„æˆæœ¬</th>
                            <th style="padding: 12px; text-align: right; font-weight: 600; color: var(--text-primary);">æ‰‹ç»­è´¹</th>
                            <th style="padding: 12px; text-align: right; font-weight: 600; color: var(--text-primary);">æ€»æŸç›Š</th>
                        </tr>
                    </thead>
                    <tbody>
    `;
    
    transactions.forEach(txn => {
        const pnlClass = txn.total_pnl > 0 ? 'positive' : txn.total_pnl < 0 ? 'negative' : '';
        tableHTML += `
            <tr style="border-bottom: 1px solid var(--border-color);">
                <td style="padding: 10px;">${txn.transaction_id}</td>
                <td style="padding: 10px;">${txn.trade_date}</td>
                <td style="padding: 10px;">${txn.product_code}</td>
                <td style="padding: 10px;">${txn.product_name}</td>
                <td style="padding: 10px;">${txn.trade_direction}</td>
                <td style="padding: 10px; text-align: right;">${formatNumber(txn.notional_amount)}</td>
                <td style="padding: 10px; text-align: right;">${txn.price ? formatNumber(txn.price, 4) : '--'}</td>
                <td style="padding: 10px; text-align: right; ${getNumberClass(txn.pnl_interest)}">${formatNumber(txn.pnl_interest)}</td>
                <td style="padding: 10px; text-align: right; ${getNumberClass(txn.pnl_price_diff)}">${formatNumber(txn.pnl_price_diff)}</td>
                <td style="padding: 10px; text-align: right; ${getNumberClass(txn.pnl_valuation)}">${formatNumber(txn.pnl_valuation)}</td>
                <td style="padding: 10px; text-align: right; ${getNumberClass(txn.pnl_financing)}">${formatNumber(txn.pnl_financing)}</td>
                <td style="padding: 10px; text-align: right; ${getNumberClass(txn.pnl_fee)}">${formatNumber(txn.pnl_fee)}</td>
                <td style="padding: 10px; text-align: right; ${pnlClass}"><strong>${formatNumber(txn.total_pnl)}</strong></td>
            </tr>
        `;
    });
    
    tableHTML += `
                    </tbody>
                </table>
            </div>
        </div>
    `;
    
    elements.transactionDetailContent.innerHTML = tableHTML;
}

// å…³é—­äº¤æ˜“æ˜ç»†æ¨¡æ€æ¡†
function closeTransactionModal() {
    if (elements.transactionDetailModal) {
        elements.transactionDetailModal.style.display = 'none';
    }
}

// å°†å‡½æ•°æš´éœ²åˆ°å…¨å±€ï¼Œä¾›onclickä½¿ç”¨
window.showTransactionDetail = showTransactionDetail;

// æ˜¾ç¤ºäº§å“æ˜ç»†
async function showProductDetail(productName) {
    if (!elements.transactionDetailModal) return;
    
    // æ˜¾ç¤ºæ¨¡æ€æ¡†
    elements.transactionDetailModal.style.display = 'flex';
    
    // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
    elements.transactionDetailContent.innerHTML = `
        <div style="padding: 20px;">
            <h4>äº§å“: ${productName}</h4>
            <p style="margin-top: 16px; color: var(--text-secondary);">äº¤æ˜“æ˜ç»†æ•°æ®åŠ è½½ä¸­...</p>
        </div>
    `;
    
    try {
        // ä»å½“å‰æ•°æ®ä¸­è·å–è¯¥äº§å“å¯¹åº”çš„äº§å“ä»£ç 
        if (!state.currentData || !state.currentData.details) {
            throw new Error('æš‚æ— æ•°æ®');
        }
        
        // äº§å“åç§°åˆ°äº§å“ä»£ç çš„åå‘æ˜ å°„ï¼ˆä¸åç«¯ä¿æŒä¸€è‡´ï¼‰
        const productNameToCodesMap = {
            'å¤–æ±‡å³æœŸ': ['FXSPOT', 'fxspot', 'fx_spot', 'fxspot01'],
            'å¤–æ±‡è¿œæœŸ': ['FWD', 'FWD01', 'fwd01', 'fwd02'],
            'å¤–æ±‡æ‰æœŸ': ['FXSW', 'fxsw01', 'fxsw02'],
            'å¤–æ±‡æœŸæƒ': ['FXOPT', 'FXO', 'fxo01', 'fxo02', 'fxopt'],
            'CCS': ['CCS', 'ccs01'],
            'IRS': ['IRS', 'SW01', 'SW02', 'sw01', 'sw02']
        };
        
        // è·å–è¯¥äº§å“å¯¹åº”çš„æ‰€æœ‰å¯èƒ½çš„äº§å“ä»£ç 
        const productCodes = productNameToCodesMap[productName] || [productName];
        
        // ä»detailsä¸­æŸ¥æ‰¾åŒ¹é…çš„äº§å“ä»£ç 
        let matchedProductCode = null;
        for (const detail of state.currentData.details) {
            const detailValue = detail.dimension_value || '';
            for (const code of productCodes) {
                // ä¸åŒºåˆ†å¤§å°å†™åŒ¹é…
                if (detailValue.toUpperCase() === code.toUpperCase() || 
                    detailValue.toUpperCase().includes(code.toUpperCase()) ||
                    code.toUpperCase().includes(detailValue.toUpperCase())) {
                    matchedProductCode = detail.dimension_value;
                    break;
                }
            }
            if (matchedProductCode) break;
        }
        
        // å¦‚æœæ²¡æ‰¾åˆ°ï¼Œä½¿ç”¨ç¬¬ä¸€ä¸ªäº§å“ä»£ç ä½œä¸ºé»˜è®¤å€¼
        if (!matchedProductCode && productCodes.length > 0) {
            matchedProductCode = productCodes[0];
        }
        
        // è·å–å½“å‰æŸ¥è¯¢å‚æ•°
        const startDate = elements.startDate.value;
        const endDate = elements.endDate.value;
        
        // è°ƒç”¨APIè·å–äº¤æ˜“æ˜ç»†
        const requestData = {
            start_date: startDate,
            end_date: endDate,
            dimension_type: 'product',
            dimension_value: matchedProductCode || productName,
            portfolio_ids: state.selectedPortfolio && state.selectedPortfolio !== 'all' ? state.selectedPortfolio : null,
            product_codes: matchedProductCode || productCodes[0] || productName
        };
        
        console.log('Fetching product transaction details:', requestData);
        
        const response = await api.getTransactionDetails(requestData);
        
        // æ›´æ–°äº¤æ˜“æ˜ç»†è¡¨æ ¼ï¼ˆä½¿ç”¨ç›¸åŒçš„å‡½æ•°ï¼Œä½†æ ‡é¢˜æ”¹ä¸ºäº§å“åç§°ï¼‰
        updateProductTransactionTable(response.transactions || [], productName);
        
    } catch (error) {
        console.error('Failed to load product transaction details:', error);
        elements.transactionDetailContent.innerHTML = `
            <div style="padding: 20px;">
                <h4>äº§å“: ${productName}</h4>
                <p style="margin-top: 16px; color: var(--danger);">åŠ è½½å¤±è´¥ï¼š${error.message || 'æœªçŸ¥é”™è¯¯'}</p>
            </div>
        `;
    }
}

// æ›´æ–°äº§å“äº¤æ˜“æ˜ç»†è¡¨æ ¼
function updateProductTransactionTable(transactions, productName) {
    if (!elements.transactionDetailContent) return;
    
    if (!transactions || transactions.length === 0) {
        elements.transactionDetailContent.innerHTML = `
            <div style="padding: 20px;">
                <h4>äº§å“: ${productName}</h4>
                <p style="margin-top: 16px; color: var(--text-secondary);">æš‚æ— äº¤æ˜“æ•°æ®</p>
            </div>
        `;
        return;
    }
    
    // æ„å»ºè¡¨æ ¼HTMLï¼ˆä¸updateTransactionTableç›¸åŒï¼‰
    let tableHTML = `
        <div style="padding: 20px;">
            <h4>äº§å“: ${productName}</h4>
            <p style="margin-top: 8px; color: var(--text-secondary); font-size: 14px;">å…± ${transactions.length} ç¬”äº¤æ˜“</p>
            <div class="table-container" style="margin-top: 16px; max-height: 500px; overflow-y: auto;">
                <table style="width: 100%; border-collapse: collapse;">
                    <thead>
                        <tr style="background-color: var(--bg-secondary); border-bottom: 2px solid var(--border-color);">
                            <th style="padding: 12px; text-align: left; font-weight: 600; color: var(--text-primary);">äº¤æ˜“ID</th>
                            <th style="padding: 12px; text-align: left; font-weight: 600; color: var(--text-primary);">äº¤æ˜“æ—¥æœŸ</th>
                            <th style="padding: 12px; text-align: left; font-weight: 600; color: var(--text-primary);">äº§å“ä»£ç </th>
                            <th style="padding: 12px; text-align: left; font-weight: 600; color: var(--text-primary);">äº§å“åç§°</th>
                            <th style="padding: 12px; text-align: left; font-weight: 600; color: var(--text-primary);">äº¤æ˜“æ–¹å‘</th>
                            <th style="padding: 12px; text-align: right; font-weight: 600; color: var(--text-primary);">åä¹‰æœ¬é‡‘ï¼ˆä¸‡å…ƒï¼‰</th>
                            <th style="padding: 12px; text-align: right; font-weight: 600; color: var(--text-primary);">ä»·æ ¼</th>
                            <th style="padding: 12px; text-align: right; font-weight: 600; color: var(--text-primary);">åˆ©æ¯æŸç›Š</th>
                            <th style="padding: 12px; text-align: right; font-weight: 600; color: var(--text-primary);">ä»·å·®æŸç›Š</th>
                            <th style="padding: 12px; text-align: right; font-weight: 600; color: var(--text-primary);">ä¼°å€¼æŸç›Š</th>
                            <th style="padding: 12px; text-align: right; font-weight: 600; color: var(--text-primary);">èèµ„æˆæœ¬</th>
                            <th style="padding: 12px; text-align: right; font-weight: 600; color: var(--text-primary);">æ‰‹ç»­è´¹</th>
                            <th style="padding: 12px; text-align: right; font-weight: 600; color: var(--text-primary);">æ€»æŸç›Š</th>
                        </tr>
                    </thead>
                    <tbody>
    `;
    
    transactions.forEach(txn => {
        const pnlClass = txn.total_pnl > 0 ? 'positive' : txn.total_pnl < 0 ? 'negative' : '';
        tableHTML += `
            <tr style="border-bottom: 1px solid var(--border-color);">
                <td style="padding: 10px;">${txn.transaction_id}</td>
                <td style="padding: 10px;">${txn.trade_date}</td>
                <td style="padding: 10px;">${txn.product_code}</td>
                <td style="padding: 10px;">${txn.product_name}</td>
                <td style="padding: 10px;">${txn.trade_direction}</td>
                <td style="padding: 10px; text-align: right;">${formatNumber(txn.notional_amount)}</td>
                <td style="padding: 10px; text-align: right;">${txn.price ? txn.price.toLocaleString('zh-CN', { minimumFractionDigits: 4, maximumFractionDigits: 4 }) : '--'}</td>
                <td style="padding: 10px; text-align: right; ${getNumberClass(txn.pnl_interest)}">${formatNumber(txn.pnl_interest)}</td>
                <td style="padding: 10px; text-align: right; ${getNumberClass(txn.pnl_price_diff)}">${formatNumber(txn.pnl_price_diff)}</td>
                <td style="padding: 10px; text-align: right; ${getNumberClass(txn.pnl_valuation)}">${formatNumber(txn.pnl_valuation)}</td>
                <td style="padding: 10px; text-align: right; ${getNumberClass(txn.pnl_financing)}">${formatNumber(txn.pnl_financing)}</td>
                <td style="padding: 10px; text-align: right; ${getNumberClass(txn.pnl_fee)}">${formatNumber(txn.pnl_fee)}</td>
                <td style="padding: 10px; text-align: right; ${pnlClass}"><strong>${formatNumber(txn.total_pnl)}</strong></td>
            </tr>
        `;
    });
    
    tableHTML += `
                    </tbody>
                </table>
            </div>
        </div>
    `;
    
    elements.transactionDetailContent.innerHTML = tableHTML;
}

// å°†å‡½æ•°æš´éœ²åˆ°å…¨å±€
window.showProductDetail = showProductDetail;

// æ˜¾ç¤ºé”™è¯¯
function showError(message) {
    alert(message);
}

// å·¥å…·å‡½æ•°
function formatNumber(num) {
    return num.toLocaleString('zh-CN', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
}

function getNumberClass(num) {
    if (num > 0) return 'positive';
    if (num < 0) return 'negative';
    return 'neutral';
}

// æ›´æ–°æ—¶é—´æ˜¾ç¤º
function updateWidgetTimes() {
    const now = new Date();
    const timeStr = now.toLocaleTimeString('zh-CN', { hour12: false });
    document.querySelectorAll('.widget-time').forEach(el => {
        el.textContent = timeStr;
    });
}

// é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
document.addEventListener('DOMContentLoaded', () => {
    init();
    // æ¯ç§’æ›´æ–°æ—¶é—´
    setInterval(updateWidgetTimes, 1000);
    updateWidgetTimes();
});






    </script>
    <script>
/**
 * å›¾è¡¨æ¸²æŸ“æ¨¡å—
 */

let barChartInstance = null;
let pieChartInstance = null;
let trendChartInstance = null;
let productPieChartInstance = null;
let componentBarChartInstance = null;

// åˆå§‹åŒ–å›¾è¡¨
function initCharts() {
    // æŸç›Šå˜åŠ¨è¶‹åŠ¿å›¾
    initTrendChart();
    // æŸ±çŠ¶å›¾å’Œé¥¼å›¾å·²ç§»é™¤ï¼Œä¸å†åˆå§‹åŒ–
}

// åˆå§‹åŒ–è¶‹åŠ¿å›¾
function initTrendChart() {
    const ctx = document.getElementById('trendChart');
    if (!ctx) {
        console.warn('Trend chart canvas not found');
        return;
    }
    
    // å¦‚æœå·²ç»åˆå§‹åŒ–ï¼Œå…ˆé”€æ¯
    if (trendChartInstance) {
        try {
            trendChartInstance.destroy();
        } catch (e) {
            console.warn('Error destroying existing chart instance:', e);
        }
        trendChartInstance = null;
    }
    
    // æ£€æŸ¥Chart.jsæ˜¯å¦å·²åŠ è½½
    if (typeof Chart === 'undefined') {
        console.error('Chart.js library not loaded');
        return;
    }
    
    console.log('Initializing trend chart');
    trendChartInstance = new Chart(ctx, {
        type: 'line',
        data: {
            labels: [],
            datasets: []
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: true,
                    position: 'top',
                    labels: {
                        color: '#262626',
                        padding: 15,
                        font: {
                            size: 12
                        },
                        usePointStyle: true
                    }
                },
                tooltip: {
                    backgroundColor: 'rgba(255, 255, 255, 0.95)',
                    titleColor: '#262626',
                    bodyColor: '#595959',
                    borderColor: '#e8e8e8',
                    borderWidth: 1,
                    padding: 12,
                    mode: 'index',
                    intersect: false,
                    callbacks: {
                        label: function(context) {
                            return context.dataset.label + ': ' + 
                                   context.parsed.y.toLocaleString('zh-CN', { 
                                       minimumFractionDigits: 2, 
                                       maximumFractionDigits: 2 
                                   }) + 'ä¸‡å…ƒ';
                        }
                    }
                }
            },
            scales: {
                x: {
                    title: {
                        display: true,
                        text: 'æ—¥æœŸ',
                        color: '#595959',
                        font: {
                            size: 12
                        }
                    },
                    ticks: {
                        color: '#8c8c8c',
                        maxRotation: 45,
                        minRotation: 0,
                        autoSkip: true,
                        maxTicksLimit: 20,  // æœ€å¤šæ˜¾ç¤º20ä¸ªæ ‡ç­¾
                        callback: function(value, index) {
                            // æ˜¾ç¤ºæ—¥æœŸæ ‡ç­¾
                            if (trendChartInstance && trendChartInstance.data.labels && trendChartInstance.data.labels[index]) {
                                return trendChartInstance.data.labels[index];
                            }
                            return value;
                        }
                    },
                    grid: {
                        color: '#f0f0f0',
                        drawBorder: false
                    }
                },
                y: {
                    title: {
                        display: true,
                        text: 'é‡‘é¢ï¼ˆä¸‡å…ƒï¼‰',
                        color: '#595959',
                        font: {
                            size: 12
                        }
                    },
                    beginAtZero: false,
                    ticks: {
                        color: '#8c8c8c',
                        callback: function(value) {
                            return value.toLocaleString('zh-CN', { 
                                minimumFractionDigits: 2, 
                                maximumFractionDigits: 2 
                            });
                        }
                    },
                    grid: {
                        color: '#f0f0f0',
                        drawBorder: false
                    }
                }
            },
            interaction: {
                intersect: false,
                mode: 'index'
            }
        }
    });
    
    // ä¿å­˜åˆ°å…¨å±€ï¼Œæ–¹ä¾¿è°ƒè¯•
    window.trendChartInstance = trendChartInstance;
    console.log('Trend chart initialized successfully');
}

// åˆå§‹åŒ–æŸ±çŠ¶å›¾
function initBarChart() {
    const ctx = document.getElementById('barChart');
    if (!ctx) return;
    
    barChartInstance = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: [],
            datasets: [{
                label: 'æŸç›Šé‡‘é¢',
                data: [],
                backgroundColor: [
                    '#4a90e2',
                    '#6c5ce7',
                    '#a29bfe',
                    '#74b9ff',
                    '#00b894',
                    '#00cec9',
                    '#fdcb6e',
                    '#e17055'
                ]
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: true,
            plugins: {
                legend: {
                    display: false
                },
                tooltip: {
                    backgroundColor: 'rgba(45, 45, 45, 0.95)',
                    titleColor: '#ffffff',
                    bodyColor: '#e0e0e0',
                    borderColor: '#404040',
                    borderWidth: 1,
                    callbacks: {
                        label: function(context) {
                            return `é‡‘é¢: ${context.parsed.y.toFixed(2)}ä¸‡å…ƒ`;
                        }
                    }
                }
            },
            scales: {
                x: {
                    ticks: {
                        color: '#b0b0b0'
                    },
                    grid: {
                        color: '#404040'
                    }
                },
                y: {
                    beginAtZero: true,
                    ticks: {
                        color: '#b0b0b0',
                        callback: function(value) {
                            return value.toFixed(2) + 'ä¸‡';
                        }
                    },
                    grid: {
                        color: '#404040'
                    }
                }
            }
        }
    });
}

// åˆå§‹åŒ–é¥¼å›¾
function initPieChart() {
    const ctx = document.getElementById('pieChart');
    if (!ctx) return;
    
    pieChartInstance = new Chart(ctx, {
        type: 'pie',
        data: {
            labels: [],
            datasets: [{
                data: [],
                backgroundColor: [
                    '#4a90e2',
                    '#6c5ce7',
                    '#a29bfe',
                    '#74b9ff',
                    '#00b894',
                    '#00cec9',
                    '#fdcb6e',
                    '#e17055'
                ]
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: true,
            plugins: {
                legend: {
                    position: 'bottom',
                    labels: {
                        color: '#b0b0b0',
                        padding: 15,
                        font: {
                            size: 12
                        }
                    }
                },
                tooltip: {
                    backgroundColor: 'rgba(45, 45, 45, 0.95)',
                    titleColor: '#ffffff',
                    bodyColor: '#e0e0e0',
                    borderColor: '#404040',
                    borderWidth: 1,
                    callbacks: {
                        label: function(context) {
                            const label = context.label || '';
                            const value = context.parsed || 0;
                            const total = context.dataset.data.reduce((a, b) => a + b, 0);
                            const percentage = ((value / total) * 100).toFixed(2);
                            return `${label}: ${value.toFixed(2)}ä¸‡å…ƒ (${percentage}%)`;
                        }
                    }
                }
            }
        }
    });
}


// æ›´æ–°æŸ±çŠ¶å›¾
function updateBarChart(pnlData) {
    if (!barChartInstance || !pnlData) return;
    
    const details = pnlData.details || [];
    const labels = details.map(item => item.dimension_value);
    const data = details.map(item => item.total_pnl);
    
    barChartInstance.data.labels = labels;
    barChartInstance.data.datasets[0].data = data;
    barChartInstance.update();
}

// æ›´æ–°é¥¼å›¾
function updatePieChart(pnlData) {
    if (!pieChartInstance || !pnlData) return;
    
    const details = pnlData.details || [];
    const labels = details.map(item => item.dimension_value);
    const data = details.map(item => item.total_pnl);
    
    // è¿‡æ»¤æ‰å€¼ä¸º0çš„é¡¹ç›®
    const filteredLabels = [];
    const filteredData = [];
    labels.forEach((label, index) => {
        if (data[index] !== 0) {
            filteredLabels.push(label);
            filteredData.push(data[index]);
        }
    });
    
    pieChartInstance.data.labels = filteredLabels;
    pieChartInstance.data.datasets[0].data = filteredData;
    pieChartInstance.update();
}

// æ›´æ–°è¶‹åŠ¿å›¾
function updateTrendChart(trendData) {
    console.log('updateTrendChart called with data:', trendData);
    
    // å¦‚æœå›¾è¡¨æœªåˆå§‹åŒ–ï¼Œå°è¯•åˆå§‹åŒ–
    if (!trendChartInstance) {
        console.warn('Trend chart instance not initialized, trying to initialize...');
        const ctx = document.getElementById('trendChart');
        if (ctx) {
            console.log('Trend chart canvas found, initializing...');
            initTrendChart();
        } else {
            console.error('Trend chart canvas element not found');
            // å»¶è¿Ÿé‡è¯•
            setTimeout(() => {
                const retryCtx = document.getElementById('trendChart');
                if (retryCtx) {
                    console.log('Retrying trend chart initialization...');
                    initTrendChart();
                    if (trendChartInstance && trendData) {
                        updateTrendChart(trendData);
                    }
                }
            }, 500);
            return;
        }
    }
    
    if (!trendChartInstance) {
        console.error('Failed to initialize trend chart');
        return;
    }
    
    console.log('Updating trend chart with data:', trendData);
    console.log('Trend data type:', typeof trendData);
    console.log('Trend data is array:', Array.isArray(trendData));
    console.log('Trend data length:', trendData ? trendData.length : 'null/undefined');
    
    if (!trendData || trendData.length === 0) {
        console.warn('Trend data is empty or null');
        if (trendChartInstance) {
            trendChartInstance.data.labels = [];
            trendChartInstance.data.datasets = [];
            trendChartInstance.update();
        }
        return;
    }
    
    // æå–æ—¥æœŸæ ‡ç­¾
    const labels = [];
    
    trendData.forEach(item => {
        if (item.date) {
            const date = new Date(item.date);
            if (!isNaN(date.getTime())) {
                // æ ¼å¼åŒ–æ—¥æœŸæ˜¾ç¤ºï¼šYYYY-MM-DDï¼ˆæŒ‰å¤©ç»´åº¦æ˜¾ç¤ºå®Œæ•´æ—¥æœŸï¼‰
                const year = date.getFullYear();
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const day = String(date.getDate()).padStart(2, '0');
                labels.push(`${year}-${month}-${day}`);
            }
        }
    });
    
    console.log('Trend chart labels:', labels);
    console.log('Trend chart data count:', trendData.length);
    
    if (labels.length === 0 || trendData.length === 0) {
        console.warn('No valid trend data to display');
        trendChartInstance.data.labels = [];
        trendChartInstance.data.datasets = [];
        trendChartInstance.update();
        return;
    }
    
    // æå–å„åˆ†é¡¹æ•°æ®
    const totalPnlData = [];
    const interestData = [];
    const priceDiffData = [];
    const valuationData = [];
    const feeData = [];
    
    trendData.forEach(item => {
        if (item.date) {
            const date = new Date(item.date);
            if (!isNaN(date.getTime())) {
                // ä¼˜å…ˆä½¿ç”¨ total_pnlï¼Œå¦‚æœæ²¡æœ‰åˆ™ä½¿ç”¨ pnlï¼Œç¡®ä¿æœ‰å€¼
                const totalPnl = (item.total_pnl !== undefined && item.total_pnl !== null) 
                    ? item.total_pnl 
                    : ((item.pnl !== undefined && item.pnl !== null) ? item.pnl : 0);
                totalPnlData.push(Number(totalPnl) || 0);
                
                // å„åˆ†é¡¹æ•°æ®ï¼Œå¦‚æœæ²¡æœ‰åˆ™é»˜è®¤ä¸º0ï¼Œç¡®ä¿è½¬æ¢ä¸ºæ•°å­—
                interestData.push(Number(item.pnl_interest) || 0);
                priceDiffData.push(Number(item.pnl_price_diff) || 0);
                valuationData.push(Number(item.pnl_valuation) || 0);
                feeData.push(Number(item.pnl_fee) || 0);
            }
        }
    });
    
    console.log('Extracted trend data:', {
        labelsCount: labels.length,
        totalPnlCount: totalPnlData.length,
        totalPnl: totalPnlData.slice(0, 3),
        interest: interestData.slice(0, 3),
        priceDiff: priceDiffData.slice(0, 3),
        valuation: valuationData.slice(0, 3),
        fee: feeData.slice(0, 3)
    });
    
    // ç¡®ä¿labelså’Œdataé•¿åº¦ä¸€è‡´
    if (labels.length !== totalPnlData.length) {
        console.warn('Labels and data length mismatch:', {
            labelsLength: labels.length,
            dataLength: totalPnlData.length
        });
        // å¦‚æœé•¿åº¦ä¸ä¸€è‡´ï¼Œä½¿ç”¨è¾ƒå°çš„é•¿åº¦
        const minLength = Math.min(labels.length, totalPnlData.length);
        labels.splice(minLength);
        totalPnlData.splice(minLength);
        interestData.splice(minLength);
        priceDiffData.splice(minLength);
        valuationData.splice(minLength);
        feeData.splice(minLength);
    }
    
    if (labels.length === 0) {
        console.warn('No labels to display after processing');
        return;
    }
    
    // éªŒè¯æ•°æ®é•¿åº¦
    if (totalPnlData.length !== labels.length) {
        console.error('Data length mismatch:', {
            labels: labels.length,
            totalPnl: totalPnlData.length,
            interest: interestData.length,
            priceDiff: priceDiffData.length,
            valuation: valuationData.length,
            fee: feeData.length
        });
    }
    
    console.log('Setting chart data with', labels.length, 'data points');
    if (labels.length > 0 && totalPnlData.length > 0) {
        console.log('Sample data:', {
            label: labels[0],
            totalPnl: totalPnlData[0],
            interest: interestData[0],
            priceDiff: priceDiffData[0],
            valuation: valuationData[0],
            fee: feeData[0]
        });
    }
    
    trendChartInstance.data.labels = labels;
    // åªæ˜¾ç¤ºæ€»ç´¯è®¡æŸç›Šçš„æ³¢åŠ¨æƒ…å†µ
    trendChartInstance.data.datasets = [
        {
            label: 'ç´¯è®¡æŸç›Šæ€»é¢',
            data: totalPnlData,
            borderColor: '#667eea',
            backgroundColor: 'rgba(102, 126, 234, 0.1)',
            borderWidth: 3,
            fill: true,
            tension: 0.4,
            pointRadius: labels.length > 100 ? 2 : (labels.length > 50 ? 3 : 4),
            pointHoverRadius: 6,
            pointBackgroundColor: '#667eea',
            pointBorderColor: '#ffffff',
            pointBorderWidth: 2,
            pointHitRadius: 10
        },
        {
            label: 'åˆ©æ¯æŸç›Š',
            data: interestData,
            borderColor: '#52c41a',
            backgroundColor: 'rgba(82, 196, 26, 0.1)',
            borderWidth: 2,
            fill: false,
            tension: 0.4,
            pointRadius: labels.length > 100 ? 1 : (labels.length > 50 ? 2 : 3),
            pointHoverRadius: 5,
            pointBackgroundColor: '#52c41a',
            pointBorderColor: '#ffffff',
            pointBorderWidth: 2
        },
        {
            label: 'ä»·å·®æŸç›Š',
            data: priceDiffData,
            borderColor: '#ff4d4f',
            backgroundColor: 'rgba(255, 77, 79, 0.1)',
            borderWidth: 2,
            fill: false,
            tension: 0.4,
            pointRadius: labels.length > 100 ? 1 : (labels.length > 50 ? 2 : 3),
            pointHoverRadius: 5,
            pointBackgroundColor: '#ff4d4f',
            pointBorderColor: '#ffffff',
            pointBorderWidth: 2
        },
        {
            label: 'ä¼°å€¼æŸç›Š',
            data: valuationData,
            borderColor: '#1890ff',
            backgroundColor: 'rgba(24, 144, 255, 0.1)',
            borderWidth: 2,
            fill: false,
            tension: 0.4,
            pointRadius: labels.length > 100 ? 1 : (labels.length > 50 ? 2 : 3),
            pointHoverRadius: 5,
            pointBackgroundColor: '#1890ff',
            pointBorderColor: '#ffffff',
            pointBorderWidth: 2
        },
        {
            label: 'æ‰‹ç»­è´¹æŸç›Š',
            data: feeData,
            borderColor: '#faad14',
            backgroundColor: 'rgba(250, 173, 20, 0.1)',
            borderWidth: 2,
            fill: false,
            tension: 0.4,
            pointRadius: labels.length > 100 ? 1 : (labels.length > 50 ? 2 : 3),
            pointHoverRadius: 5,
            pointBackgroundColor: '#faad14',
            pointBorderColor: '#ffffff',
            pointBorderWidth: 2
        }
    ];
    
    console.log('Chart data set, updating chart...');
    try {
        trendChartInstance.update();
        console.log('Chart updated successfully');
    } catch (error) {
        console.error('Error updating chart:', error);
        alert('æ›´æ–°è¶‹åŠ¿å›¾å¤±è´¥ï¼š' + (error.message || 'æœªçŸ¥é”™è¯¯'));
    }
}

// æ›´æ–°æ‰€æœ‰å›¾è¡¨
function updateCharts(pnlData, trendData) {
    console.log('updateCharts called with trendData:', trendData);
    console.log('Trend data type:', typeof trendData);
    console.log('Trend data is array:', Array.isArray(trendData));
    if (trendData) {
        console.log('Trend data length:', trendData.length);
        if (trendData.length > 0) {
            console.log('First trend data item:', trendData[0]);
        }
    }
    updateTrendChart(trendData);
    // æŸ±çŠ¶å›¾å’Œé¥¼å›¾å·²ç§»é™¤ï¼Œä¸å†æ›´æ–°
}

// æ¸…ç©ºå›¾è¡¨
function clearCharts() {
    if (trendChartInstance) {
        trendChartInstance.data.labels = [];
        trendChartInstance.data.datasets = [];
        trendChartInstance.update();
    }
    // æŸ±çŠ¶å›¾å’Œé¥¼å›¾å·²ç§»é™¤ï¼Œä¸å†æ¸…é™¤
}

// åˆå§‹åŒ–äº§å“åˆ†ç±»é¥¼å›¾
function initProductPieChart() {
    const ctx = document.getElementById('productPieChart');
    if (!ctx) return;
    
    console.log('Initializing product pie chart');
    productPieChartInstance = new Chart(ctx, {
        type: 'pie',
        data: {
            labels: [],
            datasets: [{
                data: [],
                backgroundColor: [
                    '#4a90e2',
                    '#6c5ce7',
                    '#a29bfe',
                    '#74b9ff',
                    '#00b894',
                    '#00cec9',
                    '#fdcb6e',
                    '#e17055',
                    '#fd79a8',
                    '#fdcb6e'
                ]
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: true,
            cutout: '60%', // ç”œç”œåœˆå›¾æ ·å¼
            plugins: {
                legend: {
                    display: true,
                    position: 'bottom',
                    labels: {
                        color: '#262626',
                        padding: 15,
                        font: {
                            size: 12
                        },
                        usePointStyle: true
                    }
                },
                tooltip: {
                    backgroundColor: 'rgba(255, 255, 255, 0.95)',
                    titleColor: '#262626',
                    bodyColor: '#595959',
                    borderColor: '#e8e8e8',
                    borderWidth: 1,
                    padding: 12,
                    callbacks: {
                        label: function(context) {
                            // ä»æ ‡ç­¾ä¸­æå–åŸå§‹äº§å“åç§°ï¼ˆå»æ‰å æ¯”ï¼‰
                            const fullLabel = context.label || '';
                            const label = fullLabel.split(' (')[0]; // å»æ‰å æ¯”éƒ¨åˆ†
                            const value = context.parsed || 0;
                            const total = context.dataset.data.reduce((a, b) => a + b, 0);
                            const percentage = total > 0 ? ((value / total) * 100).toFixed(2) : '0.00';
                            return `${label}: ${value.toLocaleString('zh-CN', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}ä¸‡å…ƒ (${percentage}%)`;
                        }
                    }
                }
            }
        }
    });
    
    // ä¿å­˜åˆ°å…¨å±€
    window.productPieChartInstance = productPieChartInstance;
    console.log('Product pie chart initialized successfully');
}

// åˆå§‹åŒ–æŸç›Šåˆ†é¡¹æŸ±çŠ¶å›¾
function initComponentBarChart() {
    const ctx = document.getElementById('componentBarChart');
    if (!ctx) return;
    
    console.log('Initializing component bar chart');
    componentBarChartInstance = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: [],
            datasets: [{
                label: 'æŸç›Šé‡‘é¢ï¼ˆä¸‡å…ƒï¼‰',
                data: [],
                backgroundColor: [
                    '#52c41a',  // åˆ©æ¯æŸç›Š - ç»¿è‰²
                    '#ff4d4f',  // ä»·å·®æŸç›Š - çº¢è‰²
                    '#1890ff',  // ä¼°å€¼æŸç›Š - è“è‰²
                    '#faad14',  // èèµ„æˆæœ¬ - æ©™è‰²
                    '#722ed1'   // æ‰‹ç»­è´¹ - ç´«è‰²
                ]
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false
                },
                tooltip: {
                    backgroundColor: 'rgba(255, 255, 255, 0.95)',
                    titleColor: '#262626',
                    bodyColor: '#595959',
                    borderColor: '#e8e8e8',
                    borderWidth: 1,
                    padding: 12,
                    callbacks: {
                        label: function(context) {
                            // è¿™ä¸ªä¼šåœ¨updateComponentBarChartä¸­è¢«åŠ¨æ€è®¾ç½®
                            return `é‡‘é¢: ${context.parsed.y.toLocaleString('zh-CN', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}ä¸‡å…ƒ`;
                        }
                    }
                }
            },
            scales: {
                x: {
                    title: {
                        display: true,
                        text: 'æŸç›Šåˆ†é¡¹',
                        color: '#595959',
                        font: {
                            size: 12
                        }
                    },
                    ticks: {
                        color: '#8c8c8c',
                        maxRotation: 45,
                        minRotation: 0
                    },
                    grid: {
                        color: '#f0f0f0',
                        drawBorder: false
                    }
                },
                y: {
                    title: {
                        display: true,
                        text: 'é‡‘é¢ï¼ˆä¸‡å…ƒï¼‰',
                        color: '#595959',
                        font: {
                            size: 12
                        }
                    },
                    beginAtZero: true,
                    ticks: {
                        color: '#8c8c8c',
                        callback: function(value) {
                            return value.toLocaleString('zh-CN', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
                        }
                    },
                    grid: {
                        color: '#f0f0f0',
                        drawBorder: false
                    }
                }
            },
            plugins: {
                datalabels: {
                    display: false // é»˜è®¤ä¸æ˜¾ç¤ºï¼Œæˆ‘ä»¬ä¼šåœ¨æ›´æ–°æ—¶åŠ¨æ€è®¾ç½®
                }
            }
        }
    });
    
    // ä¿å­˜åˆ°å…¨å±€
    window.componentBarChartInstance = componentBarChartInstance;
    console.log('Component bar chart initialized successfully');
}

// äº§å“ä»£ç åˆ°æ ‡å‡†äº§å“åç§°çš„æ˜ å°„
const productCodeToNameMap = {
    // å¤–æ±‡å³æœŸ
    'fxspot': 'å¤–æ±‡å³æœŸ',
    'fx_spot': 'å¤–æ±‡å³æœŸ',
    'fxspot01': 'å¤–æ±‡å³æœŸ',
    
    // å¤–æ±‡è¿œæœŸ
    'fwd01': 'å¤–æ±‡è¿œæœŸ',
    'fwd02': 'å¤–æ±‡è¿œæœŸ',
    
    // å¤–æ±‡æ‰æœŸ
    'fxsw01': 'å¤–æ±‡æ‰æœŸ',
    'fxsw02': 'å¤–æ±‡æ‰æœŸ',
    
    // å¤–æ±‡æœŸæƒ
    'fxo01': 'å¤–æ±‡æœŸæƒ',
    'fxo02': 'å¤–æ±‡æœŸæƒ',
    'fxopt': 'å¤–æ±‡æœŸæƒ',
    
    // CCSï¼ˆè´§å¸æ‰æœŸï¼‰
    'ccs01': 'CCS',
    
    // IRSï¼ˆåˆ©ç‡äº’æ¢ï¼‰
    'sw01': 'IRS',
    'sw02': 'IRS',
};

// äº§å“åç§°æ˜ å°„å‡½æ•°
const mapProductName = (dimensionValue) => {
    if (!dimensionValue) return 'æœªçŸ¥';
    
    const value = dimensionValue.toLowerCase().trim();
    
    // é¦–å…ˆå°è¯•ç›´æ¥åŒ¹é…
    if (productCodeToNameMap[value]) {
        return productCodeToNameMap[value];
    }
    
    // å°è¯•åŒ…å«åŒ¹é…
    for (const [code, name] of Object.entries(productCodeToNameMap)) {
        if (value.includes(code) || value === code) {
            return name;
        }
    }
    
    // å…³é”®è¯åŒ¹é…
    if (value.includes('å³æœŸ') || value.includes('spot')) {
        return 'å¤–æ±‡å³æœŸ';
    } else if (value.includes('è¿œæœŸ') || value.includes('forward') || value.includes('fwd')) {
        return 'å¤–æ±‡è¿œæœŸ';
    } else if (value.includes('æ‰æœŸ') || value.includes('swap') || value.includes('fxsw')) {
        return 'å¤–æ±‡æ‰æœŸ';
    } else if (value.includes('æœŸæƒ') || value.includes('option') || value.includes('fxo')) {
        return 'å¤–æ±‡æœŸæƒ';
    } else if (value.includes('ccs') || value.includes('è´§å¸æ‰æœŸ')) {
        return 'CCS';
    } else if (value.includes('irs') || value.includes('åˆ©ç‡äº’æ¢') || value.includes('sw01') || value.includes('sw02')) {
        return 'IRS';
    }
    
    // é»˜è®¤è¿”å›åŸå§‹å€¼
    return dimensionValue;
};

// æ›´æ–°äº§å“åˆ†ç±»é¥¼å›¾
function updateProductPieChart(details) {
    // å¦‚æœå›¾è¡¨æœªåˆå§‹åŒ–ï¼Œå°è¯•åˆå§‹åŒ–
    if (!productPieChartInstance) {
        initProductPieChart();
    }
    
    if (!productPieChartInstance || !details || details.length === 0) {
        return;
    }
    
    // æŒ‰æ ‡å‡†äº§å“åç§°åˆ†ç±»æ±‡æ€»
    const productMap = {};
    details.forEach(detail => {
        // å°†dimension_valueæ˜ å°„åˆ°æ ‡å‡†äº§å“åç§°
        const productName = mapProductName(detail.dimension_value);
        if (!productMap[productName]) {
            productMap[productName] = 0;
        }
        productMap[productName] += detail.total_pnl || 0;
    });
    
    // æŒ‰å›ºå®šé¡ºåºæ’åˆ—äº§å“
    const productOrder = ['å¤–æ±‡å³æœŸ', 'å¤–æ±‡è¿œæœŸ', 'å¤–æ±‡æ‰æœŸ', 'å¤–æ±‡æœŸæƒ', 'CCS', 'IRS'];
    const labels = productOrder.filter(name => productMap.hasOwnProperty(name));
    const data = labels.map(label => productMap[label]);
    
    // è®¡ç®—æ€»é‡‘é¢ï¼Œç”¨äºè®¡ç®—å æ¯”
    const total = data.reduce((sum, val) => sum + val, 0);
    
    // é¥¼å›¾æ ‡ç­¾ä¸æ˜¾ç¤ºå æ¯”ï¼ˆå æ¯”åœ¨è¡¨æ ¼ä¸­æ˜¾ç¤ºï¼‰
    productPieChartInstance.data.labels = labels;
    productPieChartInstance.data.datasets[0].data = data;
    productPieChartInstance.update();
    
    // æ›´æ–°äº§å“åˆ†ç±»è¡¨æ ¼
    updateProductTable(labels, data, total);
}

// æ›´æ–°æŸç›Šåˆ†é¡¹æŸ±çŠ¶å›¾
function updateComponentBarChart(details) {
    // å¦‚æœå›¾è¡¨æœªåˆå§‹åŒ–ï¼Œå°è¯•åˆå§‹åŒ–
    if (!componentBarChartInstance) {
        initComponentBarChart();
    }
    
    if (!componentBarChartInstance || !details || details.length === 0) {
        return;
    }
    
    // æŒ‰æŸç›Šåˆ†é¡¹æ±‡æ€»
    let interestTotal = 0;
    let priceDiffTotal = 0;
    let valuationTotal = 0;
    let financingTotal = 0;
    let feeTotal = 0;
    
    details.forEach(detail => {
        interestTotal += detail.pnl_interest || 0;
        priceDiffTotal += detail.pnl_price_diff || 0;
        valuationTotal += detail.pnl_valuation || 0;
        financingTotal += detail.pnl_financing || 0;
        feeTotal += detail.pnl_fee || 0;
    });
    
    // è®¡ç®—æ€»é‡‘é¢ï¼Œç”¨äºè®¡ç®—å æ¯”
    const total = interestTotal + priceDiffTotal + valuationTotal + financingTotal + feeTotal;
    
    // è®¡ç®—å„åˆ†é¡¹çš„å æ¯”
    const percentages = [
        total !== 0 ? ((interestTotal / total) * 100).toFixed(2) : '0.00',
        total !== 0 ? ((priceDiffTotal / total) * 100).toFixed(2) : '0.00',
        total !== 0 ? ((valuationTotal / total) * 100).toFixed(2) : '0.00',
        total !== 0 ? ((financingTotal / total) * 100).toFixed(2) : '0.00',
        total !== 0 ? ((feeTotal / total) * 100).toFixed(2) : '0.00'
    ];
    
    // æ›´æ–°æ ‡ç­¾ï¼Œæ˜¾ç¤ºå æ¯”
    const labels = [
        `åˆ©æ¯æŸç›Š (${percentages[0]}%)`,
        `ä»·å·®æŸç›Š (${percentages[1]}%)`,
        `ä¼°å€¼æŸç›Š (${percentages[2]}%)`,
        `èèµ„æˆæœ¬ (${percentages[3]}%)`,
        `æ‰‹ç»­è´¹ (${percentages[4]}%)`
    ];
    const data = [interestTotal, priceDiffTotal, valuationTotal, financingTotal, feeTotal];
    
    componentBarChartInstance.data.labels = labels;
    componentBarChartInstance.data.datasets[0].data = data;
    
    // æ›´æ–°tooltipä»¥æ˜¾ç¤ºå æ¯”
    componentBarChartInstance.options.plugins.tooltip.callbacks.label = function(context) {
        const label = context.label || '';
        const originalLabel = label.split(' (')[0]; // å»æ‰å æ¯”éƒ¨åˆ†
        const value = context.parsed.y || 0;
        const percentage = percentages[context.dataIndex] || '0.00';
        return `${originalLabel}: ${value.toLocaleString('zh-CN', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}ä¸‡å…ƒ (${percentage}%)`;
    };
    
    componentBarChartInstance.update();
}

// æ›´æ–°äº§å“åˆ†ç±»è¡¨æ ¼
function updateProductTable(labels, data, total) {
    const productTableBody = document.getElementById('productTableBody');
    if (!productTableBody) return;
    
    productTableBody.innerHTML = '';
    
    if (!labels || labels.length === 0) {
        productTableBody.innerHTML = '<tr><td colspan="4" class="empty-state">æš‚æ— æ•°æ®</td></tr>';
        return;
    }
    
    // æŒ‰é‡‘é¢æ’åºï¼ˆä»å¤§åˆ°å°ï¼‰
    const sortedData = labels.map((label, index) => ({
        label: label,
        value: data[index],
        percentage: total !== 0 ? ((data[index] / total) * 100).toFixed(2) : '0.00'
    })).sort((a, b) => b.value - a.value);
    
    sortedData.forEach(item => {
        const row = document.createElement('tr');
        const valueClass = item.value > 0 ? 'positive' : (item.value < 0 ? 'negative' : 'neutral');
        const percentageClass = parseFloat(item.percentage) > 0 ? 'positive' : (parseFloat(item.percentage) < 0 ? 'negative' : 'neutral');
        
        row.innerHTML = `
            <td>${item.label}</td>
            <td class="${valueClass}">${item.value.toLocaleString('zh-CN', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</td>
            <td class="${percentageClass}">${item.percentage}%</td>
            <td>
                <button class="action-btn" onclick="showProductDetail('${item.label.replace(/'/g, "\\'")}')">æŸ¥çœ‹æ˜ç»†</button>
            </td>
        `;
        productTableBody.appendChild(row);
    });
}

// é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–å›¾è¡¨
document.addEventListener('DOMContentLoaded', () => {
    // å»¶è¿Ÿåˆå§‹åŒ–ï¼Œç¡®ä¿DOMå®Œå…¨åŠ è½½
    setTimeout(() => {
        console.log('DOMContentLoaded: Initializing charts...');
        const trendCtx = document.getElementById('trendChart');
        if (trendCtx) {
            console.log('Trend chart canvas found, initializing...');
            initCharts();
        } else {
            console.warn('Trend chart canvas not found on DOMContentLoaded, will retry later');
            // å»¶è¿Ÿé‡è¯•
            setTimeout(() => {
                const retryCtx = document.getElementById('trendChart');
                if (retryCtx) {
                    console.log('Retrying chart initialization...');
                    initCharts();
                } else {
                    console.error('Trend chart canvas still not found after retry');
                }
            }, 1000);
        }
    }, 100);
});






    </script>
    <script>
/**
 * å¯¼å‡ºåŠŸèƒ½æ¨¡å—
 */

class ExportManager {
    /**
     * å¯¼å‡ºä¸º CSV
     */
    exportToCSV(data, filename = 'pnl_export.csv') {
        const details = data.details || [];
        const headers = ['ç»´åº¦', 'åˆ©æ¯æŸç›Š', 'ä»·å·®æŸç›Š', 'ä¼°å€¼æŸç›Š', 'èèµ„æˆæœ¬', 'æ‰‹ç»­è´¹', 'æ€»è®¡', 'å æ¯”'];
        
        let csv = '\uFEFF'; // BOM for Excel Chinese support
        csv += headers.join(',') + '\n';
        
        details.forEach(detail => {
            const row = [
                detail.dimension_value,
                detail.pnl_interest,
                detail.pnl_price_diff,
                detail.pnl_valuation,
                detail.pnl_financing,
                detail.pnl_fee,
                detail.total_pnl,
                detail.percentage.toFixed(2) + '%'
            ];
            csv += row.join(',') + '\n';
        });
        
        this.downloadFile(csv, filename, 'text/csv;charset=utf-8;');
    }
    
    /**
     * å¯¼å‡ºä¸º JSON
     */
    exportToJSON(data, filename = 'pnl_export.json') {
        const json = JSON.stringify(data, null, 2);
        this.downloadFile(json, filename, 'application/json');
    }
    
    /**
     * ä¸‹è½½æ–‡ä»¶
     */
    downloadFile(content, filename, contentType) {
        const blob = new Blob([content], { type: contentType });
        const url = URL.createObjectURL(blob);
        const link = document.createElement('a');
        link.href = url;
        link.download = filename;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        URL.revokeObjectURL(url);
    }
}

// åˆ›å»ºå…¨å±€å¯¼å‡ºç®¡ç†å™¨å®ä¾‹
const exportManager = new ExportManager();







    </script>
    <script>
/**
 * å¤–æ±‡ç±»æŸç›Šå½’å› åˆ†æä¸»åº”ç”¨é€»è¾‘
 */

// å…¨å±€çŠ¶æ€
const fxState = {
    portfolios: [],
    fxProducts: [],
    currentData: null,
    trendData: null,
    fxData: {
        portfolio: null,
        product: null,
        currencyPair: null
    }
    // trendChartVisibleå·²ç§»é™¤ï¼Œè¶‹åŠ¿å›¾ç›´æ¥æ˜¾ç¤º
};

// DOM å…ƒç´ 
const fxElements = {
    // é…ç½®é¢æ¿
    startDate: document.getElementById('fxStartDate'),
    endDate: document.getElementById('fxEndDate'),
    portfolioSelect: document.getElementById('fxPortfolioSelect'),
    productSelect: document.getElementById('fxProductSelect'),
    currencyPairSelect: document.getElementById('fxCurrencyPairSelect'),
    queryBtn: document.getElementById('fxQueryBtn'),
    resetBtn: document.getElementById('fxResetBtn'),
    
    // æŒ‡æ ‡å¡ç‰‡
    valuationPnl: document.getElementById('fxValuationPnl'),
    
    // è­¦å‘Š
    warningsSection: document.getElementById('fxWarningsSection'),
    warningsList: document.getElementById('fxWarningsList'),
    
    // è¡¨æ ¼
    attributionTableBody: document.getElementById('fxAttributionTableBody'),
    portfolioSensitivityTableBody: document.getElementById('fxPortfolioSensitivityTableBody'),
    assetTargetTableBody: document.getElementById('fxAssetTargetTableBody'),
    
    // TabæŒ‰é’®
    tabButtons: document.querySelectorAll('.tab-nav .tab-button[data-tab^="fxTab"]'),
    
};

// åˆå§‹åŒ–
async function initFXAttribution() {
    // è®¾ç½®é»˜è®¤ç»“æŸæ—¥æœŸä¸ºä»Šå¤©
    const today = new Date().toISOString().split('T')[0];
    if (fxElements.endDate) {
        fxElements.endDate.value = today;
    }
    
    
    // åŠ è½½åŸºç¡€æ•°æ®
    await loadFXBaseData();
    
    // ç»‘å®šäº‹ä»¶
    bindFXEvents();
    
    console.log('FX Attribution Application initialized');
}

// åŠ è½½åŸºç¡€æ•°æ®
async function loadFXBaseData() {
    try {
        // æŠ•èµ„ç»„åˆå’Œäº§å“å·²æ”¹ä¸ºå›ºå®šä¸‹æ‹‰æ¡†ï¼Œä¸éœ€è¦ä»APIåŠ è½½
        // è®¾ç½®é»˜è®¤å€¼
        if (fxElements.portfolioSelect) {
            fxElements.portfolioSelect.value = '';
        }
        if (fxElements.productSelect) {
            fxElements.productSelect.value = '';
        }
        
        console.log('FX Base data initialized');
    } catch (error) {
        console.error('Failed to initialize:', error);
        showFXError('åˆå§‹åŒ–å¤±è´¥');
    }
}

// å¡«å……æŠ•èµ„ç»„åˆä¸‹æ‹‰æ¡†ï¼ˆå·²åºŸå¼ƒï¼Œä½¿ç”¨å›ºå®šé€‰é¡¹ï¼‰
function populateFXPortfolios() {
    // ä¸å†éœ€è¦ï¼Œä½¿ç”¨HTMLä¸­çš„å›ºå®šé€‰é¡¹
}

// å¡«å……å¤–æ±‡äº§å“ä¸‹æ‹‰æ¡†ï¼ˆå·²åºŸå¼ƒï¼Œä½¿ç”¨å›ºå®šé€‰é¡¹ï¼‰
function populateFXProducts() {
    // ä¸å†éœ€è¦ï¼Œä½¿ç”¨HTMLä¸­çš„å›ºå®šé€‰é¡¹
}

// ç»‘å®šäº‹ä»¶
function bindFXEvents() {
    if (fxElements.queryBtn) {
        fxElements.queryBtn.addEventListener('click', handleFXQuery);
    }
    
    if (fxElements.resetBtn) {
        fxElements.resetBtn.addEventListener('click', handleFXReset);
    }
    
    // ç»‘å®šTabåˆ‡æ¢äº‹ä»¶
    if (fxElements.tabButtons && fxElements.tabButtons.length > 0) {
        fxElements.tabButtons.forEach(button => {
            button.addEventListener('click', handleFXTabSwitch);
        });
    }
    
    // å¯¼å‡ºæŒ‰é’®å·²ç§»é™¤
    // è¶‹åŠ¿å›¾åˆ‡æ¢æŒ‰é’®å·²ç§»é™¤ï¼Œè¶‹åŠ¿å›¾ç›´æ¥æ˜¾ç¤º
}

// å¤„ç†æŸ¥è¯¢
async function handleFXQuery() {
    try {
        const startDate = fxElements.startDate.value;
        const endDate = fxElements.endDate.value;
        
        if (!startDate || !endDate) {
            alert('è¯·é€‰æ‹©æ—¥æœŸèŒƒå›´');
            return;
        }
        
        if (new Date(startDate) > new Date(endDate)) {
            alert('èµ·å§‹æ—¥æœŸä¸èƒ½å¤§äºç»“æŸæ—¥æœŸ');
            return;
        }
        
        // å¤„ç†æŠ•èµ„ç»„åˆï¼ˆå•é€‰ä¸‹æ‹‰æ¡†ï¼‰
        const portfolioValue = fxElements.portfolioSelect.value;
        const portfolioIds = portfolioValue && portfolioValue !== '' ? [portfolioValue] : [];
        
        // å¤„ç†äº§å“ï¼ˆå•é€‰ä¸‹æ‹‰æ¡†ï¼‰
        const productValue = fxElements.productSelect.value;
        const productCodes = productValue && productValue !== '' ? [productValue] : [];
        
        // å¤„ç†æ ‡çš„ï¼ˆè´§å¸å¯¹ï¼Œå•é€‰ä¸‹æ‹‰æ¡†ï¼‰
        const currencyPairValue = fxElements.currencyPairSelect.value;
        const currencyPairs = currencyPairValue && currencyPairValue !== '' ? [currencyPairValue] : [];
        
        const groupBy = 'portfolio'; // é»˜è®¤ä½¿ç”¨ç°¿è®°æ¶æ„åˆ†ç»„
        
        // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
        fxElements.queryBtn.disabled = true;
        fxElements.queryBtn.textContent = 'æŸ¥è¯¢ä¸­...';
        
        // è°ƒç”¨APIè·å–ä¸‰ä¸ªç»´åº¦çš„æ•°æ®
        const baseRequestData = {
            start_date: startDate,
            end_date: endDate,
            portfolio_ids: portfolioIds,
            product_codes: productCodes,
            currency_pairs: currencyPairs
        };
        
        // å¹¶è¡Œè¯·æ±‚ä¸‰ä¸ªç»´åº¦çš„æ•°æ®
        const [portfolioResponse, productResponse, currencyPairResponse] = await Promise.all([
            api.calculateFXAttribution({ ...baseRequestData, group_by: 'portfolio' }),
            api.calculateFXAttribution({ ...baseRequestData, group_by: 'product' }),
            api.calculateFXAttribution({ ...baseRequestData, group_by: 'currency_pair' })
        ]);
        
        // ä¿å­˜ä¸‰ä¸ªç»´åº¦çš„æ•°æ®
        fxState.fxData = {
            portfolio: portfolioResponse,
            product: productResponse,
            currencyPair: currencyPairResponse
        };
        
        // ä½¿ç”¨portfolioæ•°æ®ä½œä¸ºä¸»æ•°æ®ï¼ˆç”¨äºæ˜¾ç¤ºæŒ‡æ ‡ç­‰ï¼‰
        fxState.currentData = portfolioResponse;
        
        // æ›´æ–°ç•Œé¢
        updateFXDisplay(portfolioResponse);
        
        // åŠ è½½è¶‹åŠ¿æ•°æ®å¹¶æ›´æ–°è¶‹åŠ¿å›¾
        await loadFXTrendData({ ...baseRequestData, group_by: 'portfolio' });
        
    } catch (error) {
        console.error('Query failed:', error);
        showFXError('æŸ¥è¯¢å¤±è´¥ï¼š' + (error.message || 'æœªçŸ¥é”™è¯¯'));
    } finally {
        if (fxElements.queryBtn) {
            fxElements.queryBtn.disabled = false;
            fxElements.queryBtn.textContent = 'æŸ¥è¯¢';
        }
    }
}

// åŠ è½½è¶‹åŠ¿æ•°æ®
async function loadFXTrendData(requestData) {
    try {
        const params = {
            start_date: requestData.start_date,
            end_date: requestData.end_date,
            portfolio_ids: requestData.portfolio_ids.join(','),
            product_codes: requestData.product_codes.join(','),
            currency_pairs: requestData.currency_pairs.join(','),
            group_by: requestData.group_by
        };
        
        const response = await api.getFXTrend(params);
        fxState.trendData = response.trend_data || [];
        
        // æ›´æ–°è¶‹åŠ¿å›¾ï¼ˆç›´æ¥æ˜¾ç¤ºï¼Œä¸éœ€è¦åˆ‡æ¢ï¼‰
        if (window.fxCharts && fxState.trendData.length > 0) {
            window.fxCharts.updateTrendChart(fxState.trendData);
        }
    } catch (error) {
        console.error('Failed to load trend data:', error);
    }
}

// æ›´æ–°æ˜¾ç¤º
function updateFXDisplay(data) {
    // ä¿å­˜æ•°æ®åˆ°state
    fxState.currentData = data;
    
    // æ›´æ–°æŒ‡æ ‡å¡ç‰‡
    updateFXMetrics(data);
    
    // æ›´æ–°å½“å‰æ¿€æ´»çš„Tabè¡¨æ ¼
    updateFXTabs(data.details || []);
    
    // æ›´æ–°å›¾è¡¨
    if (window.fxCharts) {
        window.fxCharts.updateCharts(data);
    }
    
    // æ›´æ–°è­¦å‘Š
    updateFXWarnings(data.warnings || []);
}

// Tabåˆ‡æ¢å¤„ç†
function handleFXTabSwitch(event) {
    const button = event.currentTarget;
    const tabId = button.getAttribute('data-tab');
    
    // ç§»é™¤æ‰€æœ‰activeç±»
    fxElements.tabButtons.forEach(btn => btn.classList.remove('active'));
    document.querySelectorAll('.tab-content[id^="fxTab"]').forEach(tab => {
        tab.classList.remove('active');
    });
    
    // æ·»åŠ activeç±»åˆ°å½“å‰Tab
    button.classList.add('active');
    const tabContent = document.getElementById(tabId);
    if (tabContent) {
        tabContent.classList.add('active');
    }
    
    // å¦‚æœåˆ‡æ¢åˆ°Tab2ï¼Œéœ€è¦åˆå§‹åŒ–é¥¼å›¾
    if (tabId === 'fxTab2' && !window.fxProductPieChartInstance) {
        initFXProductPieChart();
    }
    
    // å¦‚æœå·²æœ‰æ•°æ®ï¼Œæ›´æ–°å½“å‰Tabçš„æ˜¾ç¤º
    if (fxState.fxData) {
        updateFXTabs([]);
    }
}

// æ›´æ–°æ‰€æœ‰Tabè¡¨æ ¼
function updateFXTabs(details) {
    // è·å–å½“å‰æ¿€æ´»çš„Tab
    const activeTab = document.querySelector('.tab-button.active[data-tab^="fxTab"]');
    if (!activeTab) return;
    
    const tabId = activeTab.getAttribute('data-tab');
    
    // æ ¹æ®Tabä½¿ç”¨å¯¹åº”çš„æ•°æ®
    if (tabId === 'fxTab1') {
        // å½’å› æ˜ç»† - æŒ‰æŠ•ç»„ç»´åº¦å±•ç¤ºå½’å› ç»“æœ
        const portfolioData = fxState.fxData?.portfolio;
        updateFXAttributionTable(portfolioData?.details || []);
    } else if (tabId === 'fxTab2') {
        // æŒ‰æŠ•ç»„ - å±•ç¤ºæ•æ„Ÿå€¼
        const portfolioData = fxState.fxData?.portfolio;
        updateFXPortfolioSensitivityTable(portfolioData?.details || []);
    } else if (tabId === 'fxTab3') {
        // æŒ‰èµ„äº§æ ‡çš„ - å±•ç¤ºè´§å¸å¯¹å½’å› ç»“æœ
        const currencyPairData = fxState.fxData?.currencyPair;
        updateFXAssetTargetTable(currencyPairData?.details || []);
    }
}

// æ›´æ–°æŒ‡æ ‡
function updateFXMetrics(data) {
    if (fxElements.valuationPnl) {
        const value = data.total_valuation_pnl || 0;
        fxElements.valuationPnl.textContent = formatNumber(value);
        fxElements.valuationPnl.className = 'metric-value ' + getNumberClass(value);
    }
}

// Folderåç§°æ˜ å°„ï¼ˆå½’å› æ˜ç»†ä½¿ç”¨ï¼‰
const fxFolderNameMap = {
    'BNTCBDEPO': 'BNTCBDEPO',
    'BNTFIDEPO': 'BNTFIDEPO',
    'BNBCMBOND': 'BNBCMBOND',
    'BNBMMFXSWP': 'BNBMMFXSWP',
    'BNBMMINTBK': 'BNBMMINTBK',
    'BNMMINTBKE': 'BNMMINTBKE'
};

// æ˜ å°„Folderæ˜¾ç¤ºåç§°ï¼ˆç”¨äºå½’å› æ˜ç»†ï¼‰
function mapFXFolderName(dimensionValue) {
    if (!dimensionValue) return 'æœªçŸ¥';
    
    // æ ‡å‡†åŒ–å¤„ç†ï¼šå»é™¤ç©ºæ ¼ï¼Œè½¬æ¢ä¸ºå¤§å†™
    const value = dimensionValue.trim().toUpperCase();
    
    // å°è¯•ç›´æ¥åŒ¹é…ï¼ˆä¸åŒºåˆ†å¤§å°å†™ï¼‰
    if (fxFolderNameMap[value]) {
        return fxFolderNameMap[value];
    }
    
    // å¦‚æœå·²ç»æ˜¯æ ‡å‡†Folderåç§°ï¼ˆåŸå§‹å¤§å°å†™ï¼‰ï¼Œç›´æ¥è¿”å›
    if (fxFolderNameMap[dimensionValue.trim()]) {
        return fxFolderNameMap[dimensionValue.trim()];
    }
    
    // å°è¯•åŒ¹é…ï¼ˆä¸åŒºåˆ†å¤§å°å†™ï¼‰
    for (const [key, mappedValue] of Object.entries(fxFolderNameMap)) {
        if (value === key.toUpperCase()) {
            return mappedValue;
        }
    }
    
    // å¦‚æœåŒ…å«Folderåç§°çš„ä¸€éƒ¨åˆ†ï¼Œå°è¯•åŒ¹é…
    const folderNames = Object.keys(fxFolderNameMap);
    for (const folderName of folderNames) {
        const folderUpper = folderName.toUpperCase();
        if (value === folderUpper || value.includes(folderUpper) || folderUpper.includes(value)) {
            return fxFolderNameMap[folderName];
        }
    }
    
    // å¦‚æœåç«¯è¿”å›çš„å°±æ˜¯Folderåç§°ï¼Œç›´æ¥è¿”å›ï¼ˆæ ‡å‡†åŒ–ä¸ºå¤§å†™ï¼‰
    // è¿™æ ·å¯ä»¥ç¡®ä¿åç«¯è¿”å›çš„Folderåç§°èƒ½æ­£ç¡®æ˜¾ç¤º
    return dimensionValue.trim().toUpperCase();
}

// æŠ•ç»„åç§°æ˜ å°„ï¼ˆä¿ç•™ç”¨äºå…¶ä»–åœ°æ–¹ï¼‰
const fxPortfolioNameMap = {
    'å¤–æ±‡å³æœŸæŠ•ç»„': 'å¤–æ±‡å³æœŸæŠ•ç»„',
    'å¤–æ±‡è¿œæœŸæŠ•ç»„': 'å¤–æ±‡è¿œæœŸæŠ•ç»„',
    'å¤–æ±‡æ‰æœŸæŠ•ç»„': 'å¤–æ±‡æ‰æœŸæŠ•ç»„',
    'å¤–æ±‡æœŸæƒæŠ•ç»„': 'å¤–æ±‡æœŸæƒæŠ•ç»„'
};

// æ˜ å°„æŠ•ç»„æ˜¾ç¤ºåç§°ï¼ˆç”¨äºæŒ‰æŠ•ç»„å’ŒæŒ‰èµ„äº§æ ‡çš„Tabï¼‰
function mapFXPortfolioName(dimensionValue) {
    if (!dimensionValue) return 'æœªçŸ¥';
    
    // å°è¯•ç›´æ¥åŒ¹é…
    if (fxPortfolioNameMap[dimensionValue]) {
        return fxPortfolioNameMap[dimensionValue];
    }
    
    // æ ‡å‡†åŒ–å¤„ç†ï¼šå»é™¤ç©ºæ ¼ï¼Œè½¬æ¢ä¸ºå°å†™
    const value = dimensionValue.trim().toLowerCase();
    
    // ç²¾ç¡®åŒ¹é…æ ‡å‡†åç§°
    const normalizedMap = {
        'å¤–æ±‡å³æœŸæŠ•ç»„': 'å¤–æ±‡å³æœŸæŠ•ç»„',
        'å¤–æ±‡è¿œæœŸæŠ•ç»„': 'å¤–æ±‡è¿œæœŸæŠ•ç»„',
        'å¤–æ±‡æ‰æœŸæŠ•ç»„': 'å¤–æ±‡æ‰æœŸæŠ•ç»„',
        'å¤–æ±‡æœŸæƒæŠ•ç»„': 'å¤–æ±‡æœŸæƒæŠ•ç»„',
        'å¤–æ±‡å³æœŸ': 'å¤–æ±‡å³æœŸæŠ•ç»„',
        'å¤–æ±‡è¿œæœŸ': 'å¤–æ±‡è¿œæœŸæŠ•ç»„',
        'å¤–æ±‡æ‰æœŸ': 'å¤–æ±‡æ‰æœŸæŠ•ç»„',
        'å¤–æ±‡æœŸæƒ': 'å¤–æ±‡æœŸæƒæŠ•ç»„'
    };
    
    if (normalizedMap[dimensionValue.trim()]) {
        return normalizedMap[dimensionValue.trim()];
    }
    
    // å…³é”®è¯åŒ¹é…ï¼ˆæ›´å®½æ¾çš„åŒ¹é…ï¼‰
    if (value.includes('å³æœŸ') || value.includes('spot') || value.includes('fxspot')) {
        return 'å¤–æ±‡å³æœŸæŠ•ç»„';
    } else if (value.includes('è¿œæœŸ') || value.includes('forward') || value.includes('fwd')) {
        return 'å¤–æ±‡è¿œæœŸæŠ•ç»„';
    } else if (value.includes('æ‰æœŸ') || value.includes('swap') || value.includes('fxsw')) {
        return 'å¤–æ±‡æ‰æœŸæŠ•ç»„';
    } else if (value.includes('æœŸæƒ') || value.includes('option') || value.includes('fxo')) {
        return 'å¤–æ±‡æœŸæƒæŠ•ç»„';
    }
    
    // å¦‚æœåŒ…å«æŠ•ç»„ç›¸å…³çš„å…³é”®è¯ï¼Œå°è¯•æå–äº§å“ç±»å‹
    if (value.includes('æŠ•ç»„') || value.includes('portfolio')) {
        if (value.includes('å³æœŸ') || value.includes('spot')) {
            return 'å¤–æ±‡å³æœŸæŠ•ç»„';
        } else if (value.includes('è¿œæœŸ') || value.includes('forward') || value.includes('fwd')) {
            return 'å¤–æ±‡è¿œæœŸæŠ•ç»„';
        } else if (value.includes('æ‰æœŸ') || value.includes('swap') || value.includes('fxsw')) {
            return 'å¤–æ±‡æ‰æœŸæŠ•ç»„';
        } else if (value.includes('æœŸæƒ') || value.includes('option') || value.includes('fxo')) {
            return 'å¤–æ±‡æœŸæƒæŠ•ç»„';
        }
    }
    
    // é»˜è®¤è¿”å›åŸå§‹å€¼ï¼ˆä½†å°è¯•æ ‡å‡†åŒ–ï¼‰
    console.warn('æœªåŒ¹é…çš„æŠ•ç»„åç§°:', dimensionValue);
    return dimensionValue;
}

// Tab1: æ›´æ–°å½’å› æ˜ç»†è¡¨æ ¼ï¼ˆæŒ‰æŠ•ç»„ç»´åº¦ï¼ŒåŒ…å«æ€»æ•å£å’Œèµ„äº§æ ‡çš„ï¼‰
function updateFXAttributionTable(details) {
    if (!fxElements.attributionTableBody) return;
    
    fxElements.attributionTableBody.innerHTML = '';
    
    if (!details || details.length === 0) {
        fxElements.attributionTableBody.innerHTML = '<tr><td colspan="16" class="empty-state">æš‚æ— æ•°æ®</td></tr>';
        return;
    }
    
    // æŒ‰Folderåç§°å»é‡å¹¶æ±‡æ€»
    const portfolioMap = new Map();
    details.forEach(detail => {
        const folderName = mapFXFolderName(detail.dimension_value);
        
        if (!portfolioMap.has(folderName)) {
            portfolioMap.set(folderName, {
                dimension_value: folderName,
                valuation_pnl: 0,
                factors: {},
                unexplained: 0,
                total_exposure: 0, // æ€»æ•å£
                start_date_factors: detail.start_date_factors,
                end_date_factors: detail.end_date_factors
            });
        }
        
        const aggregated = portfolioMap.get(folderName);
        aggregated.valuation_pnl += detail.valuation_pnl || 0;
        aggregated.unexplained += detail.unexplained || 0;
        
        // æ”¶é›†æ€»æ•å£ï¼ˆå¦‚æœæœ‰çš„è¯ï¼Œå¦åˆ™ä½¿ç”¨ä¼°å€¼æŸç›Šçš„ç»å¯¹å€¼ä½œä¸ºä¼°ç®—ï¼‰
        if (detail.total_exposure !== undefined) {
            aggregated.total_exposure += Math.abs(detail.total_exposure);
        } else {
            // å¦‚æœæ²¡æœ‰æ€»æ•å£æ•°æ®ï¼Œä½¿ç”¨ä¼°å€¼æŸç›Šçš„ç»å¯¹å€¼ä½œä¸ºä¼°ç®—
            aggregated.total_exposure += Math.abs(detail.valuation_pnl || 0) * 10; // ä¼°ç®—ç³»æ•°
        }
        
        // æ±‡æ€»å› å­
        (detail.factors || []).forEach(factor => {
            if (!aggregated.factors[factor.factor_code]) {
                aggregated.factors[factor.factor_code] = {
                    factor_code: factor.factor_code,
                    factor_name: factor.factor_name,
                    pnl_contribution: 0
                };
            }
            aggregated.factors[factor.factor_code].pnl_contribution += factor.pnl_contribution || 0;
        });
    });
    
    // è½¬æ¢ä¸ºæ•°ç»„å¹¶åˆ›å»ºè¡Œ
    Array.from(portfolioMap.values()).forEach(aggregated => {
        // å°†factorså¯¹è±¡è½¬æ¢ä¸ºæ•°ç»„
        aggregated.factors = Object.values(aggregated.factors);
        
        const row = createFXAttributionTableRow(aggregated);
        fxElements.attributionTableBody.appendChild(row);
    });
}

// Tab2: æ›´æ–°æŒ‰æŠ•ç»„æ•æ„Ÿå€¼è¡¨æ ¼
function updateFXPortfolioSensitivityTable(details) {
    if (!fxElements.portfolioSensitivityTableBody) return;
    
    fxElements.portfolioSensitivityTableBody.innerHTML = '';
    
    if (!details || details.length === 0) {
        fxElements.portfolioSensitivityTableBody.innerHTML = '<tr><td colspan="14" class="empty-state">æš‚æ— æ•°æ®</td></tr>';
        return;
    }
    
    // æŒ‰æŠ•ç»„åç§°å»é‡å¹¶æ±‡æ€»æ•æ„Ÿå€¼å’Œæ€»æ•å£
    const portfolioMap = new Map();
    details.forEach(detail => {
        const portfolioName = mapFXPortfolioName(detail.dimension_value);
        
        if (!portfolioMap.has(portfolioName)) {
            portfolioMap.set(portfolioName, {
                dimension_value: portfolioName,
                factors: {},
                total_exposure: 0,
                valuation_pnl: 0,
                unexplained: 0
            });
        }
        
        const aggregated = portfolioMap.get(portfolioName);
        
        // æ”¶é›†æ€»æ•å£
        if (detail.total_exposure !== undefined) {
            aggregated.total_exposure += Math.abs(detail.total_exposure);
        } else {
            // å¦‚æœæ²¡æœ‰æ€»æ•å£æ•°æ®ï¼Œä½¿ç”¨ä¼°å€¼æŸç›Šçš„ç»å¯¹å€¼ä½œä¸ºä¼°ç®—
            aggregated.total_exposure += Math.abs(detail.valuation_pnl || 0) * 10;
        }
        
        // æ”¶é›†ä¼°å€¼æŸç›Šå’Œæ— æ³•è§£é‡Šéƒ¨åˆ†ï¼ˆç”¨äºè´¡çŒ®åº¦è®¡ç®—ï¼‰
        aggregated.valuation_pnl += detail.valuation_pnl || 0;
        aggregated.unexplained += detail.unexplained || 0;
        
        // æ±‡æ€»å› å­ï¼ˆæ•æ„Ÿå€¼ï¼‰
        (detail.factors || []).forEach(factor => {
            if (!aggregated.factors[factor.factor_code]) {
                aggregated.factors[factor.factor_code] = {
                    factor_code: factor.factor_code,
                    factor_name: factor.factor_name,
                    pnl_contribution: 0
                };
            }
            aggregated.factors[factor.factor_code].pnl_contribution += factor.pnl_contribution || 0;
        });
    });
    
    // è½¬æ¢ä¸ºæ•°ç»„å¹¶åˆ›å»ºè¡Œ
    Array.from(portfolioMap.values()).forEach(aggregated => {
        const row = createFXSensitivityTableRow(aggregated);
        fxElements.portfolioSensitivityTableBody.appendChild(row);
    });
}

// å¡«å……Tab3æŠ•ç»„é€‰æ‹©å™¨
function populateFXAssetTargetPortfolioSelect(portfolioResponse) {
    if (!fxElements.assetTargetPortfolioSelect) return;
    
    // ä¿å­˜å½“å‰é€‰æ‹©çš„å€¼
    const currentValue = fxElements.assetTargetPortfolioSelect.value;
    
    // æ¸…ç©ºç°æœ‰é€‰é¡¹ï¼ˆä¿ç•™"è¯·é€‰æ‹©æŠ•ç»„"é€‰é¡¹ï¼‰
    fxElements.assetTargetPortfolioSelect.innerHTML = '<option value="">è¯·é€‰æ‹©æŠ•ç»„</option>';
    
    if (!portfolioResponse || !portfolioResponse.details || portfolioResponse.details.length === 0) {
        return;
    }
    
    // ä»portfolioæ•°æ®ä¸­æå–æŠ•ç»„åˆ—è¡¨
    const portfolioSet = new Set();
    portfolioResponse.details.forEach(detail => {
        const portfolioName = mapFXPortfolioName(detail.dimension_value);
        portfolioSet.add(portfolioName);
    });
    
    // æ·»åŠ "å…¨æœºæ„"é€‰é¡¹
    const optionAll = document.createElement('option');
    optionAll.value = 'all';
    optionAll.textContent = 'å…¨æœºæ„';
    fxElements.assetTargetPortfolioSelect.appendChild(optionAll);
    
    // æ·»åŠ å„ä¸ªæŠ•ç»„é€‰é¡¹
    Array.from(portfolioSet).sort().forEach(portfolioName => {
        const option = document.createElement('option');
        // ä½¿ç”¨æ ‡å‡†åŒ–çš„æŠ•ç»„åç§°ä½œä¸ºvalueï¼Œæ–¹ä¾¿åŒ¹é…
        option.value = portfolioName;
        option.textContent = portfolioName;
        fxElements.assetTargetPortfolioSelect.appendChild(option);
    });
    
    // æ¢å¤ä¹‹å‰é€‰æ‹©çš„å€¼ï¼ˆå¦‚æœä»ç„¶å­˜åœ¨ï¼‰
    if (currentValue) {
        fxElements.assetTargetPortfolioSelect.value = currentValue;
    }
}

// Tab3: æ›´æ–°æŒ‰èµ„äº§æ ‡çš„è¡¨æ ¼ï¼ˆç›´æ¥æ˜¾ç¤ºæ‰€æœ‰è´§å¸å¯¹æ•°æ®ï¼‰
function updateFXAssetTargetTable(details) {
    if (!fxElements.assetTargetTableBody) return;
    
    fxElements.assetTargetTableBody.innerHTML = '';
    
    if (!details || details.length === 0) {
        fxElements.assetTargetTableBody.innerHTML = '<tr><td colspan="15" class="empty-state">æš‚æ— æ•°æ®</td></tr>';
        return;
    }
    
    // æŒ‰è´§å¸å¯¹æ±‡æ€»ï¼ˆè™½ç„¶currencyPairæ•°æ®å·²ç»æŒ‰è´§å¸å¯¹æ±‡æ€»ï¼Œä½†è¿™é‡Œå†æ¬¡æ±‡æ€»ä»¥ç¡®ä¿ä¸€è‡´æ€§ï¼‰
    const currencyPairMap = new Map();
    details.forEach(detail => {
        const currencyPair = detail.dimension_value || 'æœªçŸ¥è´§å¸å¯¹';
        
        if (!currencyPairMap.has(currencyPair)) {
            currencyPairMap.set(currencyPair, {
                dimension_value: currencyPair,
                valuation_pnl: 0,
                factors: {},
                unexplained: 0
            });
        }
        
        const aggregated = currencyPairMap.get(currencyPair);
        aggregated.valuation_pnl += detail.valuation_pnl || 0;
        aggregated.unexplained += detail.unexplained || 0;
        
        // æ±‡æ€»å› å­
        (detail.factors || []).forEach(factor => {
            if (!aggregated.factors[factor.factor_code]) {
                aggregated.factors[factor.factor_code] = {
                    factor_code: factor.factor_code,
                    factor_name: factor.factor_name,
                    pnl_contribution: 0
                };
            }
            aggregated.factors[factor.factor_code].pnl_contribution += factor.pnl_contribution || 0;
        });
    });
    
    // è½¬æ¢ä¸ºæ•°ç»„å¹¶åˆ›å»ºè¡Œ
    Array.from(currencyPairMap.values()).forEach(aggregated => {
        aggregated.factors = Object.values(aggregated.factors);
        const row = createFXTableRow(aggregated, 'currency_pair');
        fxElements.assetTargetTableBody.appendChild(row);
    });
}

// æ›´æ–°æŠ•ç»„ç»´åº¦è¡¨æ ¼ï¼ˆä¿ç•™åŸå‡½æ•°ï¼Œç”¨äºå…¼å®¹ï¼‰
function updateFXPortfolioTable(details) {
    // é‡å®šå‘åˆ°æ–°çš„å½’å› æ˜ç»†è¡¨æ ¼
    updateFXAttributionTable(details);
}

// æ›´æ–°äº§å“ç»´åº¦é¥¼å›¾å’Œè¡¨æ ¼
function updateFXProductTable(details) {
    if (!details || details.length === 0) {
        if (fxElements.productTableBody) {
            fxElements.productTableBody.innerHTML = '<tr><td colspan="4" class="empty-state">æš‚æ— æ•°æ®</td></tr>';
        }
        return;
    }
    
    // æŒ‰äº§å“æ±‡æ€»ä¼°å€¼æŸç›Šå’Œå½’å› åˆ†é¡¹
    const productMap = {};
    details.forEach(detail => {
        const productName = mapFXProductName(detail.dimension_value);
        if (!productMap[productName]) {
            productMap[productName] = {
                valuation_pnl: 0,
                factors: {},
                unexplained: 0
            };
        }
        productMap[productName].valuation_pnl += detail.valuation_pnl || 0;
        productMap[productName].unexplained += detail.unexplained || 0;
        
        // æ±‡æ€»å› å­
        (detail.factors || []).forEach(factor => {
            if (!productMap[productName].factors[factor.factor_code]) {
                productMap[productName].factors[factor.factor_code] = {
                    factor_code: factor.factor_code,
                    factor_name: factor.factor_name,
                    pnl_contribution: 0
                };
            }
            productMap[productName].factors[factor.factor_code].pnl_contribution += factor.pnl_contribution || 0;
        });
    });
    
    // æŒ‰å›ºå®šé¡ºåºæ’åˆ—äº§å“
    const productOrder = ['å¤–æ±‡å³æœŸ', 'å¤–æ±‡è¿œæœŸ', 'å¤–æ±‡æ‰æœŸ', 'å¤–æ±‡æœŸæƒ', 'CCS', 'IRS'];
    const labels = productOrder.filter(name => productMap.hasOwnProperty(name));
    const data = labels.map(label => productMap[label].valuation_pnl);
    
    // è®¡ç®—æ€»é‡‘é¢
    const total = data.reduce((sum, val) => sum + val, 0);
    
    // æ›´æ–°é¥¼å›¾
    updateFXProductPieChart(labels, data);
    
    // æ›´æ–°è¡¨æ ¼ï¼ˆä¼ é€’äº§å“è¯¦ç»†ä¿¡æ¯ï¼‰
    updateFXProductTableData(labels, data, total, productMap);
}

// äº§å“åç§°æ˜ å°„å‡½æ•°ï¼ˆç”¨äºå¤–æ±‡å½’å› åˆ†æï¼‰
function mapFXProductName(dimensionValue) {
    if (!dimensionValue) return 'æœªçŸ¥';
    
    const value = dimensionValue.toLowerCase().trim();
    
    // äº§å“ä»£ç æ˜ å°„
    const productCodeMap = {
        'fxspot': 'å¤–æ±‡å³æœŸ',
        'fx_spot': 'å¤–æ±‡å³æœŸ',
        'fxspot01': 'å¤–æ±‡å³æœŸ',
        'fwd01': 'å¤–æ±‡è¿œæœŸ',
        'fwd02': 'å¤–æ±‡è¿œæœŸ',
        'fxsw01': 'å¤–æ±‡æ‰æœŸ',
        'fxsw02': 'å¤–æ±‡æ‰æœŸ',
        'fxo01': 'å¤–æ±‡æœŸæƒ',
        'fxo02': 'å¤–æ±‡æœŸæƒ',
        'fxopt': 'å¤–æ±‡æœŸæƒ',
        'ccs01': 'CCS',
        'sw01': 'IRS',
        'sw02': 'IRS'
    };
    
    // é¦–å…ˆå°è¯•ç›´æ¥åŒ¹é…
    if (productCodeMap[value]) {
        return productCodeMap[value];
    }
    
    // å°è¯•åŒ…å«åŒ¹é…
    for (const [code, name] of Object.entries(productCodeMap)) {
        if (value.includes(code)) {
            return name;
        }
    }
    
    // å…³é”®è¯åŒ¹é…
    if (value.includes('å³æœŸ') || value.includes('spot')) {
        return 'å¤–æ±‡å³æœŸ';
    } else if (value.includes('è¿œæœŸ') || value.includes('forward') || value.includes('fwd')) {
        return 'å¤–æ±‡è¿œæœŸ';
    } else if (value.includes('æ‰æœŸ') || value.includes('swap') || value.includes('fxsw')) {
        return 'å¤–æ±‡æ‰æœŸ';
    } else if (value.includes('æœŸæƒ') || value.includes('option') || value.includes('fxo')) {
        return 'å¤–æ±‡æœŸæƒ';
    } else if (value.includes('ccs') || value.includes('è´§å¸æ‰æœŸ')) {
        return 'CCS';
    } else if (value.includes('irs') || value.includes('åˆ©ç‡äº’æ¢') || value.includes('sw')) {
        return 'IRS';
    }
    
    // é»˜è®¤è¿”å›åŸå§‹å€¼
    return dimensionValue;
}

// æ›´æ–°äº§å“é¥¼å›¾
function updateFXProductPieChart(labels, data) {
    if (!window.fxProductPieChartInstance) {
        initFXProductPieChart();
    }
    
    if (!window.fxProductPieChartInstance) return;
    
    window.fxProductPieChartInstance.data.labels = labels;
    window.fxProductPieChartInstance.data.datasets[0].data = data;
    window.fxProductPieChartInstance.update();
}

// åˆå§‹åŒ–äº§å“é¥¼å›¾
function initFXProductPieChart() {
    const ctx = document.getElementById('fxProductPieChart');
    if (!ctx) return;
    
    window.fxProductPieChartInstance = new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: [],
            datasets: [{
                data: [],
                backgroundColor: [
                    '#4a90e2',
                    '#50c878',
                    '#ff6b6b',
                    '#ffd93d',
                    '#6c5ce7',
                    '#00d9ff'
                ]
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: true,
            cutout: '60%',
            plugins: {
                legend: {
                    position: 'bottom',
                    labels: {
                        color: '#333',
                        padding: 15
                    }
                },
                tooltip: {
                    backgroundColor: 'rgba(0, 0, 0, 0.8)',
                    titleColor: '#fff',
                    bodyColor: '#fff',
                    borderColor: '#4a90e2',
                    borderWidth: 1,
                    callbacks: {
                        label: function(context) {
                            const label = context.label || '';
                            const value = context.parsed || 0;
                            const total = context.dataset.data.reduce((a, b) => a + b, 0);
                            const percentage = total !== 0 ? ((value / total) * 100).toFixed(2) : 0;
                            return label + ': ' + 
                                   value.toLocaleString('zh-CN', { minimumFractionDigits: 2, maximumFractionDigits: 2 }) + 
                                   'ä¸‡å…ƒ (' + percentage + '%)';
                        }
                    }
                }
            }
        }
    });
}

// å­˜å‚¨äº§å“å½’å› æ•°æ®ï¼ˆç”¨äºæŒ‰é’®ç‚¹å‡»æ—¶è·å–ï¼‰
let productAttributionDataMap = {};

// æ›´æ–°äº§å“è¡¨æ ¼æ•°æ®
function updateFXProductTableData(labels, data, total, productMap = {}) {
    if (!fxElements.productTableBody) return;
    
    fxElements.productTableBody.innerHTML = '';
    
    if (labels.length === 0) {
        fxElements.productTableBody.innerHTML = '<tr><td colspan="4" class="empty-state">æš‚æ— æ•°æ®</td></tr>';
        return;
    }
    
    // ä¿å­˜äº§å“æ•°æ®åˆ°å…¨å±€æ˜ å°„
    productAttributionDataMap = {};
    Object.keys(productMap).forEach(key => {
        productAttributionDataMap[key] = productMap[key];
    });
    
    // åˆ›å»ºæ•°æ®æ•°ç»„å¹¶æ’åº
    const tableData = labels.map((label, index) => ({
        label,
        value: data[index],
        percentage: total !== 0 ? (data[index] / total * 100).toFixed(2) : '0.00',
        productData: productMap[label] || null
    })).sort((a, b) => Math.abs(b.value) - Math.abs(a.value));
    
    // ç”Ÿæˆè¡¨æ ¼è¡Œ
    tableData.forEach(item => {
        const row = document.createElement('tr');
        const hasAttributionData = item.productData && item.productData.factors && Object.keys(item.productData.factors).length > 0;
        row.innerHTML = `
            <td>${item.label}</td>
            <td class="${getNumberClass(item.value)}">${formatNumber(item.value)}</td>
            <td>${item.percentage}%</td>
            <td>
                ${hasAttributionData ? `<button class="btn btn-small btn-primary" onclick='showFXProductAttribution("${item.label.replace(/"/g, '&quot;')}")'>æŸ¥çœ‹å½’å› è´¡çŒ®</button>` : '<span style="color: #999;">--</span>'}
            </td>
        `;
        fxElements.productTableBody.appendChild(row);
    });
}

// æ›´æ–°è´§å¸å¯¹ç»´åº¦è¡¨æ ¼
function updateFXCurrencyPairTable(details) {
    if (!fxElements.currencyPairTableBody) return;
    
    fxElements.currencyPairTableBody.innerHTML = '';
    
    if (!details || details.length === 0) {
        fxElements.currencyPairTableBody.innerHTML = '<tr><td colspan="15" class="empty-state">æš‚æ— æ•°æ®</td></tr>';
        return;
    }
    
    details.forEach(detail => {
        const row = createFXTableRow(detail, 'currency_pair');
        fxElements.currencyPairTableBody.appendChild(row);
    });
}

// åˆ›å»ºå½’å› æ˜ç»†è¡¨æ ¼è¡Œï¼ˆTab1ï¼šåŒ…å«æ€»æ•å£ï¼‰
function createFXAttributionTableRow(detail) {
    const row = document.createElement('tr');
    
    // è·å–å› å­æ˜ å°„ï¼ˆå¤„ç†factorså¯èƒ½æ˜¯æ•°ç»„æˆ–å¯¹è±¡çš„æƒ…å†µï¼‰
    const factorsMap = {};
    if (Array.isArray(detail.factors)) {
        detail.factors.forEach(factor => {
            factorsMap[factor.factor_code] = factor;
        });
    } else if (detail.factors && typeof detail.factors === 'object') {
        Object.values(detail.factors).forEach(factor => {
            if (factor && factor.factor_code) {
                factorsMap[factor.factor_code] = factor;
            }
        });
    }
    
    // å› å­ä»£ç æ˜ å°„ - è°ƒæ•´ä¸ºæ–°çš„å› å­åˆ—è¡¨
    const factorCodes = ['delta', 'gamma', 'vega', 'theta', 'rho', 'phi', 'volga', 'vanna'];
    
    const dimensionValue = detail.dimension_value || '';
    const totalExposure = detail.total_exposure || 0;
    
    row.innerHTML = `
        <td>${dimensionValue}</td>
        <td class="${getNumberClass(totalExposure)}">${formatNumber(totalExposure)}</td>
        <td class="${getNumberClass(detail.valuation_pnl)}">${formatNumber(detail.valuation_pnl)}</td>
        ${factorCodes.map(code => {
            const factor = factorsMap[code];
            const value = factor ? factor.pnl_contribution : 0;
            return `<td class="${getNumberClass(value)}">${formatNumber(value)}</td>`;
        }).join('')}
        <td class="${getNumberClass(detail.unexplained)}">${formatNumber(detail.unexplained)}</td>
        <td>
            <div style="display: flex; gap: 8px; justify-content: center;">
                <button class="btn btn-small btn-secondary" onclick='fxDrilldown.showDrilldown("${dimensionValue.replace(/"/g, '&quot;')}", "portfolio")'>
                    æŸ¥çœ‹æ˜ç»†
                </button>
                <button class="btn btn-small btn-primary" onclick='fxTrendChart.showTrendChart("${dimensionValue.replace(/"/g, '&quot;')}", "portfolio")'>
                    æŸ¥çœ‹è¶‹åŠ¿å›¾
                </button>
            </div>
        </td>
    `;
    
    return row;
}

// åˆ›å»ºæ•æ„Ÿå€¼è¡¨æ ¼è¡Œï¼ˆTab2ï¼šæ˜¾ç¤ºæ•æ„Ÿå€¼å’Œæ€»æ•å£ã€æ“ä½œåˆ—ï¼‰
function createFXSensitivityTableRow(detail) {
    const row = document.createElement('tr');
    
    // è·å–å› å­æ˜ å°„ï¼ˆå¤„ç†factorså¯èƒ½æ˜¯æ•°ç»„æˆ–å¯¹è±¡çš„æƒ…å†µï¼‰
    const factorsMap = {};
    if (Array.isArray(detail.factors)) {
        detail.factors.forEach(factor => {
            factorsMap[factor.factor_code] = factor;
        });
    } else if (detail.factors && typeof detail.factors === 'object') {
        Object.values(detail.factors).forEach(factor => {
            if (factor && factor.factor_code) {
                factorsMap[factor.factor_code] = factor;
            }
        });
    }
    
    // å› å­ä»£ç æ˜ å°„ - è°ƒæ•´ä¸ºæ–°çš„å› å­åˆ—è¡¨
    const factorCodes = ['delta', 'gamma', 'vega', 'theta', 'rho', 'phi', 'volga', 'vanna'];
    
    const dimensionValue = detail.dimension_value || '';
    const totalExposure = detail.total_exposure || 0;
    
    row.innerHTML = `
        <td>${dimensionValue}</td>
        <td class="${getNumberClass(totalExposure)}">${formatNumber(totalExposure)}</td>
        ${factorCodes.map(code => {
            const factor = factorsMap[code];
            const value = factor ? factor.pnl_contribution : 0;
            return `<td class="${getNumberClass(value)}">${formatNumber(value)}</td>`;
        }).join('')}
        <td>
            <div style="display: flex; gap: 8px; justify-content: center;">
                <button class="btn btn-small btn-secondary" onclick='fxDrilldown.showDrilldown("${dimensionValue.replace(/"/g, '&quot;')}", "portfolio")'>
                    äº¤æ˜“æ˜ç»†
                </button>
                <button class="btn btn-small btn-primary" onclick='fxContribution.showContribution("${dimensionValue.replace(/"/g, '&quot;')}")'>
                    è´¡çŒ®åº¦
                </button>
            </div>
        </td>
    `;
    
    // ä¿å­˜è¯¦ç»†æ•°æ®åˆ°è¡Œå…ƒç´ ï¼Œç”¨äºè´¡çŒ®åº¦æŸ¥çœ‹
    row._detailData = detail;
    
    return row;
}

// åˆ›å»ºè¡¨æ ¼è¡Œï¼ˆé€šç”¨å‡½æ•°ï¼‰
function createFXTableRow(detail, dimensionType) {
    const row = document.createElement('tr');
    
    // è·å–å› å­æ˜ å°„ï¼ˆå¤„ç†factorså¯èƒ½æ˜¯æ•°ç»„æˆ–å¯¹è±¡çš„æƒ…å†µï¼‰
    const factorsMap = {};
    if (Array.isArray(detail.factors)) {
        detail.factors.forEach(factor => {
            factorsMap[factor.factor_code] = factor;
        });
    } else if (detail.factors && typeof detail.factors === 'object') {
        Object.values(detail.factors).forEach(factor => {
            if (factor && factor.factor_code) {
                factorsMap[factor.factor_code] = factor;
            }
        });
    }
    
    // å› å­ä»£ç æ˜ å°„ - è°ƒæ•´ä¸ºæ–°çš„å› å­åˆ—è¡¨
    const factorCodes = ['delta', 'gamma', 'vega', 'theta', 'rho', 'phi', 'volga', 'vanna'];
    
    const dimensionValue = detail.dimension_value || '';
    
    row.innerHTML = `
        <td>${dimensionValue}</td>
        <td class="${getNumberClass(detail.valuation_pnl)}">${formatNumber(detail.valuation_pnl)}</td>
        ${factorCodes.map(code => {
            const factor = factorsMap[code];
            const value = factor ? factor.pnl_contribution : 0;
            return `<td class="${getNumberClass(value)}">${formatNumber(value)}</td>`;
        }).join('')}
        <td class="${getNumberClass(detail.unexplained)}">${formatNumber(detail.unexplained)}</td>
        <td>
            <div style="display: flex; gap: 8px; justify-content: center;">
                <button class="btn btn-small btn-secondary" onclick='fxDrilldown.showDrilldown("${dimensionValue.replace(/"/g, '&quot;')}", "${dimensionType}")'>
                    æŸ¥çœ‹æ˜ç»†
                </button>
                ${dimensionType === 'currency_pair' 
                    ? `<button class="btn btn-small btn-primary" onclick='fxContribution.showContribution("${dimensionValue.replace(/"/g, '&quot;')}", "currency_pair")'>è´¡çŒ®åº¦</button>`
                    : `<button class="btn btn-small btn-primary" onclick='fxTrendChart.showTrendChart("${dimensionValue.replace(/"/g, '&quot;')}", "${dimensionType}")'>æŸ¥çœ‹è¶‹åŠ¿å›¾</button>`
                }
            </div>
        </td>
    `;
    
    return row;
}

// æ›´æ–°è­¦å‘Š
function updateFXWarnings(warnings) {
    if (!fxElements.warningsSection || !fxElements.warningsList) return;
    
    if (warnings.length === 0) {
        fxElements.warningsSection.style.display = 'none';
        return;
    }
    
    fxElements.warningsSection.style.display = 'block';
    fxElements.warningsList.innerHTML = '';
    
    warnings.forEach(warning => {
        const li = document.createElement('li');
        li.textContent = `${warning.date || ''}: ${warning.suggested_action || warning.message || 'æ•°æ®è­¦å‘Š'}`;
        fxElements.warningsList.appendChild(li);
    });
}

// å¤„ç†é‡ç½®
function handleFXReset() {
    // è®¾ç½®é»˜è®¤æ—¥æœŸ
    fxElements.startDate.value = '2025-11-01';
    fxElements.endDate.value = new Date().toISOString().split('T')[0];
    
    // æ¸…ç©ºå•é€‰ä¸‹æ‹‰æ¡†
    if (fxElements.portfolioSelect) {
        fxElements.portfolioSelect.value = '';
    }
    if (fxElements.productSelect) {
        fxElements.productSelect.value = '';
    }
    if (fxElements.currencyPairSelect) {
        fxElements.currencyPairSelect.value = '';
    }
    
    
    // æ¸…ç©ºæ˜¾ç¤º
    if (fxElements.valuationPnl) {
        fxElements.valuationPnl.textContent = '--';
        fxElements.valuationPnl.className = 'metric-value';
    }
    
    // æ¸…ç©ºè­¦å‘Š
    if (fxElements.warningsSection) {
        fxElements.warningsSection.style.display = 'none';
    }
    if (fxElements.warningsList) {
        fxElements.warningsList.innerHTML = '';
    }
    
    // æ¸…ç©ºè¡¨æ ¼
    if (fxElements.portfolioTableBody) {
        fxElements.portfolioTableBody.innerHTML = '<tr><td colspan="15" class="empty-state">è¯·ç‚¹å‡»æŸ¥è¯¢æŒ‰é’®åŠ è½½æ•°æ®</td></tr>';
    }
    if (fxElements.productTableBody) {
        fxElements.productTableBody.innerHTML = '<tr><td colspan="15" class="empty-state">è¯·ç‚¹å‡»æŸ¥è¯¢æŒ‰é’®åŠ è½½æ•°æ®</td></tr>';
    }
    if (fxElements.currencyPairTableBody) {
        fxElements.currencyPairTableBody.innerHTML = '<tr><td colspan="15" class="empty-state">è¯·ç‚¹å‡»æŸ¥è¯¢æŒ‰é’®åŠ è½½æ•°æ®</td></tr>';
    }
    
    // æ¸…ç©ºçŠ¶æ€
    fxState.currentData = null;
    fxState.trendData = null;
    fxState.fxData = {
        portfolio: null,
        product: null,
        currencyPair: null
    };
    
    // æ¸…ç©ºå›¾è¡¨
    if (typeof clearFXCharts === 'function') {
        clearFXCharts();
    }
}

// å¤„ç†å¯¼å‡ºï¼ˆå·²ç§»é™¤ï¼Œå¯¼å‡ºæŒ‰é’®å·²ç§»é™¤ï¼‰
// async function handleFXExport() { ... }

// è¶‹åŠ¿å›¾åˆ‡æ¢åŠŸèƒ½å·²ç§»é™¤ï¼Œè¶‹åŠ¿å›¾ç›´æ¥æ˜¾ç¤º

// æ˜¾ç¤ºé”™è¯¯
function showFXError(message) {
    alert(message);
}

// æ ¼å¼åŒ–æ•°å­—
function formatNumber(value) {
    if (value === null || value === undefined) return '--';
    return Number(value).toLocaleString('zh-CN', {
        minimumFractionDigits: 2,
        maximumFractionDigits: 2
    });
}

// è·å–æ•°å­—æ ·å¼ç±»
function getNumberClass(value) {
    if (value === null || value === undefined) return '';
    const num = Number(value);
    if (num > 0) return 'positive';
    if (num < 0) return 'negative';
    return 'neutral';
}

// å°†fxStateå’ŒfxElementsæš´éœ²åˆ°å…¨å±€
// æ˜¾ç¤ºäº§å“å½’å› è´¡çŒ®
function showFXProductAttribution(productName) {
    const modal = document.getElementById('fxProductAttributionModal');
    if (!modal) {
        console.error('Product attribution modal not found');
        return;
    }
    
    // æ˜¾ç¤ºäº§å“åç§°
    const productNameElement = document.getElementById('fxProductAttributionProductName');
    if (productNameElement) {
        productNameElement.textContent = `äº§å“ï¼š${productName}`;
    }
    
    // ä»å…¨å±€æ˜ å°„ä¸­è·å–äº§å“æ•°æ®
    const productData = productAttributionDataMap[productName];
    
    // æ˜¾ç¤ºæ¨¡æ€æ¡†
    modal.style.display = 'block';
    
    // æ›´æ–°å½’å› è´¡çŒ®è¡¨æ ¼
    const tbody = document.getElementById('fxProductAttributionBody');
    if (!tbody) return;
    
    tbody.innerHTML = '';
    
    if (!productData || !productData.factors || Object.keys(productData.factors).length === 0) {
        tbody.innerHTML = '<tr><td colspan="3" class="empty-state">æš‚æ— å½’å› æ•°æ®</td></tr>';
        bindProductAttributionModalEvents();
        return;
    }
    
    // è·å–å› å­æ•°æ®
    const factors = Object.values(productData.factors);
    const unexplained = productData.unexplained || 0;
    const totalValuationPnl = productData.valuation_pnl || 0;
    
    // å› å­åç§°æ˜ å°„
    const factorNameMap = {
        'delta': 'Delta',
        'gamma': 'Gamma',
        'vega': 'Vega',
        'theta': 'Theta',
        'rho': 'Rho',
        'phi': 'Phi',
        'volga': 'Volga',
        'vanna': 'Vanna'
    };
    
    // åˆ›å»ºæ•°æ®æ•°ç»„
    const attributionData = factors.map(factor => ({
        name: factorNameMap[factor.factor_code] || factor.factor_name || factor.factor_code,
        value: factor.pnl_contribution || 0
    }));
    
    // æ·»åŠ æ— æ³•è§£é‡Šéƒ¨åˆ†
    if (unexplained !== 0) {
        attributionData.push({
            name: 'æ— æ³•è§£é‡Šéƒ¨åˆ†',
            value: unexplained
        });
    }
    
    // æŒ‰ç»å¯¹å€¼æ’åº
    attributionData.sort((a, b) => Math.abs(b.value) - Math.abs(a.value));
    
    // ç”Ÿæˆè¡¨æ ¼è¡Œ
    attributionData.forEach(item => {
        const row = document.createElement('tr');
        const percentage = totalValuationPnl !== 0 ? ((item.value / totalValuationPnl) * 100).toFixed(2) : '0.00';
        row.innerHTML = `
            <td>${item.name}</td>
            <td class="text-right ${item.value > 0 ? 'positive' : item.value < 0 ? 'negative' : ''}">${formatNumber(item.value)}</td>
            <td class="text-right">${percentage}%</td>
        `;
        tbody.appendChild(row);
    });
    
    // ç»‘å®šå…³é—­äº‹ä»¶
    bindProductAttributionModalEvents();
}

// ç»‘å®šäº§å“å½’å› è´¡çŒ®æ¨¡æ€æ¡†äº‹ä»¶
function bindProductAttributionModalEvents() {
    const modal = document.getElementById('fxProductAttributionModal');
    if (!modal) return;
    
    // å…³é—­æŒ‰é’®
    const closeBtn = document.getElementById('fxProductAttributionModalClose');
    if (closeBtn) {
        closeBtn.onclick = () => {
            modal.style.display = 'none';
        };
    }
    
    // ç‚¹å‡»å¤–éƒ¨å…³é—­
    const originalOnClick = window.onclick;
    window.onclick = (event) => {
        if (event.target === modal) {
            modal.style.display = 'none';
        }
        // è°ƒç”¨åŸå§‹onclickï¼ˆå¦‚æœå­˜åœ¨ï¼‰
        if (originalOnClick && typeof originalOnClick === 'function') {
            originalOnClick(event);
        }
    };
}

window.fxState = fxState;
window.fxElements = fxElements;
window.showFXProductAttribution = showFXProductAttribution;

// é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
document.addEventListener('DOMContentLoaded', () => {
    // æ£€æŸ¥æ˜¯å¦åœ¨å¤–æ±‡ç•Œé¢
    const fxView = document.getElementById('fxPnlView');
    if (fxView) {
        // å»¶è¿Ÿåˆå§‹åŒ–ï¼Œç¡®ä¿DOMå·²åŠ è½½
        setTimeout(() => {
            initFXAttribution();
        }, 100);
    }
});

// å½“åˆ‡æ¢åˆ°å¤–æ±‡ç•Œé¢æ—¶åˆå§‹åŒ–
const originalHandleSidebarItemClick = window.handleSidebarItemClick;
if (originalHandleSidebarItemClick) {
    window.handleSidebarItemClick = function(event) {
        originalHandleSidebarItemClick(event);
        
        // å¦‚æœåˆ‡æ¢åˆ°å¤–æ±‡ç•Œé¢ï¼Œåˆå§‹åŒ–
        const clickedItem = event.currentTarget;
        if (clickedItem.id === 'fxPnlMenuItem') {
            setTimeout(() => {
                if (!fxState.portfolios || fxState.portfolios.length === 0) {
                    initFXAttribution();
                }
            }, 100);
        }
    };
}


    </script>
    <script>
/**
 * å¤–æ±‡ç±»æŸç›Šå½’å› åˆ†æå›¾è¡¨æ¸²æŸ“æ¨¡å—
 */

const fxCharts = {
    trendChartInstance: null,
    barChartInstance: null,
    pieChartInstance: null,

    /**
     * åˆå§‹åŒ–æ‰€æœ‰å›¾è¡¨
     */
    initCharts() {
        this.initTrendChart();
        // æŸ±çŠ¶å›¾å’Œé¥¼å›¾å·²ç§»é™¤
    },

    /**
     * åˆå§‹åŒ–è¶‹åŠ¿å›¾
     */
    initTrendChart() {
        const ctx = document.getElementById('fxTrendChart');
        if (!ctx) return;

        this.trendChartInstance = new Chart(ctx, {
            type: 'line',
            data: {
                labels: [],
                datasets: []
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        labels: {
                            color: '#333'
                        }
                    },
                    tooltip: {
                        backgroundColor: 'rgba(0, 0, 0, 0.8)',
                        titleColor: '#fff',
                        bodyColor: '#fff',
                        borderColor: '#4a90e2',
                        borderWidth: 1
                    }
                },
                scales: {
                    x: {
                        ticks: {
                            color: '#666'
                        },
                        grid: {
                            color: 'rgba(0, 0, 0, 0.1)'
                        }
                    },
                    y: {
                        ticks: {
                            color: '#666',
                            callback: function(value) {
                                return value.toLocaleString('zh-CN', { minimumFractionDigits: 2, maximumFractionDigits: 2 }) + 'ä¸‡å…ƒ';
                            }
                        },
                        grid: {
                            color: 'rgba(0, 0, 0, 0.1)'
                        }
                    }
                }
            }
        });
    },

    /**
     * åˆå§‹åŒ–æŸ±çŠ¶å›¾
     */
    initBarChart() {
        const ctx = document.getElementById('fxBarChart');
        if (!ctx) return;

        this.barChartInstance = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: [],
                datasets: []
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        labels: {
                            color: '#d0d0d0'
                        }
                    },
                    tooltip: {
                        backgroundColor: 'rgba(0, 0, 0, 0.8)',
                        titleColor: '#fff',
                        bodyColor: '#fff',
                        borderColor: '#4a90e2',
                        borderWidth: 1,
                        callbacks: {
                            label: function(context) {
                                return context.dataset.label + ': ' + 
                                       context.parsed.y.toLocaleString('zh-CN', { minimumFractionDigits: 2, maximumFractionDigits: 2 }) + 'ä¸‡å…ƒ';
                            }
                        }
                    }
                },
                scales: {
                    x: {
                        ticks: {
                            color: '#808080'
                        },
                        grid: {
                            color: 'rgba(128, 128, 128, 0.2)'
                        }
                    },
                    y: {
                        ticks: {
                            color: '#808080',
                            callback: function(value) {
                                return value.toLocaleString('zh-CN', { minimumFractionDigits: 2, maximumFractionDigits: 2 }) + 'ä¸‡å…ƒ';
                            }
                        },
                        grid: {
                            color: 'rgba(128, 128, 128, 0.2)'
                        }
                    }
                }
            }
        });
    },

    /**
     * åˆå§‹åŒ–é¥¼å›¾
     */
    initPieChart() {
        const ctx = document.getElementById('fxPieChart');
        if (!ctx) return;

        this.pieChartInstance = new Chart(ctx, {
            type: 'pie',
            data: {
                labels: [],
                datasets: [{
                    data: [],
                    backgroundColor: [
                        '#4a90e2',
                        '#50c878',
                        '#ff6b6b',
                        '#ffd93d',
                        '#6c5ce7',
                        '#00d9ff',
                        '#1e9fff',
                        '#5a67d8',
                        '#ff8787',
                        '#a8e6cf',
                        '#ffd89b',
                        '#f093fb'
                    ]
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'right',
                        labels: {
                            color: '#d0d0d0',
                            padding: 15
                        }
                    },
                    tooltip: {
                        backgroundColor: 'rgba(0, 0, 0, 0.8)',
                        titleColor: '#fff',
                        bodyColor: '#fff',
                        borderColor: '#4a90e2',
                        borderWidth: 1,
                        callbacks: {
                            label: function(context) {
                                const label = context.label || '';
                                const value = context.parsed || 0;
                                const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                const percentage = total !== 0 ? ((value / total) * 100).toFixed(2) : 0;
                                return label + ': ' + 
                                       value.toLocaleString('zh-CN', { minimumFractionDigits: 2, maximumFractionDigits: 2 }) + 
                                       'ä¸‡å…ƒ (' + percentage + '%)';
                            }
                        }
                    }
                }
            }
        });
    },

    /**
     * æ›´æ–°è¶‹åŠ¿å›¾
     */
    updateTrendChart(trendData) {
        if (!this.trendChartInstance || !trendData || trendData.length === 0) return;

        // æå–æ—¥æœŸæ ‡ç­¾ï¼ˆXè½´ï¼‰- æ ¼å¼åŒ–ä¸º MM/DD
        const labels = trendData.map(item => {
            const date = new Date(item.date);
            return `${date.getMonth() + 1}/${date.getDate()}`;
        });

        // æå–ç´¯è®¡ä¼°å€¼æŸç›Šæ•°æ®ï¼ˆYè½´ï¼‰
        const data = trendData.map(item => item.valuation_pnl || 0);

        // åˆ›å»ºå•ä¸€æ•°æ®é›†ï¼ˆç´¯è®¡ä¼°å€¼æŸç›Šï¼‰
        this.trendChartInstance.data.labels = labels;
        this.trendChartInstance.data.datasets = [{
            label: 'ç´¯è®¡ä¼°å€¼æŸç›Š',
            data: data,
            borderColor: '#4a90e2',
            backgroundColor: 'rgba(74, 144, 226, 0.1)',
            tension: 0.4,
            fill: true,
            pointRadius: 3,
            pointHoverRadius: 5
        }];
        
        this.trendChartInstance.update();
    },

    /**
     * æ›´æ–°å›¾è¡¨ï¼ˆæŸ±çŠ¶å›¾å’Œé¥¼å›¾å·²ç§»é™¤ï¼‰
     */
    updateCharts(data) {
        // æŸ±çŠ¶å›¾å’Œé¥¼å›¾å·²ç§»é™¤ï¼Œåªä¿ç•™è¶‹åŠ¿å›¾
    },

    /**
     * æ›´æ–°æŸ±çŠ¶å›¾
     */
    updateBarChart(details) {
        if (!this.barChartInstance) return;

        // å› å­ä»£ç å’Œåç§°æ˜ å°„
        const factorMap = {
            'delta': 'DeltaæŸç›Š',
            'vega': 'VegaæŸç›Š',
            'gamma': 'GammaæŸç›Š',
            'theta': 'ThetaæŸç›Š',
            'rho': 'RhoæŸç›Š',
            'vanna': 'VannaæŸç›Š',
            'charm': 'CharmæŸç›Š',
            'veta': 'VetaæŸç›Š',
            'vomma': 'VommaæŸç›Š',
            'speed': 'SpeedæŸç›Š',
            'theta_decay': 'ThetaDecayæŸç›Š',
            'unexplained': 'æ— æ³•è§£é‡Šéƒ¨åˆ†'
        };

        const factorCodes = Object.keys(factorMap);
        const labels = details.map(d => d.dimension_value || 'æ€»è®¡');
        
        // è®¡ç®—æ¯ä¸ªå› å­çš„æ€»å’Œ
        const factorTotals = {};
        factorCodes.forEach(code => {
            factorTotals[code] = 0;
        });

        details.forEach(detail => {
            const factorsMap = {};
            (detail.factors || []).forEach(factor => {
                factorsMap[factor.factor_code] = factor;
            });

            factorCodes.forEach(code => {
                const factor = factorsMap[code];
                const value = factor ? factor.pnl_contribution : (code === 'unexplained' ? detail.unexplained || 0 : 0);
                factorTotals[code] += value;
            });
        });

        // åˆ›å»ºæ•°æ®é›†ï¼ˆåªæ˜¾ç¤ºæœ‰å€¼çš„å› å­ï¼‰
        const datasets = [];
        const colors = ['#4a90e2', '#50c878', '#ff6b6b', '#ffd93d', '#6c5ce7', 
                       '#00d9ff', '#1e9fff', '#5a67d8', '#ff8787', '#a8e6cf', 
                       '#ffd89b', '#f093fb', '#95a5a6'];

        let colorIndex = 0;
        factorCodes.forEach(code => {
            if (Math.abs(factorTotals[code]) > 0.01) { // åªæ˜¾ç¤ºæœ‰å€¼çš„å› å­
                const data = details.map(detail => {
                    const factorsMap = {};
                    (detail.factors || []).forEach(factor => {
                        factorsMap[factor.factor_code] = factor;
                    });
                    const factor = factorsMap[code];
                    return factor ? factor.pnl_contribution : (code === 'unexplained' ? detail.unexplained || 0 : 0);
                });

                datasets.push({
                    label: factorMap[code],
                    data: data,
                    backgroundColor: colors[colorIndex % colors.length],
                    borderColor: colors[colorIndex % colors.length],
                    borderWidth: 1
                });
                colorIndex++;
            }
        });

        this.barChartInstance.data.labels = labels;
        this.barChartInstance.data.datasets = datasets;
        this.barChartInstance.update();
    },

    /**
     * æ›´æ–°é¥¼å›¾
     */
    updatePieChart(details) {
        if (!this.pieChartInstance) return;

        // å› å­ä»£ç å’Œåç§°æ˜ å°„
        const factorMap = {
            'delta': 'DeltaæŸç›Š',
            'vega': 'VegaæŸç›Š',
            'gamma': 'GammaæŸç›Š',
            'theta': 'ThetaæŸç›Š',
            'rho': 'RhoæŸç›Š',
            'vanna': 'VannaæŸç›Š',
            'charm': 'CharmæŸç›Š',
            'veta': 'VetaæŸç›Š',
            'vomma': 'VommaæŸç›Š',
            'speed': 'SpeedæŸç›Š',
            'theta_decay': 'ThetaDecayæŸç›Š',
            'unexplained': 'æ— æ³•è§£é‡Šéƒ¨åˆ†'
        };

        const factorCodes = Object.keys(factorMap);
        const factorTotals = {};
        
        factorCodes.forEach(code => {
            factorTotals[code] = 0;
        });

        // æ±‡æ€»æ‰€æœ‰æ˜ç»†çš„å› å­è´¡çŒ®
        details.forEach(detail => {
            const factorsMap = {};
            (detail.factors || []).forEach(factor => {
                factorsMap[factor.factor_code] = factor;
            });

            factorCodes.forEach(code => {
                const factor = factorsMap[code];
                const value = factor ? factor.pnl_contribution : (code === 'unexplained' ? detail.unexplained || 0 : 0);
                factorTotals[code] += value;
            });
        });

        // è¿‡æ»¤æ‰å€¼ä¸º0çš„å› å­
        const labels = [];
        const data = [];
        const colors = ['#4a90e2', '#50c878', '#ff6b6b', '#ffd93d', '#6c5ce7', 
                       '#00d9ff', '#1e9fff', '#5a67d8', '#ff8787', '#a8e6cf', 
                       '#ffd89b', '#f093fb', '#95a5a6'];

        let colorIndex = 0;
        factorCodes.forEach(code => {
            const value = factorTotals[code];
            if (Math.abs(value) > 0.01) { // åªæ˜¾ç¤ºæœ‰å€¼çš„å› å­
                labels.push(factorMap[code]);
                data.push(value);
                colorIndex++;
            }
        });

        this.pieChartInstance.data.labels = labels;
        this.pieChartInstance.data.datasets[0].data = data;
        this.pieChartInstance.data.datasets[0].backgroundColor = colors.slice(0, labels.length);
        this.pieChartInstance.update();
    },

    /**
     * æ¸…ç©ºå›¾è¡¨
     */
    clearCharts() {
        if (this.trendChartInstance) {
            this.trendChartInstance.data.labels = [];
            this.trendChartInstance.data.datasets = [];
            this.trendChartInstance.update();
        }

        // æŸ±çŠ¶å›¾å’Œé¥¼å›¾å·²ç§»é™¤
    }
};

// å°†fxChartsæš´éœ²åˆ°å…¨å±€
window.fxCharts = fxCharts;

// é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–å›¾è¡¨
document.addEventListener('DOMContentLoaded', () => {
    setTimeout(() => {
        fxCharts.initCharts();
    }, 500);
});


    </script>
    <script>
/**
 * å¤–æ±‡ç±»æŸç›Šå½’å› åˆ†æå¯¼å‡ºåŠŸèƒ½æ¨¡å—
 */

const fxExport = {
    /**
     * å¯¼å‡ºä¸ºCSVæ ¼å¼
     */
    exportToCSV(data, filename = 'fx_attribution_export.csv') {
        if (!data || !data.details) {
            alert('æ²¡æœ‰å¯å¯¼å‡ºçš„æ•°æ®');
            return;
        }

        const details = data.details;
        
        // CSVå¤´éƒ¨
        const headers = [
            'ç»´åº¦',
            'ä¼°å€¼æŸç›Š',
            'DeltaæŸç›Š',
            'VegaæŸç›Š',
            'GammaæŸç›Š',
            'ThetaæŸç›Š',
            'RhoæŸç›Š',
            'VannaæŸç›Š',
            'CharmæŸç›Š',
            'VetaæŸç›Š',
            'VommaæŸç›Š',
            'SpeedæŸç›Š',
            'ThetaDecayæŸç›Š',
            'æ— æ³•è§£é‡Šéƒ¨åˆ†'
        ];
        
        let csv = '\uFEFF'; // BOM for UTF-8
        csv += headers.join(',') + '\n';
        
        // å› å­ä»£ç æ˜ å°„
        const factorCodes = ['delta', 'vega', 'gamma', 'theta', 'rho', 'vanna', 
                           'charm', 'veta', 'vomma', 'speed', 'theta_decay'];
        
        // æ•°æ®è¡Œ
        details.forEach(detail => {
            // è·å–å› å­æ˜ å°„
            const factorsMap = {};
            (detail.factors || []).forEach(factor => {
                factorsMap[factor.factor_code] = factor;
            });
            
            const row = [
                detail.dimension_value || '',
                detail.valuation_pnl || 0,
                ...factorCodes.map(code => {
                    const factor = factorsMap[code];
                    return factor ? factor.pnl_contribution : 0;
                }),
                detail.unexplained || 0
            ];
            
            csv += row.join(',') + '\n';
        });
        
        // æ·»åŠ æ±‡æ€»è¡Œ
        const totalRow = [
            'æ€»è®¡',
            data.total_valuation_pnl || 0,
            ...factorCodes.map(code => {
                let total = 0;
                details.forEach(detail => {
                    const factorsMap = {};
                    (detail.factors || []).forEach(factor => {
                        factorsMap[factor.factor_code] = factor;
                    });
                    const factor = factorsMap[code];
                    if (factor) {
                        total += factor.pnl_contribution;
                    }
                });
                return total;
            }),
            details.reduce((sum, d) => sum + (d.unexplained || 0), 0)
        ];
        csv += totalRow.join(',') + '\n';
        
        // ä¸‹è½½æ–‡ä»¶
        const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement('a');
        const url = URL.createObjectURL(blob);
        
        link.setAttribute('href', url);
        link.setAttribute('download', filename);
        link.style.visibility = 'hidden';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    },

    /**
     * å¯¼å‡ºä¸ºExcelæ ¼å¼ï¼ˆé€šè¿‡APIï¼‰
     */
    async exportToExcel(params) {
        try {
            await api.exportFXExcel(params);
        } catch (error) {
            console.error('Excel export failed:', error);
            // å¦‚æœAPIå¤±è´¥ï¼Œé™çº§ä¸ºCSVå¯¼å‡º
            alert('Excelå¯¼å‡ºå¤±è´¥ï¼Œå·²æ”¹ä¸ºCSVæ ¼å¼å¯¼å‡º');
            // è¿™é‡Œå¯ä»¥è°ƒç”¨exportToCSVä½œä¸ºå¤‡é€‰æ–¹æ¡ˆ
        }
    }
};

// å°†fxExportæš´éœ²åˆ°å…¨å±€
window.fxExport = fxExport;


    </script>
    <script>
/**
 * å¤–æ±‡ç±»æŸç›Šå½’å› åˆ†æä¸‹é’»äº¤äº’æ¨¡å— - äº¤æ˜“æ˜ç»†
 */

const fxDrilldown = {
    currentDimensionValue: null,
    currentDimensionType: null,

    /**
     * æ˜¾ç¤ºäº¤æ˜“æ˜ç»†å¼¹çª—
     */
    async showDrilldown(dimensionValue, dimensionType, hasStartFactors, hasEndFactors) {
        this.currentDimensionValue = dimensionValue;
        this.currentDimensionType = dimensionType;
        
        // æ˜¾ç¤ºæ¨¡æ€æ¡†
        const modal = document.getElementById('fxDrilldownModal');
        if (!modal) {
            console.error('Transaction detail modal not found');
            return;
        }
        
        modal.style.display = 'block';
        
        // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
        const tbody = document.getElementById('fxTransactionDetailBody');
        if (tbody) {
            tbody.innerHTML = '<tr><td colspan="21" class="empty-state">åŠ è½½ä¸­...</td></tr>';
        }
        
        // ä»APIåŠ è½½äº¤æ˜“æ˜ç»†
        await this.loadTransactionDetails();
        
        // ç»‘å®šæ¨¡æ€æ¡†äº‹ä»¶
        this.bindModalEvents();
    },

    /**
     * ä»APIåŠ è½½äº¤æ˜“æ˜ç»†
     */
    async loadTransactionDetails() {
        try {
            // è·å–å½“å‰æŸ¥è¯¢å‚æ•°
            const fxElements = window.fxElements;
            if (!fxElements) return;
            
            const requestData = {
                start_date: fxElements.startDate.value,
                end_date: fxElements.endDate.value,
                dimension_type: this.currentDimensionType || 'portfolio',
                dimension_value: this.currentDimensionValue
            };
            
            const response = await api.getFXTransactionDetails(requestData);
            
            // æ›´æ–°äº¤æ˜“æ˜ç»†è¡¨æ ¼
            this.updateTransactionTable(response.transactions || []);
            
        } catch (error) {
            console.error('Failed to load transaction details:', error);
            const tbody = document.getElementById('fxTransactionDetailBody');
            if (tbody) {
                tbody.innerHTML = '<tr><td colspan="21" class="empty-state">åŠ è½½å¤±è´¥ï¼š' + (error.message || 'æœªçŸ¥é”™è¯¯') + '</td></tr>';
            }
        }
    },

    /**
     * æ›´æ–°äº¤æ˜“æ˜ç»†è¡¨æ ¼
     */
    updateTransactionTable(transactions) {
        const tbody = document.getElementById('fxTransactionDetailBody');
        if (!tbody) return;
        
        tbody.innerHTML = '';
        
        if (!transactions || transactions.length === 0) {
            const row = document.createElement('tr');
            row.innerHTML = '<td colspan="21" class="empty-state">æš‚æ— äº¤æ˜“æ•°æ®</td>';
            tbody.appendChild(row);
            return;
        }
        
        // æ¸²æŸ“äº¤æ˜“æ˜ç»†è¡Œ
        transactions.forEach(txn => {
            const row = document.createElement('tr');
            
            // æ ¹æ®ä¼°å€¼æŸç›Šçš„å€¼è®¾ç½®é¢œè‰²
            const pnlClass = txn.valuation_pnl > 0 ? 'positive' : txn.valuation_pnl < 0 ? 'negative' : '';
            
            // æ•æ„Ÿæ€§æŒ‡æ ‡åˆ—è¡¨
            const sensitivityFields = [
                { key: 'delta', value: txn.delta || 0 },
                { key: 'vega', value: txn.vega || 0 },
                { key: 'gamma', value: txn.gamma || 0 },
                { key: 'theta', value: txn.theta || 0 },
                { key: 'rho', value: txn.rho || 0 },
                { key: 'vanna', value: txn.vanna || 0 },
                { key: 'charm', value: txn.charm || 0 },
                { key: 'veta', value: txn.veta || 0 },
                { key: 'vomma', value: txn.vomma || 0 },
                { key: 'speed', value: txn.speed || 0 },
                { key: 'theta_decay', value: txn.theta_decay || 0 }
            ];
            
            // ç”Ÿæˆæ•æ„Ÿæ€§æŒ‡æ ‡å•å…ƒæ ¼
            const sensitivityCells = sensitivityFields.map(field => {
                const value = field.value || 0;
                const cellClass = this.getNumberClass(value);
                return `<td class="text-right ${cellClass}">${this.formatNumber(value)}</td>`;
            }).join('');
            
            row.innerHTML = `
                <td>${txn.transaction_id}</td>
                <td>${txn.trade_date}</td>
                <td>${txn.product_code}</td>
                <td>${txn.product_name}</td>
                <td>${txn.currency_pair}</td>
                <td>${txn.trade_direction}</td>
                <td class="text-right">${this.formatNumber(txn.notional_amount)}</td>
                <td class="text-right">${this.formatNumber(txn.price, 4)}</td>
                <td class="text-right ${pnlClass}">${this.formatNumber(txn.valuation_pnl)}</td>
                <td>${txn.portfolio_name}</td>
                ${sensitivityCells}
            `;
            tbody.appendChild(row);
        });
    },

    /**
     * ç»‘å®šæ¨¡æ€æ¡†äº‹ä»¶
     */
    bindModalEvents() {
        const modal = document.getElementById('fxDrilldownModal');
        if (!modal) return;
        
        // å…³é—­æŒ‰é’®
        const closeBtn = modal.querySelector('.modal-close');
        if (closeBtn) {
            closeBtn.onclick = () => {
                modal.style.display = 'none';
            };
        }
        
        // ç‚¹å‡»å¤–éƒ¨å…³é—­
        window.onclick = (event) => {
            if (event.target === modal) {
                modal.style.display = 'none';
            }
        };
    },

    /**
     * æ ¼å¼åŒ–æ•°å­—
     */
    formatNumber(value, decimals = 2) {
        if (value === null || value === undefined) return '--';
        return Number(value).toLocaleString('zh-CN', {
            minimumFractionDigits: decimals,
            maximumFractionDigits: decimals
        });
    },

    /**
     * è·å–æ•°å­—æ ·å¼ç±»
     */
    getNumberClass(value) {
        if (value > 0) return 'positive';
        if (value < 0) return 'negative';
        return '';
    }
};

// å°†fxDrilldownæš´éœ²åˆ°å…¨å±€
window.fxDrilldown = fxDrilldown;

    </script>
    <script>
/**
 * å¤–æ±‡ç±»æŸç›Šå½’å› åˆ†æ - å½’å› åˆ†é¡¹è¶‹åŠ¿å›¾æ¨¡å—
 */

const fxTrendChart = {
    chartInstance: null,
    currentDimensionValue: null,
    currentDimensionType: null,

    /**
     * æ˜¾ç¤ºè¶‹åŠ¿å›¾å¼¹çª—
     */
    async showTrendChart(dimensionValue, dimensionType) {
        this.currentDimensionValue = dimensionValue;
        this.currentDimensionType = dimensionType;
        
        // æ˜¾ç¤ºæ¨¡æ€æ¡†
        const modal = document.getElementById('fxTrendChartModal');
        if (!modal) {
            console.error('Trend chart modal not found');
            return;
        }
        
        modal.style.display = 'block';
        
        // åˆå§‹åŒ–å›¾è¡¨ï¼ˆå¦‚æœè¿˜æœªåˆå§‹åŒ–ï¼‰
        if (!this.chartInstance) {
            this.initChart();
        }
        
        // åŠ è½½å¹¶æ˜¾ç¤ºè¶‹åŠ¿æ•°æ®
        await this.loadTrendData();
        
        // ç»‘å®šå…³é—­äº‹ä»¶
        this.bindModalEvents();
    },

    /**
     * åˆå§‹åŒ–è¶‹åŠ¿å›¾
     */
    initChart() {
        const ctx = document.getElementById('fxFactorTrendChart');
        if (!ctx) {
            console.error('Chart canvas element not found');
            return;
        }
        
        // æ£€æŸ¥Chart.jsæ˜¯å¦å·²åŠ è½½
        if (typeof Chart === 'undefined') {
            console.error('Chart.js library not loaded');
            alert('å›¾è¡¨åº“æœªåŠ è½½ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•');
            return;
        }
        
        // å¦‚æœå›¾è¡¨å®ä¾‹å·²å­˜åœ¨ï¼Œå…ˆé”€æ¯
        if (this.chartInstance) {
            try {
                this.chartInstance.destroy();
            } catch (e) {
                console.warn('Error destroying chart instance:', e);
            }
            this.chartInstance = null;
        }
        
        this.chartInstance = new Chart(ctx, {
            type: 'line',
            data: {
                labels: [],
                datasets: []
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: true,
                        position: 'top',
                        labels: {
                            color: '#333',
                            usePointStyle: true,
                            padding: 15,
                            font: {
                                size: 12
                            }
                        }
                    },
                    tooltip: {
                        backgroundColor: 'rgba(0, 0, 0, 0.8)',
                        titleColor: '#fff',
                        bodyColor: '#fff',
                        borderColor: '#4a90e2',
                        borderWidth: 1,
                        mode: 'index',
                        intersect: false
                    }
                },
                scales: {
                    x: {
                        title: {
                            display: true,
                            text: 'æ—¥æœŸ',
                            color: '#666'
                        },
                        ticks: {
                            color: '#666',
                            maxRotation: 45,
                            minRotation: 45
                        },
                        grid: {
                            color: 'rgba(0, 0, 0, 0.1)'
                        }
                    },
                    y: {
                        title: {
                            display: true,
                            text: 'é‡‘é¢ï¼ˆä¸‡å…ƒï¼‰',
                            color: '#666'
                        },
                        ticks: {
                            color: '#666',
                            callback: function(value) {
                                return value.toLocaleString('zh-CN', { 
                                    minimumFractionDigits: 2, 
                                    maximumFractionDigits: 2 
                                }) + 'ä¸‡å…ƒ';
                            }
                        },
                        grid: {
                            color: 'rgba(0, 0, 0, 0.1)'
                        }
                    }
                },
                interaction: {
                    mode: 'index',
                    intersect: false
                }
            }
        });
    },

    /**
     * åŠ è½½è¶‹åŠ¿æ•°æ®
     */
    async loadTrendData() {
        try {
            const fxElements = window.fxElements;
            if (!fxElements) {
                console.error('fxElements not found');
                return;
            }
            
            const startDate = fxElements.startDate.value;
            const endDate = fxElements.endDate.value;
            
            if (!startDate || !endDate) {
                alert('è¯·å…ˆé€‰æ‹©æ—¥æœŸèŒƒå›´');
                return;
            }
            
            // è·å–apiå¯¹è±¡
            const api = window.api;
            if (!api) {
                console.error('API object not found');
                alert('APIå¯¹è±¡æœªåˆå§‹åŒ–ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•');
                return;
            }
            
            // è°ƒç”¨APIè·å–æ¯ä¸ªå› å­çš„è¶‹åŠ¿æ•°æ®
            const requestData = {
                start_date: startDate,
                end_date: endDate,
                dimension_type: this.currentDimensionType,
                dimension_value: this.currentDimensionValue
            };
            
            console.log('Loading trend data with request:', requestData);
            
            const response = await api.getFXFactorTrend(requestData);
            
            console.log('Trend data response:', response);
            
            // è½¬æ¢æ•°æ®æ ¼å¼
            const trendData = this.processTrendData(response.trend_data || []);
            
            if (!trendData || trendData.datasets.length === 0) {
                alert('æš‚æ— è¶‹åŠ¿æ•°æ®');
                return;
            }
            
            this.updateChart(trendData);
            
        } catch (error) {
            console.error('Failed to load trend data:', error);
            alert('åŠ è½½è¶‹åŠ¿æ•°æ®å¤±è´¥ï¼š' + (error.message || 'æœªçŸ¥é”™è¯¯'));
        }
    },

    /**
     * å¤„ç†è¶‹åŠ¿æ•°æ®ï¼Œè½¬æ¢ä¸ºå›¾è¡¨æ ¼å¼
     */
    processTrendData(trendData) {
        if (!trendData || trendData.length === 0) {
            return { labels: [], datasets: [] };
        }
        
        // æå–æ—¥æœŸæ ‡ç­¾
        const labels = trendData.map(item => {
            const date = new Date(item.date);
            const month = date.getMonth() + 1;
            const day = date.getDate();
            return `${month}/${day}`;
        });
        
        // å› å­ä»£ç å’Œåç§°æ˜ å°„
        const factorCodes = ['delta', 'vega', 'gamma', 'theta', 'rho', 'vanna', 
                            'charm', 'veta', 'vomma', 'speed', 'theta_decay', 'unexplained'];
        const factorNames = ['Delta', 'Vega', 'Gamma', 'Theta', 'Rho', 'Vanna', 
                            'Charm', 'Veta', 'Vomma', 'Speed', 'ThetaDecay', 'æ— æ³•è§£é‡Šéƒ¨åˆ†'];
        
        const colors = [
            '#4a90e2', '#50c878', '#ff6b6b', '#ffd93d', '#6c5ce7', '#00d9ff',
            '#1e9fff', '#5a67d8', '#ff8787', '#a8e6cf', '#ffd89b', '#f093fb'
        ];
        
        // ä¸ºæ¯ä¸ªå› å­åˆ›å»ºæ•°æ®é›†
        const datasets = [];
        factorCodes.forEach((code, index) => {
            const data = trendData.map(item => {
                const factors = item.factors || {};
                return factors[code] || 0;
            });
            
            datasets.push({
                label: factorNames[index],
                data: data,
                borderColor: colors[index],
                backgroundColor: colors[index] + '33',
                tension: 0.4,
                fill: false,
                pointRadius: 2,
                pointHoverRadius: 4,
                borderWidth: 2
            });
        });
        
        return { labels, datasets };
    },

    /**
     * æ›´æ–°å›¾è¡¨
     */
    updateChart(trendData) {
        if (!this.chartInstance) {
            console.error('Chart instance not found, initializing...');
            this.initChart();
        }
        
        if (!trendData || !trendData.labels || !trendData.datasets) {
            console.error('Invalid trend data:', trendData);
            return;
        }
        
        if (!this.chartInstance) {
            console.error('Chart instance still not found after initialization');
            return;
        }
        
        try {
            this.chartInstance.data.labels = trendData.labels;
            this.chartInstance.data.datasets = trendData.datasets;
            this.chartInstance.update();
            console.log('Chart updated successfully');
        } catch (error) {
            console.error('Error updating chart:', error);
            alert('æ›´æ–°å›¾è¡¨å¤±è´¥ï¼š' + (error.message || 'æœªçŸ¥é”™è¯¯'));
        }
    },

    /**
     * ç»‘å®šæ¨¡æ€æ¡†äº‹ä»¶
     */
    bindModalEvents() {
        const modal = document.getElementById('fxTrendChartModal');
        if (!modal) return;
        
        // å…³é—­æŒ‰é’®
        const closeBtn = document.getElementById('fxTrendChartModalClose');
        if (closeBtn) {
            closeBtn.onclick = () => {
                modal.style.display = 'none';
            };
        }
        
        // ç‚¹å‡»å¤–éƒ¨å…³é—­
        window.onclick = (event) => {
            if (event.target === modal) {
                modal.style.display = 'none';
            }
        };
    }
};

// å°†fxTrendChartæš´éœ²åˆ°å…¨å±€
window.fxTrendChart = fxTrendChart;


    </script>
</body>
</html>
